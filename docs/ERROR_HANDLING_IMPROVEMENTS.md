# ุชุญุณููุงุช ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก ูู ุญุฐู ุงูููุงุชูุฑ

## ๐ฏ ุงููุฏู

ุชุญุณูู ุชุฌุฑุจุฉ ุงููุณุชุฎุฏู ุนูุฏ ูุญุงููุฉ ุญุฐู ููุงุชูุฑ ูุญููุฉ (ุชู ุฅูุดุงุคูุง ุชููุงุฆูุงู) ูู ุฎูุงู:
1. ุฑุณุงุฆู ุฎุทุฃ ูุงุถุญุฉ ููููุฏุฉ
2. ุฑููุฒ HTTP ุตุญูุญุฉ
3. ุฅุฑุดุงุฏุงุช ูููุณุชุฎุฏู ุญูู ูุงุฐุง ููุนู

---

## ๐ ุงููุดููุฉ ุงูุณุงุจูุฉ

### 1. ุฑููุฒ HTTP ุบูุฑ ุตุญูุญุฉ
```
โ ูุจู: 500 Internal Server Error
โ ุจุนุฏ: 403 Forbidden (ุฃูุซุฑ ุฏูุฉ)
```

### 2. ุฑุณุงุฆู ุฎุทุฃ ุบูุฑ ูุงุถุญุฉ
```
โ ูุจู: "ูุง ูููู ุญุฐู ูุฐู ุงููุงุชูุฑุฉ ูุจุงุดุฑุฉ"
โ ุจุนุฏ: ุฑุณุงูุฉ ููุตูุฉ ูุน ูุนูููุงุช ุงููุงุชูุฑุฉ ุงูุฃุตููุฉ
```

---

## โ ุงูุชุญุณููุงุช ุงููุทุจูุฉ

### 1. ุชุญุณูู ุฑุณุงุฆู ุงูุฎุทุฃ - ููุงุชูุฑ ุงููุจูุนุงุช

**ูุจู:**
```
"ูุง ูููู ุญุฐู ูุฐู ุงููุงุชูุฑุฉ ูุจุงุดุฑุฉ. 
ูุฌุจ ุญุฐู ุงููุงุชูุฑุฉ ุงูุฃุตููุฉ ุงูุชู ุชู ุฅูุดุงุก ูุฐู ุงููุงุชูุฑุฉ ูููุง."
```

**ุจุนุฏ:**
```
โ ูุง ูููู ุญุฐู ูุฐู ุงููุงุชูุฑุฉ ูุจุงุดุฑุฉ!

ูุฐู ูุงุชูุฑุฉ ุชู ุฅูุดุงุคูุง ุชููุงุฆูุงู ูู ูุงุชูุฑุฉ ูุนูุฏุฉ.

๐ ุงููุงุชูุฑุฉ ุงูุฃุตููุฉ: #5 (ุฃู ุฑูู ุงููุงุชูุฑุฉ)
๐ค ุงูุนููู: ุงูุฅูุงุฑุงุช

๐ก ูุญุฐู ูุฐู ุงููุงุชูุฑุฉุ ุงุฐูุจ ุฅูู ุงููุงุชูุฑุฉ ุงูุฃุตููุฉ ูุงุญุฐููุง.
```

---

### 2. ุชุญุณูู ุฑุณุงุฆู ุงูุฎุทุฃ - ููุงุชูุฑ ุงููุดุชุฑูุงุช

**ูุจู:**
```
"ูุง ูููู ุญุฐู ูุฐู ุงููุงุชูุฑุฉ ูุจุงุดุฑุฉ. 
ูุฐู ูุงุชูุฑุฉ ูุดุชุฑูุงุช ุชู ุฅูุดุงุคูุง ุชููุงุฆูุงู ูู ูุงุชูุฑุฉ ูุจูุนุงุช ูุนูุฏุฉ. 
ูุฌุจ ุญุฐู ูุงุชูุฑุฉ ุงููุจูุนุงุช ุงูุฃุตููุฉ."
```

**ุจุนุฏ:**
```
โ ูุง ูููู ุญุฐู ูุงุชูุฑุฉ ุงููุดุชุฑูุงุช ูุฐู ูุจุงุดุฑุฉ!

ูุฐู ูุงุชูุฑุฉ ูุดุชุฑูุงุช ุชู ุฅูุดุงุคูุง ุชููุงุฆูุงู ูู ูุงุชูุฑุฉ ูุจูุนุงุช ูุนูุฏุฉ.

๐ ูุงุชูุฑุฉ ุงููุจูุนุงุช ุงูุฃุตููุฉ: #5
๐ค ุงูุนููู: ุงูุฅูุงุฑุงุช

๐ก ูุญุฐู ูุฐู ุงููุงุชูุฑุฉุ ุงุฐูุจ ุฅูู ูุงุชูุฑุฉ ุงููุจูุนุงุช ุงูุฃุตููุฉ ูุงุญุฐููุง.
```

---

### 3. ุชุญุณูู ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก ูู Controllers

#### `SalesController.deleteSale`

**ูุจู:**
```typescript
if (error.message.includes('ุบูุฑ ููุฌูุฏ') || 
    error.message.includes('ููุณ ูุฏูู ุตูุงุญูุฉ')) {
  res.status(404).json({ ... });
} else {
  res.status(500).json({ ... }); // โ ุฎุทุฃ ููู ุดูุก
}
```

**ุจุนุฏ:**
```typescript
// ุฑุณุงุฆู ุฎุทุฃ ูุญููุฉ (403 Forbidden)
if (error.message.includes('ูุง ูููู ุญุฐู ูุฐู ุงููุงุชูุฑุฉ ูุจุงุดุฑุฉ')) {
  res.status(403).json({
    success: false,
    message: error.message, // โ ุงูุฑุณุงูุฉ ุงูููุตูุฉ
  });
}
// ุฑุณุงุฆู ุฎุทุฃ ุบูุฑ ููุฌูุฏ ุฃู ุตูุงุญูุฉ (404 Not Found)
else if (error.message.includes('ุบูุฑ ููุฌูุฏ') || 
         error.message.includes('ููุณ ูุฏูู ุตูุงุญูุฉ')) {
  res.status(404).json({ ... });
}
// ุฃุฎุทุงุก ุฃุฎุฑู (500 Internal Server Error)
else {
  res.status(500).json({
    success: false,
    message: error.message || 'ุฎุทุฃ ูู ุงูุฎุงุฏู ุงูุฏุงุฎูู',
  });
}
```

#### `PurchaseController.deletePurchase`

ููุณ ุงูุชุญุณููุงุช ููุชุนุงูู ูุน ุฃุฎุทุงุก ุญุฐู ููุงุชูุฑ ุงููุดุชุฑูุงุช ุงููุญููุฉ.

---

## ๐ ุฑููุฒ HTTP ุงููุณุชุฎุฏูุฉ

| ุงูุญุงูุฉ | ุงูุฑูุฒ | ุงูุงุณุชุฎุฏุงู |
|--------|------|-----------|
| ูุฌุงุญ | `200 OK` | ุชู ุงูุญุฐู ุจูุฌุงุญ |
| ุทูุจ ุฎุงุทุฆ | `400 Bad Request` | ูุนุฑู ุฎุงุทุฆ ุฃู ููููุฏ |
| ูุญูู | `403 Forbidden` | ูุงุชูุฑุฉ ูุญููุฉ (ุชุงุจุนุฉ) |
| ุบูุฑ ููุฌูุฏ | `404 Not Found` | ุงููุงุชูุฑุฉ ุบูุฑ ููุฌูุฏุฉ |
| ุฎุทุฃ ุฏุงุฎูู | `500 Internal Server Error` | ุฃุฎุทุงุก ุฃุฎุฑู |

---

## ๐ ุขููุฉ ุงูุญูุงูุฉ

### ูููุจูุนุงุช (`SalesService.ts`):
```typescript
const parentComplexSale = await this.prisma.sale.findFirst({
  where: {
    OR: [
      { relatedParentSaleId: id },      // ูุงุชูุฑุฉ ุงูุชูุงุฒู
      { relatedBranchPurchaseId: id }   // (ูุงุฏุฑุงู)
    ]
  },
  select: {
    id: true,
    invoiceNumber: true,
    customer: { select: { name: true } } // โ ูุนูููุงุช ุฅุถุงููุฉ
  }
});

if (parentComplexSale) {
  const customerName = parentComplexSale.customer?.name || 'ุบูุฑ ูุญุฏุฏ';
  const invoiceRef = parentComplexSale.invoiceNumber || `#${parentComplexSale.id}`;
  throw new Error(`โ ูุง ูููู ุญุฐู ูุฐู ุงููุงุชูุฑุฉ ูุจุงุดุฑุฉ!\n\n...`);
}
```

### ูููุดุชุฑูุงุช (`PurchaseService.ts`):
```typescript
const relatedSale = await prisma.sale.findFirst({
  where: {
    relatedBranchPurchaseId: id // ูุงุชูุฑุฉ ุงููุดุชุฑูุงุช ุงูุชุงุจุนุฉ
  },
  select: {
    id: true,
    invoiceNumber: true,
    customer: { select: { name: true } } // โ ูุนูููุงุช ุฅุถุงููุฉ
  }
});

if (relatedSale) {
  const customerName = relatedSale.customer?.name || 'ุบูุฑ ูุญุฏุฏ';
  const invoiceRef = relatedSale.invoiceNumber || `#${relatedSale.id}`;
  throw new Error(`โ ูุง ูููู ุญุฐู ูุงุชูุฑุฉ ุงููุดุชุฑูุงุช ูุฐู ูุจุงุดุฑุฉ!\n\n...`);
}
```

---

## ๐จ ุชุฌุฑุจุฉ ุงููุณุชุฎุฏู ุงููุญุณููุฉ

### ุงูุณููุงุฑูู 1: ูุญุงููุฉ ุญุฐู ูุงุชูุฑุฉ ุงูุชูุงุฒู

```
ุงููุณุชุฎุฏู ูููุฑ "ุญุฐู" ุนูู ูุงุชูุฑุฉ ุงูุชูุงุฒู
    โ
ุงูุฎุงุฏู: 403 Forbidden
    โ
ุฑุณุงูุฉ ุฎุทุฃ ูุงุถุญุฉ:
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ โ ูุง ูููู ุญุฐู ูุฐู ุงููุงุชูุฑุฉ ูุจุงุดุฑุฉ!     โ
โ                                         โ
โ ูุฐู ูุงุชูุฑุฉ ุชู ุฅูุดุงุคูุง ุชููุงุฆูุงู         โ
โ ูู ูุงุชูุฑุฉ ูุนูุฏุฉ.                       โ
โ                                         โ
โ ๐ ุงููุงุชูุฑุฉ ุงูุฃุตููุฉ: #5               โ
โ ๐ค ุงูุนููู: ุงูุฅูุงุฑุงุช                    โ
โ                                         โ
โ ๐ก ูุญุฐู ูุฐู ุงููุงุชูุฑุฉุ                  โ
โ    ุงุฐูุจ ุฅูู ุงููุงุชูุฑุฉ ุงูุฃุตููุฉ ูุงุญุฐููุง. โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    โ
ุงููุณุชุฎุฏู ูููู ูุงุฐุง ููุนู โ
```

### ุงูุณููุงุฑูู 2: ุญุฐู ุงููุงุชูุฑุฉ ุงูุฃุตููุฉ

```
ุงููุณุชุฎุฏู ูููุฑ "ุญุฐู" ุนูู ูุงุชูุฑุฉ ุงูุฅูุงุฑุงุช ุงูุฃุตููุฉ
    โ
ุงูุฎุงุฏู: 200 OK
    โ
โ ุชู ุญุฐู ุงููุงุชูุฑุฉ ูุฌููุน ุงูููุงุชูุฑ ุงููุฑุชุจุทุฉ ุจูุฌุงุญ
โโ ูุงุชูุฑุฉ ุงูุฅูุงุฑุงุช (ุงูุฃุตููุฉ)
โโ ูุงุชูุฑุฉ ุงูุชูุงุฒู (ุชููุงุฆูุงู)
โโ ูุงุชูุฑุฉ ุงููุดุชุฑูุงุช (ุชููุงุฆูุงู)
โโ ุณุฌู PurchaseFromParent (ุชููุงุฆูุงู)
```

---

## ๐ ุงููููุงุช ุงููุนุฏูุฉ

```
โ server/src/services/SalesService.ts
   - ุชุญุณูู ุฑุณุงูุฉ ุฎุทุฃ ุญุฐู ูุงุชูุฑุฉ ูุจูุนุงุช ูุญููุฉ
   - ุฅุถุงูุฉ ูุนูููุงุช ุงููุงุชูุฑุฉ ุงูุฃุตููุฉ

โ server/src/services/PurchaseService.ts
   - ุชุญุณูู ุฑุณุงูุฉ ุฎุทุฃ ุญุฐู ูุงุชูุฑุฉ ูุดุชุฑูุงุช ูุญููุฉ
   - ุฅุถุงูุฉ ูุนูููุงุช ุงููุงุชูุฑุฉ ุงูุฃุตููุฉ

โ server/src/controllers/SalesController.ts
   - ุชุญุณูู ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก
   - ุงุณุชุฎุฏุงู 403 ููููุงุชูุฑ ุงููุญููุฉ

โ server/src/controllers/PurchaseController.ts
   - ุชุญุณูู ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก
   - ุงุณุชุฎุฏุงู 403 ููููุงุชูุฑ ุงููุญููุฉ
```

---

## ๐งช ุงูุงุฎุชุจุงุฑ

### 1. ุงุฎุชุจุงุฑ ุญุฐู ูุงุชูุฑุฉ ูุญููุฉ
```bash
# ูุญุงููุฉ ุญุฐู ูุงุชูุฑุฉ ุงูุชูุงุฒู (ID: 2)
DELETE /api/sales/2

# ุงููุชูุฌุฉ ุงููุชููุนุฉ:
# - ุงูุญุงูุฉ: 403 Forbidden
# - ุงูุฑุณุงูุฉ: ุฑุณุงูุฉ ููุตูุฉ ูุน ูุนูููุงุช ุงููุงุชูุฑุฉ ุงูุฃุตููุฉ
```

### 2. ุงุฎุชุจุงุฑ ุญุฐู ูุงุชูุฑุฉ ุฃุตููุฉ
```bash
# ุญุฐู ูุงุชูุฑุฉ ุงูุฅูุงุฑุงุช (ID: 5)
DELETE /api/sales/5

# ุงููุชูุฌุฉ ุงููุชููุนุฉ:
# - ุงูุญุงูุฉ: 200 OK
# - ุชู ุญุฐู ุฌููุน ุงูููุงุชูุฑ ุงููุฑุชุจุทุฉ
```

### 3. ุงุฎุชุจุงุฑ ุญุฐู ูุงุชูุฑุฉ ูุดุชุฑูุงุช ูุญููุฉ
```bash
# ูุญุงููุฉ ุญุฐู ูุงุชูุฑุฉ ูุดุชุฑูุงุช (ID: 2)
DELETE /api/purchases/2

# ุงููุชูุฌุฉ ุงููุชููุนุฉ:
# - ุงูุญุงูุฉ: 403 Forbidden
# - ุงูุฑุณุงูุฉ: ุฑุณุงูุฉ ููุตูุฉ ูุน ูุนูููุงุช ูุงุชูุฑุฉ ุงููุจูุนุงุช ุงูุฃุตููุฉ
```

---

## ๐ก ุงูููุงุฆุฏ

| ุงูููุฒุฉ | ุงููุตู |
|--------|--------|
| **ูุถูุญ** | ุงููุณุชุฎุฏู ูููู ููุงุฐุง ูุง ูููู ุงูุญุฐู |
| **ุฅุฑุดุงุฏ** | ุชูุฌูู ูุงุถุญ ููุง ูุฌุจ ูุนูู |
| **ูุนูููุงุช** | ุนุฑุถ ุฑูู ุงููุงุชูุฑุฉ ุงูุฃุตููุฉ ูุงูุนููู |
| **ุงุญุชุฑุงููุฉ** | ุฑููุฒ HTTP ุตุญูุญุฉ |
| **UX ุฃูุถู** | ุชุฌุฑุจุฉ ูุณุชุฎุฏู ูุญุณููุฉ |

---

## ๐ ููุฎุต ุงูุชุญุณููุงุช

```
โ ุฑุณุงุฆู ุฎุทุฃ ููุตูุฉ ููุงุถุญุฉ
โ ุฑููุฒ HTTP ุตุญูุญุฉ (403 ุจุฏูุงู ูู 500)
โ ูุนูููุงุช ุฅุถุงููุฉ (ุฑูู ุงููุงุชูุฑุฉุ ุงูุนููู)
โ ุฅุฑุดุงุฏุงุช ูุงุถุญุฉ ูููุณุชุฎุฏู
โ ุฑููุฒ ุชุนุจูุฑูุฉ (emojis) ูุชุญุณูู ุงููุฑุงุกุฉ
โ ูุนุงูุฌุฉ ุฃุฎุทุงุก ูุญุณููุฉ ูู Controllers
โ ุงุณุชุนูุงูุงุช ูุญุณููุฉ ูุน select
โ ุชูุณูู ูุชุณู ุนุจุฑ Services
```

---

**ุชุงุฑูุฎ ุงูุชุญุฏูุซ:** 4 ููููุจุฑ 2025
**ุงูุญุงูุฉ:** โ ููุทุจูู ูุฌุงูุฒ
**ุงูุชุฃุซูุฑ:** ๐ฏ ุชุฌุฑุจุฉ ูุณุชุฎุฏู ูุญุณููุฉ ุจุดูู ูุจูุฑ

