# ุฅุตูุงุญ ุฎุทุฃ ุชุญุฏูุซ ุงูููุงุชูุฑ - ุงุณุชุฎุฏุงู upsert

## ๐ ุงููุดููุฉ

ุนูุฏ ุชุนุฏูู ูุงุชูุฑุฉ ูุจูุนุงุชุ ูุงู ุงููุธุงู ูุชุนุทู ูุน ุงูุฎุทุฃ ุงูุชุงูู:

```
PrismaClientKnownRequestError: 
Invalid `this.prisma.stock.update()` invocation
An operation failed because it depends on one or more records that were required but not found.
No record was found for an update.
code: 'P2025'
```

### ุงูุณุจุจ:

ูู ุฏุงูุฉ `updateSale`ุ ูุงู ุงูููุฏ ูุณุชุฎุฏู `stock.update()` ูู ููุถุนูู:

1. **ุฅุฑุฌุงุน ุงููุฎุฒูู ุงููุฏูู** (ุงูุณุทุฑ 393)
2. **ุฎุตู ุงููุฎุฒูู ุงูุฌุฏูุฏ** (ุงูุณุทุฑ 546)

ุฅุฐุง ูู ููู ุณุฌู ุงููุฎุฒูู ููุฌูุฏุงู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุชุ ุชูุดู ุนูููุฉ `update`.

---

## โ ุงูุญู

ุงุณุชุจุฏุงู `stock.update()` ุจู `stock.upsert()` ูู ููุง ุงูููุถุนูู.

---

### 1. ุฅุตูุงุญ ุฅุฑุฌุงุน ุงููุฎุฒูู ุงููุฏูู

#### ูุจู ุงูุฅุตูุงุญ โ

```typescript
// ุงูุณุทุฑ 393 - updateSale
await this.prisma.stock.update({
  where: {
    companyId_productId: {
      companyId: userCompanyId,
      productId: line.productId
    }
  },
  data: {
    boxes: {
      increment: boxesToIncrement
    }
  }
});
```

**ุงููุดููุฉ:** ุฅุฐุง ูู ููู ุงูุณุฌู ููุฌูุฏุงูุ ุชูุดู ุงูุนูููุฉ.

---

#### ุจุนุฏ ุงูุฅุตูุงุญ โ

```typescript
// ุงูุณุทุฑ 393-411 - updateSale
await this.prisma.stock.upsert({
  where: {
    companyId_productId: {
      companyId: userCompanyId,
      productId: line.productId
    }
  },
  update: {
    boxes: {
      increment: boxesToIncrement
    }
  },
  create: {
    companyId: userCompanyId,
    productId: line.productId,
    boxes: boxesToIncrement
  }
});
```

**ุงููุงุฆุฏุฉ:**
- โ ุฅุฐุง ูุงู ุงูุณุฌู ููุฌูุฏุงู โ ูุฒูุฏ ุงููููุฉ
- โ ุฅุฐุง ูู ููู ููุฌูุฏุงู โ ููุดุฆู ุจุงููููุฉ ุงููุทููุจุฉ

---

### 2. ุฅุตูุงุญ ุฎุตู ุงููุฎุฒูู ุงูุฌุฏูุฏ

#### ูุจู ุงูุฅุตูุงุญ โ

```typescript
// ุงูุณุทุฑ 546-558 - updateSale
await this.prisma.stock.update({
  where: {
    companyId_productId: {
      companyId: userCompanyId,
      productId: line.productId
    }
  },
  data: {
    boxes: {
      decrement: boxesToDecrement
    }
  }
});
```

**ุงููุดููุฉ:** ุฅุฐุง ูู ููู ุงูุณุฌู ููุฌูุฏุงูุ ุชูุดู ุงูุนูููุฉ.

---

#### ุจุนุฏ ุงูุฅุตูุงุญ โ

```typescript
// ุงูุณุทุฑ 546-575 - updateSale
// ุงูุญุตูู ุนูู ุงููุฎุฒูู ุงูุญุงูู
const currentStock = await this.prisma.stock.findUnique({
  where: {
    companyId_productId: {
      companyId: userCompanyId,
      productId: line.productId
    }
  }
});

const currentBoxes = currentStock ? Number(currentStock.boxes) : 0;
const newBoxes = Math.max(0, currentBoxes - boxesToDecrement);

// ุงุณุชุฎุฏุงู upsert ูุถูุงู ุงูุชุนุงูู ูุน ุงูุญุงูุฉ ุญุชู ูู ูู ููู ุงูุณุฌู ููุฌูุฏุงู
await this.prisma.stock.upsert({
  where: {
    companyId_productId: {
      companyId: userCompanyId,
      productId: line.productId
    }
  },
  update: {
    boxes: newBoxes
  },
  create: {
    companyId: userCompanyId,
    productId: line.productId,
    boxes: 0 // ุฅุฐุง ูู ููู ููุฌูุฏุงูุ ูุจุฏุฃ ูู 0
  }
});
```

**ุงูููุงุฆุฏ:**
- โ ูุญุณุจ ุงููุฎุฒูู ุงูุฌุฏูุฏ ุจุดูู ุตุญูุญ
- โ ูุณุชุฎุฏู `Math.max(0, ...)` ูููุน ุงูููู ุงูุณุงูุจุฉ
- โ ููุดุฆ ุงูุณุฌู ุฅุฐุง ูู ููู ููุฌูุฏุงู
- โ ูุชุนุงูู ูุน ุฌููุน ุงูุญุงูุงุช ุงูุทุฑููุฉ

---

## ๐ ุขููุฉ ุงูุนูู ุงููุงููุฉ ูู updateSale

### ุงูุณููุงุฑูู: ุชุนุฏูู ูุงุชูุฑุฉ ูู 3 ุฃุตูุงู ุฅูู ุตูููู ูุฎุชูููู

```
1. ุงููุงุชูุฑุฉ ุงููุฏููุฉ:
   - ุตูู A: 10 ูุญุฏุงุช
   - ุตูู B: 5 ูุญุฏุงุช
   - ุตูู C: 8 ูุญุฏุงุช

2. ุงููุงุชูุฑุฉ ุงูุฌุฏูุฏุฉ:
   - ุตูู B: 3 ูุญุฏุงุช
   - ุตูู D: 7 ูุญุฏุงุช

3. ุนูููุฉ ุงูุชุญุฏูุซ:
   
   ุฃ. ุฅุฑุฌุงุน ุงููุฎุฒูู ุงููุฏูู (upsert ูุน increment):
      โ ุตูู A: +10 ูุญุฏุงุช
      โ ุตูู B: +5 ูุญุฏุงุช
      โ ุตูู C: +8 ูุญุฏุงุช
   
   ุจ. ุงูุชุญูู ูู ุชููุฑ ุงููุฎุฒูู ุงูุฌุฏูุฏ:
      โ ุตูู B: ูุฌุจ ุชููุฑ 3 ูุญุฏุงุช ุนูู ุงูุฃูู
      โ ุตูู D: ูุฌุจ ุชููุฑ 7 ูุญุฏุงุช ุนูู ุงูุฃูู
   
   ุฌ. ุญุฐู ุงูุจููุฏ ุงููุฏููุฉ ูู ุงููุงุชูุฑุฉ
   
   ุฏ. ุฅูุดุงุก ุงูุจููุฏ ุงูุฌุฏูุฏุฉ
   
   ูู. ุฎุตู ุงููุฎุฒูู ุงูุฌุฏูุฏ (upsert ูุน ุงููููุฉ ุงูุฌุฏูุฏุฉ):
      โ ุตูู B: -3 ูุญุฏุงุช (ูู ุงููุฎุฒูู ุงูุญุงูู + 5 ุงููุฑุฌูุนุฉ)
      โ ุตูู D: -7 ูุญุฏุงุช

4. ุงููุชูุฌุฉ ุงูููุงุฆูุฉ:
   ุงููุฎุฒูู:
   - ุตูู A: +10 (ูุฑุฌูุน ุจุงููุงูู)
   - ุตูู B: +2 (ูุฑุฌูุน 5ุ ุฎูุตู 3)
   - ุตูู C: +8 (ูุฑุฌูุน ุจุงููุงูู)
   - ุตูู D: -7 (ุฎูุตู)
```

---

## ๐ ููุงุฑูุฉ: update vs upsert

| ุงูููุฒุฉ | `update()` | `upsert()` |
|--------|-----------|-----------|
| ุงูุณุฌู ููุฌูุฏ | โ ูุนูู | โ ูุนูู |
| ุงูุณุฌู ุบูุฑ ููุฌูุฏ | โ ุฎุทุฃ P2025 | โ ููุดุฆู |
| ุงูุฃูุงู | โ ููุฎูุถ | โ ุนุงูู |
| ุงููุฑููุฉ | โ ูุญุฏูุฏุฉ | โ ุดุงููุฉ |
| ุงูููุซูููุฉ | โ ูุฏ ููุดู | โ ุฏุงุฆูุงู ููุฌุญ |

---

## ๐ฏ ุงูุญุงูุงุช ุงูุชู ุชู ุฅุตูุงุญูุง

### 1. ุชุนุฏูู ูุงุชูุฑุฉ ุจุตูู ูู ููู ูู ูุฎุฒูู ูุณุจูุงู

```
ูุจู: โ ุฎุทุฃ P2025
ุจุนุฏ: โ ููุดุฆ ุงูุณุฌู ููุญุฏุซ ุงููุฎุฒูู
```

---

### 2. ุชุนุฏูู ูุงุชูุฑุฉ ุจุฅุถุงูุฉ ุฃุตูุงู ุฌุฏูุฏุฉ

```
ูุจู: โ ุฎุทุฃ ุนูุฏ ุฎุตู ุงููุฎุฒูู ุงูุฌุฏูุฏ
ุจุนุฏ: โ ูุฎุตู ุงููุฎุฒูู ุฃู ููุดุฆ ุงูุณุฌู ุจุงููููุฉ ุงูุตุญูุญุฉ
```

---

### 3. ุฅุฑุฌุงุน ูุฎุฒูู ูุฃุตูุงู ุชู ุญุฐููุง ูู ุงููุงุชูุฑุฉ

```
ูุจู: โ ุฎุทุฃ ุฅุฐุง ูู ููู ููุตูู ุณุฌู ูุฎุฒูู
ุจุนุฏ: โ ููุดุฆ ุงูุณุฌู ุจุงููููุฉ ุงููุฑุฌูุนุฉ
```

---

## ๐ ุงูุฅุตูุงุญุงุช ุงููุฑุชุจุทุฉ

ูุฐุง ุงูุฅุตูุงุญ ูุดุงุจู ููุฅุตูุงุญ ุงูุฐู ุชู ูู `deleteSale`:

1. **`deleteSale`** โ [STOCK_UPSERT_FIX.md](./STOCK_UPSERT_FIX.md)
   - ุฅุตูุงุญ ุฅุฑุฌุงุน ุงููุฎุฒูู ุนูุฏ ุญุฐู ุงูููุงุชูุฑ

2. **`updateSale`** โ ูุฐุง ุงูุฅุตูุงุญ
   - ุฅุตูุงุญ ุฅุฑุฌุงุน ูุฎุตู ุงููุฎุฒูู ุนูุฏ ุชุนุฏูู ุงูููุงุชูุฑ

---

## ๐ ุงููููุงุช ุงููุนุฏูุฉ

```
โ server/src/services/SalesService.ts
   - updateSale (ุงูุณุทูุฑ 393-411): ุฅุฑุฌุงุน ุงููุฎุฒูู ุงููุฏูู
   - updateSale (ุงูุณุทูุฑ 546-575): ุฎุตู ุงููุฎุฒูู ุงูุฌุฏูุฏ
```

---

## ๐งช ุงูุงุฎุชุจุงุฑ

### ุงูุณููุงุฑูู 1: ุชุนุฏูู ูุงุชูุฑุฉ ุนุงุฏูุฉ

```
1. ุฃูุดุฆ ูุงุชูุฑุฉ ุจู 2 ุฃุตูุงู
2. ุนุฏูู ุงููุงุชูุฑุฉ:
   - ุบููุฑ ุงููููุงุช
   - ุฃุถู ุตูู ุฌุฏูุฏ
   - ุงุญุฐู ุตูู ูุฏูู
3. โ ุงููุชูุฌุฉ: ุงูุชุนุฏูู ููุฌุญ ุจุฏูู ุฃุฎุทุงุก
4. โ ุงููุฎุฒูู: ูุญุฏูุซ ุจุดูู ุตุญูุญ
```

---

### ุงูุณููุงุฑูู 2: ุชุนุฏูู ูุงุชูุฑุฉ ูุฃุตูุงู ุฌุฏูุฏุฉ

```
1. ุฃูุดุฆ ูุงุชูุฑุฉ ุจุฃุตูุงู ูู ููู ููุง ูุฎุฒูู
2. ุนุฏูู ุงููุงุชูุฑุฉ
3. โ ุงููุชูุฌุฉ: ุงูุชุนุฏูู ููุฌุญ
4. โ ุงููุฎุฒูู: ูุชู ุฅูุดุงุก ุงูุณุฌูุงุช ูุชุญุฏูุซูุง
```

---

### ุงูุณููุงุฑูู 3: ุชุนุฏูู ูุชุนุฏุฏ ูููุงุชูุฑุฉ ููุณูุง

```
1. ุฃูุดุฆ ูุงุชูุฑุฉ
2. ุนุฏูููุง ุงููุฑุฉ ุงูุฃููู
3. ุนุฏูููุง ุงููุฑุฉ ุงูุซุงููุฉ
4. ุนุฏูููุง ุงููุฑุฉ ุงูุซุงูุซุฉ
5. โ ุงููุชูุฌุฉ: ุฌููุน ุงูุชุนุฏููุงุช ุชูุฌุญ
6. โ ุงููุฎุฒูู: ุฏููู ููุญุฏูุซ
```

---

## ๐ก ุงูุฏุฑูุณ ุงููุณุชูุงุฏุฉ

### 1. ุงุณุชุฎุฏู `upsert` ูููุฑููุฉ
```typescript
// โ ุชุฌูุจ
await prisma.model.update({ ... });

// โ ุงุณุชุฎุฏู
await prisma.model.upsert({
  where: { ... },
  update: { ... },
  create: { ... }
});
```

---

### 2. ุงุญุณุจ ุงูููู ุงูุฌุฏูุฏุฉ ุจุฏูุงู ูู ุงุณุชุฎุฏุงู increment/decrement
```typescript
// โ ุชุฌูุจ (ูุฏ ููุดู)
data: { boxes: { decrement: qty } }

// โ ุงุณุชุฎุฏู (ุฃูุซุฑ ุฃูุงูุงู)
const current = await prisma.stock.findUnique({ ... });
const newValue = Math.max(0, current.boxes - qty);
update: { boxes: newValue }
```

---

### 3. ุงุณุชุฎุฏู Math.max ูููุน ุงูููู ุงูุณุงูุจุฉ
```typescript
// โ ููุน ุงูููู ุงูุณุงูุจุฉ
const newBoxes = Math.max(0, currentBoxes - boxesToDecrement);
```

---

## ๐ ููุฎุต ุงูููุงุฆุฏ

```
โ ุชุนุฏูู ุงูููุงุชูุฑ ูุนูู ุจุฏูู ุฃุฎุทุงุก
โ ูุง ูุดุงูู ูุน ุงูุฃุตูุงู ุงูุฌุฏูุฏุฉ
โ ุฅุฏุงุฑุฉ ูุฎุฒูู ุฏูููุฉ
โ ุงูุชุนุงูู ูุน ุฌููุน ุงูุญุงูุงุช ุงูุทุฑููุฉ
โ ููุฏ ุฃูุซุฑ ููุซูููุฉ ูุฃูุงูุงู
โ ุชุฌุฑุจุฉ ูุณุชุฎุฏู ูุญุณููุฉ
```

---

**ุชุงุฑูุฎ ุงูุฅุตูุงุญ:** 4 ููููุจุฑ 2025
**ุงูุญุงูุฉ:** โ ููุทุจูู ูุฌุงูุฒ
**ุงูุชุฃุซูุฑ:** ๐ฏ ุชุนุฏูู ุงูููุงุชูุฑ ุจุฏูู ุฃุฎุทุงุก P2025

