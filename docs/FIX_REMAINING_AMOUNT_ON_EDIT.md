# ุฅุตูุงุญ: ุชุญุฏูุซ ุงููุจูุบ ุงููุชุจูู ุนูุฏ ุชุนุฏูู ุงููุงุชูุฑุฉ

## ๐ฏ ุงููุดููุฉ

ุนูุฏ ุชุนุฏูู ูุงุชูุฑุฉ ูุชุบููุฑ ุงูุฃุตูุงู/ุงููููุงุช/ุงูุฃุณุนุงุฑ:
- โ ุงููุฌููุน ุงูููู (`total`) ูุชู ุชุญุฏูุซู โ
- โ ุงููุจูุบ ุงููุชุจูู (`remainingAmount`) **ูุง** ูุชู ุชุญุฏูุซู โ
- โ ูุธูุฑ ูู ุดุงุดุฉ ุงููุญุงุณุจ ูุจูุบ ูุชุจูู ุฎุงุทุฆ

---

## โ ุงูุญู

ุนูุฏ ุชุนุฏูู ุงููุงุชูุฑุฉ:
```typescript
remainingAmount = total - paidAmount
isFullyPaid = (remainingAmount <= 0)
```

---

## ๐ ุงูุชุบููุฑุงุช ูู ุงูููุฏ

### ุงูููู: `server/src/services/SalesService.ts`

#### 1. **ุชุญุฏูุซ ุงููุงุชูุฑุฉ ุงูุฃุตููุฉ (ุงูุณุทุฑ 526-540):**

**ูุจู:**
```typescript
// ุญุณุงุจ ุงููุฌููุน ุงูุฌุฏูุฏ
let total = Number(existingSale.total);
if (data.lines) {
  total = 0;
  for (const line of data.lines) {
    total += line.qty * line.unitPrice;
  }
}

// ุชุญุฏูุซ ุงููุงุชูุฑุฉ
const updatedSale = await this.prisma.sale.update({
  where: { id },
  data: {
    customerId: data.customerId,
    invoiceNumber: data.invoiceNumber,
    saleType: data.saleType,
    paymentMethod: data.paymentMethod,
    total: data.lines ? total : undefined,
    // โ ูุง ูุชู ุชุญุฏูุซ remainingAmount
    ...
  }
});
```

**ุจุนุฏ:**
```typescript
// ุญุณุงุจ ุงููุฌููุน ุงูุฌุฏูุฏ
let total = Number(existingSale.total);
if (data.lines) {
  total = 0;
  for (const line of data.lines) {
    total += line.qty * line.unitPrice;
  }
}

// โ ุญุณุงุจ ุงููุจูุบ ุงููุชุจูู ุงูุฌุฏูุฏ
const currentPaidAmount = Number(existingSale.paidAmount) || 0;
const newRemainingAmount = total - currentPaidAmount;

// ุชุญุฏูุซ ุงููุงุชูุฑุฉ
const updatedSale = await this.prisma.sale.update({
  where: { id },
  data: {
    customerId: data.customerId,
    invoiceNumber: data.invoiceNumber,
    saleType: data.saleType,
    paymentMethod: data.paymentMethod,
    total: data.lines ? total : undefined,
    remainingAmount: data.lines ? newRemainingAmount : undefined, // โ ุชุญุฏูุซ ุงููุจูุบ ุงููุชุจูู
    isFullyPaid: data.lines ? (newRemainingAmount <= 0) : undefined, // โ ุชุญุฏูุซ ุญุงูุฉ ุงูุฏูุน
    ...
  }
});
```

---

#### 2. **ุชุญุฏูุซ ูุงุชูุฑุฉ ุงูุชูุงุฒู (ุงูุณุทุฑ 687-696):**

**ูุจู:**
```typescript
// ุชุญุฏูุซ ูุงุชูุฑุฉ ุงูุชูุงุฒู
await this.prisma.sale.update({
  where: { id: existingSale.relatedParentSaleId },
  data: {
    total: parentSaleTotal,
    // โ ูุง ูุชู ุชุญุฏูุซ remainingAmount
    lines: {
      create: parentSaleNewLines
    }
  }
});
```

**ุจุนุฏ:**
```typescript
// ุชุญุฏูุซ ูุงุชูุฑุฉ ุงูุชูุงุฒู
await this.prisma.sale.update({
  where: { id: existingSale.relatedParentSaleId },
  data: {
    total: parentSaleTotal,
    remainingAmount: parentSaleTotal, // โ ุชุญุฏูุซ ุงููุจูุบ ุงููุชุจูู (ุขุฌูุฉ ุฏุงุฆูุงู)
    lines: {
      create: parentSaleNewLines
    }
  }
});
```

---

#### 3. **ูุงุชูุฑุฉ ุงููุดุชุฑูุงุช:**
```typescript
// โ ุชู ุชุญุฏูุซ remainingAmount ุจุงููุนู (ุงูุณุทุฑ 713)
await this.prisma.purchase.update({
  where: { id: existingSale.relatedBranchPurchaseId },
  data: {
    total: parentSaleTotal,
    remainingAmount: parentSaleTotal, // โ ููุฌูุฏ ุจุงููุนู
    lines: { ... }
  }
});
```

---

## ๐งช ุณููุงุฑูู ุงูุงุฎุชุจุงุฑ

### **ุงูุฎุทูุฉ 1: ุฅูุดุงุก ูุงุชูุฑุฉ**

```
ูุงุชูุฑุฉ ุงูุฅูุงุฑุงุช:
  - ุตูู A: 10 ร 100 = 1000 ุฑ.ุณ
  - ุตูู B: 5 ร 200 = 1000 ุฑ.ุณ
  ุงููุฌููุน: 2000 ุฑ.ุณ
  
ุงูุญุงูุฉ ุงูุฃูููุฉ:
  - total: 2000
  - paidAmount: 0 (ูุจุฏุฆูุฉ)
  - remainingAmount: 0
  - status: DRAFT
```

---

### **ุงูุฎุทูุฉ 2: ุชุนุฏูู ุงููุงุชูุฑุฉ**

```
ุงููุณุชุฎุฏู ูุนุฏูู:
  - ุตูู A: 10 โ 15 ุตูุงุฏูู
  - ุตูู A: 100 โ 120 ุฑ.ุณ
  
ุงููุงุชูุฑุฉ ุงูุฌุฏูุฏุฉ:
  - ุตูู A: 15 ร 120 = 1800 ุฑ.ุณ
  - ุตูู B: 5 ร 200 = 1000 ุฑ.ุณ
  ุงููุฌููุน ุงูุฌุฏูุฏ: 2800 ุฑ.ุณ
```

---

### **ุงูุฎุทูุฉ 3: ุงูุชุญุฏูุซ ุงูุชููุงุฆู**

#### โ **ูุจู ุงูุฅุตูุงุญ:**
```
ุงููุงุชูุฑุฉ ุจุนุฏ ุงูุชุนุฏูู:
  - total: 2800 ุฑ.ุณ โ
  - paidAmount: 0
  - remainingAmount: 0 โ (ูู ูุชุญุฏุซ!)
  
ุงููุดููุฉ: ุงููุจูุบ ุงููุชุจูู ุฎุงุทุฆ ูู ุดุงุดุฉ ุงููุญุงุณุจ
```

#### โ **ุจุนุฏ ุงูุฅุตูุงุญ:**
```
ุงููุงุชูุฑุฉ ุจุนุฏ ุงูุชุนุฏูู:
  - total: 2800 ุฑ.ุณ โ
  - paidAmount: 0
  - remainingAmount: 2800 ุฑ.ุณ โ (ุชู ุงูุชุญุฏูุซ!)
  - isFullyPaid: false โ
  
ุงููุชูุฌุฉ: ุงููุจูุบ ุงููุชุจูู ุตุญูุญ ูู ุดุงุดุฉ ุงููุญุงุณุจ โ
```

---

### **ุงูุฎุทูุฉ 4: ุงููุญุงุณุจ ูุนุชูุฏ ููุฏูุน ุฌุฒุก**

```
ุงููุญุงุณุจ ูุนุชูุฏ ุงููุงุชูุฑุฉ:
  - ููุน ุงููุงุชูุฑุฉ: ุขุฌู (CREDIT)
  - ุงููุจูุบ ุงููุฏููุน: 1000 ุฑ.ุณ
  
ุจุนุฏ ุงูุงุนุชูุงุฏ:
  - total: 2800 ุฑ.ุณ
  - paidAmount: 1000 ุฑ.ุณ
  - remainingAmount: 1800 ุฑ.ุณ โ
  - isFullyPaid: false
  - status: APPROVED
```

---

### **ุงูุฎุทูุฉ 5: ุชุนุฏูู ูุฑุฉ ุฃุฎุฑู (ุจุนุฏ ุงูุงุนุชูุงุฏ)**

```
ูุง ูููู! โ
ุงููุงุชูุฑุฉ ุงููุนุชูุฏุฉ ูุง ูููู ุชุนุฏูููุง
(ููุท ุงูููุงุชูุฑ ุงููุจุฏุฆูุฉ DRAFT ูููู ุชุนุฏูููุง)
```

---

## ๐ ุฌุฏูู ุงูุญุงูุงุช

| ุงูุญุงูุฉ | ุงููุฌููุน | ุงููุฏููุน | ุงููุชุจูู | ุงูุญุงูุฉ |
|--------|---------|---------|---------|---------|
| **ุฅูุดุงุก** | 2000 | 0 | 0 | DRAFT |
| **ุชุนุฏูู (ูุจู ุงูุฅุตูุงุญ)** | 2800 | 0 | 0 โ | DRAFT |
| **ุชุนุฏูู (ุจุนุฏ ุงูุฅุตูุงุญ)** | 2800 | 0 | 2800 โ | DRAFT |
| **ุงุนุชูุงุฏ (ุฏูุน ุฌุฒุฆู)** | 2800 | 1000 | 1800 โ | APPROVED |
| **ุงุนุชูุงุฏ (ุฏูุน ูุงูู)** | 2800 | 2800 | 0 โ | APPROVED |

---

## ๐ก ููุงุญุธุงุช ูููุฉ

### 1. **ุญุณุงุจ ุงููุจูุบ ุงููุชุจูู:**
```
remainingAmount = total - paidAmount

ุฃูุซูุฉ:
- ุงููุฌููุน: 2000ุ ุงููุฏููุน: 0 โ ุงููุชุจูู: 2000
- ุงููุฌููุน: 2000ุ ุงููุฏููุน: 500 โ ุงููุชุจูู: 1500
- ุงููุฌููุน: 2000ุ ุงููุฏููุน: 2000 โ ุงููุชุจูู: 0
```

---

### 2. **ุญุงูุฉ ุงูุฏูุน ุงููุงูู:**
```
isFullyPaid = (remainingAmount <= 0)

ุฃูุซูุฉ:
- ุงููุชุจูู: 2000 โ isFullyPaid: false
- ุงููุชุจูู: 500 โ isFullyPaid: false
- ุงููุชุจูู: 0 โ isFullyPaid: true
```

---

### 3. **ุงูููุงุชูุฑ ุงูุชููุงุฆูุฉ:**
```
ูุงุชูุฑุฉ ุงูุชูุงุฒู (ุขุฌูุฉ ุฏุงุฆูุงู):
  - paidAmount: 0
  - remainingAmount: total
  - isFullyPaid: false
  
ูุงุชูุฑุฉ ุงููุดุชุฑูุงุช (ุขุฌูุฉ ุฏุงุฆูุงู):
  - paidAmount: 0
  - remainingAmount: total
  - isFullyPaid: false
```

---

### 4. **ุดุงุดุฉ ุงููุญุงุณุจ:**
```
โ ุงูุขู ูุธูุฑ ุงููุจูุบ ุงููุชุจูู ุจุดูู ุตุญูุญ
โ ุงููุจูุบ ุงููุชุจูู ูุชุญุฏุซ ุชููุงุฆูุงู ุนูุฏ ุชุนุฏูู ุงููุงุชูุฑุฉ
โ ุญุงูุฉ ุงูุฏูุน (isFullyPaid) ุชุชุญุฏุซ ุชููุงุฆูุงู
```

---

## ๐ ุงููููุงุช ุงููุนุฏูุฉ

```
โ server/src/services/SalesService.ts
   - updateSale():
     * ุงูุณุทุฑ 526-540: ุญุณุงุจ ูุชุญุฏูุซ remainingAmount ูููุงุชูุฑุฉ ุงูุฃุตููุฉ
     * ุงูุณุทุฑ 691: ุชุญุฏูุซ remainingAmount ููุงุชูุฑุฉ ุงูุชูุงุฒู
     * ุงูุณุทุฑ 713: ุชุญุฏูุซ remainingAmount ููุงุชูุฑุฉ ุงููุดุชุฑูุงุช (ูุงู ููุฌูุฏ)
```

---

## ๐ ุญุงูุฉ ุงููุธุงู

```
โ ุฅูุดุงุก ูุงุชูุฑุฉ: DRAFT ุจุฏูู ุฎุตู ูุฎุฒูู
โ ุชุนุฏูู ูุงุชูุฑุฉ:
   - ุชุญุฏูุซ total โ
   - ุชุญุฏูุซ remainingAmount โ (ุฌุฏูุฏ)
   - ุชุญุฏูุซ isFullyPaid โ (ุฌุฏูุฏ)
โ ุงุนุชูุงุฏ ูุงุชูุฑุฉ: APPROVED + ุฎุตู ูุฎุฒูู
โ ุงููุจูุบ ุงููุชุจูู ูู ุดุงุดุฉ ุงููุญุงุณุจ: ุตุญูุญ โ
โ ุงูููุงุชูุฑ ุงูุชููุงุฆูุฉ: ุชุญุฏูุซ ุชููุงุฆู ููู remainingAmount โ
```

---

**ุชุงุฑูุฎ ุงูุชุญุฏูุซ:** 5 ููููุจุฑ 2025  
**ุงูุญุงูุฉ:** โ ููุทุจูู ููุนูู  
**ุงูุชุฃุซูุฑ:** ๐ฐ ุงููุจูุบ ุงููุชุจูู ูุธูุฑ ุจุดูู ุตุญูุญ ูู ุดุงุดุฉ ุงููุญุงุณุจ ุจุนุฏ ุงูุชุนุฏูู

