# ๐๏ธ ููุฒุฉ ุงูุญุฐู ุงููุชุณูุณู ููููุงุชูุฑ ุงููุนูุฏุฉ

## ๐ฏ ุงููุฏู

ุนูุฏ ุญุฐู ูุงุชูุฑุฉ ูุจูุนุงุช ูุนูุฏุฉ (ุชุญุชูู ุนูู ุฃุตูุงู ูู ุงูุดุฑูุฉ ุงูุฃู ูุงูุดุฑูุฉ ุงูุชุงุจุนุฉ)ุ ูุชู **ุญุฐู ุฌููุน ุงูููุงุชูุฑ ุงููุฑุชุจุทุฉ ุชููุงุฆูุงู** ูุน **ุฅุฑุฌุงุน ุงููุฎุฒูู** ูุฌููุน ุงูุดุฑูุงุช.

---

## ๐ ุงูุณููุงุฑูู

### ูุซุงู ูุงูุนู:
```
ุงูุนููู: ูุญูุฏ ุฃุญูุฏ
ุงูุดุฑูุฉ ุงูุชุงุจุนุฉ: ุตุงูุฉ ุงูุฅูุงุฑุงุช
ุงูุดุฑูุฉ ุงูุฃู: ูุฎุฒู ุงูุชูุงุฒู

ุงููุงุชูุฑุฉ ุชุญุชูู ุนูู:
- 50 ุตูุฏูู ุจูุงุท ูู ูุฎุฒู ุงูุชูุงุฒู
- 30 ุตูุฏูู ุณูุฑุงููู ูู ุตุงูุฉ ุงูุฅูุงุฑุงุช
```

### ุงูููุงุชูุฑ ุงูุชู ูุชู ุฅูุดุงุคูุง:

#### 1๏ธโฃ **ูุงุชูุฑุฉ ุงูุนููู ุงูุฃุตููุฉ** (ูู ุตุงูุฉ ุงูุฅูุงุฑุงุช)
```
ูู: ุตุงูุฉ ุงูุฅูุงุฑุงุช
ุฅูู: ูุญูุฏ ุฃุญูุฏ (ุงูุนููู)
ุงูุฃุตูุงู:
  - 50 ุตูุฏูู ุจูุงุท (ูู ูุฎุฒู ุงูุชูุงุฒู)
  - 30 ุตูุฏูู ุณูุฑุงููู (ูู ุตุงูุฉ ุงูุฅูุงุฑุงุช)
ุงููุฌููุน: 1,200 ุฏ.ู
```

#### 2๏ธโฃ **ูุงุชูุฑุฉ ูุจูุนุงุช ูู ุงูุดุฑูุฉ ุงูุฃู** (ุขุฌูุฉ)
```
ูู: ูุฎุฒู ุงูุชูุงุฒู
ุฅูู: ุตุงูุฉ ุงูุฅูุงุฑุงุช (ูุนููู)
ุงูุฃุตูุงู:
  - 50 ุตูุฏูู ุจูุงุท
ุงููุฌููุน: 775 ุฏ.ู
ุงูููุน: ุขุฌู (CREDIT)
```

#### 3๏ธโฃ **ูุงุชูุฑุฉ ูุดุชุฑูุงุช ููุดุฑูุฉ ุงูุชุงุจุนุฉ**
```
ูู: ูุฎุฒู ุงูุชูุงุฒู (ูููุฑุฏ)
ุฅูู: ุตุงูุฉ ุงูุฅูุงุฑุงุช
ุงูุฃุตูุงู:
  - 50 ุตูุฏูู ุจูุงุท
ุงููุฌููุน: 775 ุฏ.ู
ุงูุญุงูุฉ: DRAFT
affectsInventory: false
```

---

## ๐ ูุงุฐุง ูุญุฏุซ ุนูุฏ ุงูุญุฐูุ

### ุนูุฏ ุญุฐู ุงููุงุชูุฑุฉ ุงูุฃุตููุฉ (ูุงุชูุฑุฉ ุงูุนููู):

```
๐๏ธ ุจุฏุก ุงูุญุฐู ุงููุชุณูุณู...

1๏ธโฃ ุญุฐู ูุงุชูุฑุฉ ุงูุดุฑูุฉ ุงูุฃู:
   โโ ุฅุฑุฌุงุน 50 ุตูุฏูู ุจูุงุท ุฅูู ูุฎุฒู ุงูุชูุงุฒู
   โโ ุญุฐู ุฃุณุทุฑ ุงููุงุชูุฑุฉ
   โโ ุญุฐู ุงูุฏูุนุงุช (ุฅู ูุฌุฏุช)
   โโ ุญุฐู ุงููุงุชูุฑุฉ โ

2๏ธโฃ ุญุฐู ูุงุชูุฑุฉ ุงููุดุชุฑูุงุช:
   โโ ุญุฐู ุฃุณุทุฑ ุงููุงุชูุฑุฉ
   โโ ุญุฐู ุงูุฏูุนุงุช (ุฅู ูุฌุฏุช)
   โโ ุญุฐู ุงููุงุชูุฑุฉ โ
   ููุงุญุธุฉ: ูุง ูุชู ุฅุฑุฌุงุน ูุฎุฒูู (affectsInventory = false)

3๏ธโฃ ุญุฐู ุณุฌู PurchaseFromParent:
   โโ ุญุฐู ุฃุณุทุฑ ุงูุณุฌู
   โโ ุญุฐู ุงูุฅูุตุงูุงุช
   โโ ุญุฐู ุงูุณุฌู โ

4๏ธโฃ ุญุฐู ุงููุงุชูุฑุฉ ุงูุฃุตููุฉ:
   โโ ุฅุฑุฌุงุน 30 ุตูุฏูู ุณูุฑุงููู ุฅูู ุตุงูุฉ ุงูุฅูุงุฑุงุช
   โโ ุญุฐู ุฃุณุทุฑ ุงููุงุชูุฑุฉ
   โโ ุญุฐู ุงูุฏูุนุงุช (ุฅู ูุฌุฏุช)
   โโ ุญุฐู ุงููุงุชูุฑุฉ โ

โ ุชู ุงูุญุฐู ุจูุฌุงุญ! ุฌููุน ุงูููุงุชูุฑ ูุญุฐููุฉ ูุงููุฎุฒูู ููุฑุฌุน.
```

---

## ๐ป ุงูููุฏ ุงูุชููู

### 1. **Schema - ุงูุญููู ุงููุฑุชุจุทุฉ:**

```prisma
model Sale {
  id                          Int      @id @default(autoincrement())
  // ... ุญููู ุฃุฎุฑู
  
  // ุงูุญููู ุงููุฑุชุจุทุฉ ููููุงุชูุฑ ุงููุนูุฏุฉ
  relatedParentSaleId        Int?
  relatedBranchPurchaseId    Int?
  relatedPurchaseFromParentId Int?
  
  @@index([relatedParentSaleId])
  @@index([relatedBranchPurchaseId])
}
```

### 2. **SalesService.ts - ุฏุงูุฉ ุงูุญุฐู:**

```typescript
async deleteSale(id: number, userCompanyId: number, isSystemUser: boolean = false) {
  try {
    // 1. ุงูุชุญูู ูู ูุฌูุฏ ุงููุงุชูุฑุฉ
    const existingSale = await this.prisma.sale.findFirst({
      where: { id, ...(isSystemUser !== true && { companyId: userCompanyId }) },
      include: { lines: true }
    });

    if (!existingSale) {
      throw new Error('ุงููุงุชูุฑุฉ ุบูุฑ ููุฌูุฏุฉ ุฃู ููุณ ูุฏูู ุตูุงุญูุฉ ูุญุฐููุง');
    }

    // 2. ุญุฐู ุงูููุงุชูุฑ ุงููุฑุชุจุทุฉ ุฅุฐุง ูุงูุช ูุนูุฏุฉ
    if (existingSale.relatedParentSaleId || 
        existingSale.relatedBranchPurchaseId || 
        existingSale.relatedPurchaseFromParentId) {
      
      // ุญุฐู ูุงุชูุฑุฉ ุงูุดุฑูุฉ ุงูุฃู
      if (existingSale.relatedParentSaleId) {
        const parentSale = await this.prisma.sale.findUnique({
          where: { id: existingSale.relatedParentSaleId },
          include: { lines: true }
        });

        if (parentSale) {
          // ุฅุฑุฌุงุน ุงููุฎุฒูู
          for (const line of parentSale.lines) {
            await this.prisma.stock.update({
              where: {
                companyId_productId: {
                  companyId: parentSale.companyId,
                  productId: line.productId
                }
              },
              data: { boxes: { increment: Number(line.qty) } }
            });
          }

          // ุญุฐู ุงูุฃุณุทุฑ ูุงูุฏูุนุงุช ูุงููุงุชูุฑุฉ
          await this.prisma.saleLine.deleteMany({ where: { saleId: parentSale.id } });
          await this.prisma.salePayment.deleteMany({ where: { saleId: parentSale.id } });
          await this.prisma.sale.delete({ where: { id: parentSale.id } });
        }
      }

      // ุญุฐู ูุงุชูุฑุฉ ุงููุดุชุฑูุงุช
      if (existingSale.relatedBranchPurchaseId) {
        const branchPurchase = await this.prisma.purchase.findUnique({
          where: { id: existingSale.relatedBranchPurchaseId },
          include: { lines: true }
        });

        if (branchPurchase) {
          await this.prisma.purchaseLine.deleteMany({ where: { purchaseId: branchPurchase.id } });
          await this.prisma.purchasePayment.deleteMany({ where: { purchaseId: branchPurchase.id } });
          await this.prisma.purchase.delete({ where: { id: branchPurchase.id } });
        }
      }

      // ุญุฐู ุณุฌู PurchaseFromParent
      if (existingSale.relatedPurchaseFromParentId) {
        const purchaseFromParent = await this.prisma.purchaseFromParent.findUnique({
          where: { id: existingSale.relatedPurchaseFromParentId }
        });

        if (purchaseFromParent) {
          await this.prisma.purchaseFromParentLine.deleteMany({ 
            where: { purchaseId: purchaseFromParent.id } 
          });
          await this.prisma.purchaseFromParentReceipt.deleteMany({ 
            where: { purchaseId: purchaseFromParent.id } 
          });
          await this.prisma.purchaseFromParent.delete({ 
            where: { id: purchaseFromParent.id } 
          });
        }
      }
    }

    // 3. ุฅุฑุฌุงุน ูุฎุฒูู ุงููุงุชูุฑุฉ ุงูุฃุตููุฉ
    for (const line of existingSale.lines) {
      await this.prisma.stock.update({
        where: {
          companyId_productId: {
            companyId: existingSale.companyId,
            productId: line.productId
          }
        },
        data: { boxes: { increment: Number(line.qty) } }
      });
    }

    // 4. ุญุฐู ุงููุงุชูุฑุฉ ุงูุฃุตููุฉ
    await this.prisma.saleLine.deleteMany({ where: { saleId: id } });
    await this.prisma.salePayment.deleteMany({ where: { saleId: id } });
    await this.prisma.sale.delete({ where: { id } });

    return { message: 'ุชู ุญุฐู ุงููุงุชูุฑุฉ ูุฌููุน ุงูููุงุชูุฑ ุงููุฑุชุจุทุฉ ุจูุฌุงุญ' };
  } catch (error) {
    console.error('ุฎุทุฃ ูู ุญุฐู ุงููุงุชูุฑุฉ:', error);
    throw error;
  }
}
```

### 3. **ComplexInterCompanySaleService.ts - ุญูุธ ุงููุนุฑูุงุช:**

```typescript
// ุจุนุฏ ุฅูุดุงุก ุฌููุน ุงูููุงุชูุฑุ ูุชู ุญูุธ ุงููุนุฑูุงุช ูู ุงููุงุชูุฑุฉ ุงูุฃุตููุฉ
await this.prisma.sale.update({
  where: { id: customerSale.id },
  data: {
    relatedParentSaleId: parentSale?.id || null,
    relatedBranchPurchaseId: branchPurchase?.id || null,
    relatedPurchaseFromParentId: purchaseFromParent?.id || null
  }
});
```

---

## ๐ ุชุชุจุน ุงููุฎุฒูู

### ูุจู ุงูุญุฐู:
```
ูุฎุฒู ุงูุชูุงุฒู (ุงูุดุฑูุฉ ุงูุฃู):
  ุจูุงุท ABC-001: 100 ุตูุฏูู

ุตุงูุฉ ุงูุฅูุงุฑุงุช (ุงูุดุฑูุฉ ุงูุชุงุจุนุฉ):
  ุจูุงุท ABC-001: 50 ุตูุฏูู (ูุงู 0)
  ุณูุฑุงููู XYZ: 70 ุตูุฏูู
```

### ุจุนุฏ ุฅูุดุงุก ุงููุงุชูุฑุฉ ุงููุนูุฏุฉ:
```
ูุฎุฒู ุงูุชูุงุฒู:
  ุจูุงุท ABC-001: 50 ุตูุฏูู (-50) โ

ุตุงูุฉ ุงูุฅูุงุฑุงุช:
  ุจูุงุท ABC-001: 50 ุตูุฏูู (ูุง ุชุชุบูุฑ - affectsInventory = false)
  ุณูุฑุงููู XYZ: 40 ุตูุฏูู (-30) โ
```

### ุจุนุฏ ุงูุญุฐู:
```
ูุฎุฒู ุงูุชูุงุฒู:
  ุจูุงุท ABC-001: 100 ุตูุฏูู (+50) โ ุฑุฌุน ููุญุงูุฉ ุงูุฃุตููุฉ

ุตุงูุฉ ุงูุฅูุงุฑุงุช:
  ุจูุงุท ABC-001: 50 ุตูุฏูู (ูุง ุชุชุบูุฑ)
  ุณูุฑุงููู XYZ: 70 ุตูุฏูู (+30) โ ุฑุฌุน ููุญุงูุฉ ุงูุฃุตููุฉ
```

---

## ๐งช ุงุฎุชุจุงุฑ ุงูููุฒุฉ

### ุฎุทูุงุช ุงูุงุฎุชุจุงุฑ:

#### 1. ุฅูุดุงุก ูุงุชูุฑุฉ ูุนูุฏุฉ:
```bash
1. ุงูุชุญ ุดุงุดุฉ ุงููุจูุนุงุช
2. ุงุฎุชุฑ "ุตุงูุฉ ุงูุฅูุงุฑุงุช" ูุดุฑูุฉ
3. ุฃุถู ุฃุตูุงู ูู:
   - ูุฎุฒู ุงูุชูุงุฒู (ุงูุดุฑูุฉ ุงูุฃู)
   - ุตุงูุฉ ุงูุฅูุงุฑุงุช (ุงูุดุฑูุฉ ุงูุญุงููุฉ)
4. ุฃูุดุฆ ุงููุงุชูุฑุฉ
```

#### 2. ุชุญูู ูู ุฅูุดุงุก ุงูููุงุชูุฑ:
```sql
-- ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
SELECT id, invoiceNumber, companyId, total, 
       relatedParentSaleId, 
       relatedBranchPurchaseId, 
       relatedPurchaseFromParentId
FROM "Sale"
WHERE id = [ID ุงููุงุชูุฑุฉ];

-- ูุฌุจ ุฃู ุชุฑู:
-- relatedParentSaleId: [ุฑูู]
-- relatedBranchPurchaseId: [ุฑูู]
-- relatedPurchaseFromParentId: [ุฑูู]
```

#### 3. ุชุญูู ูู ุงููุฎุฒูู ูุจู ุงูุญุฐู:
```sql
SELECT * FROM "Stock" 
WHERE productId IN ([IDs ุงูุฃุตูุงู]);
```

#### 4. ุงุญุฐู ุงููุงุชูุฑุฉ:
```bash
1. ูู ุดุงุดุฉ ุงููุจูุนุงุช
2. ุงููุฑ ุนูู ุฒุฑ ุงูุญุฐู ูููุงุชูุฑุฉ
3. ุฃูุฏ ุงูุญุฐู
```

#### 5. ุชุญูู ูู ุงููุชุงุฆุฌ:
```sql
-- ุชุฃูุฏ ูู ุญุฐู ุฌููุน ุงูููุงุชูุฑ
SELECT * FROM "Sale" 
WHERE id IN ([ID ุงูุฃุตููุฉ], [ID ูุงุชูุฑุฉ ุงูุฃู]);
-- ูุฌุจ ุฃู ุชููู ุงููุชูุฌุฉ ูุงุฑุบุฉ

SELECT * FROM "Purchase" 
WHERE id = [ID ูุงุชูุฑุฉ ุงููุดุชุฑูุงุช];
-- ูุฌุจ ุฃู ุชููู ุงููุชูุฌุฉ ูุงุฑุบุฉ

SELECT * FROM "PurchaseFromParent" 
WHERE id = [ID ุงูุณุฌู];
-- ูุฌุจ ุฃู ุชููู ุงููุชูุฌุฉ ูุงุฑุบุฉ

-- ุชุญูู ูู ุฅุฑุฌุงุน ุงููุฎุฒูู
SELECT * FROM "Stock" 
WHERE productId IN ([IDs ุงูุฃุตูุงู]);
-- ูุฌุจ ุฃู ูููู ุงููุฎุฒูู ุฑุฌุน ูุญุงูุชู ุงูุฃุตููุฉ
```

---

## โ๏ธ ููุงุญุธุงุช ูููุฉ

### 1. **ุงูุฃูุงู:**
- โ ูุชุญูู ุงููุธุงู ูู ุตูุงุญูุฉ ุงููุณุชุฎุฏู ูุจู ุงูุญุฐู
- โ ูุณุชุฎุฏูู ุงููุธุงู ููุท ูููููู ุญุฐู ููุงุชูุฑ ุฃู ุดุฑูุฉ
- โ ุงููุณุชุฎุฏููู ุงูุนุงุฏููู ูููููู ุญุฐู ููุงุชูุฑ ุดุฑูุชูู ููุท

### 2. **ุงููุฎุฒูู:**
- โ ููุฑุฌุน ุงููุฎุฒูู ุชููุงุฆูุงู ูุฌููุน ุงูุดุฑูุงุช
- โ ูุงุชูุฑุฉ ุงููุดุชุฑูุงุช ูุง ุชุคุซุฑ ุนูู ุงููุฎุฒูู (`affectsInventory = false`)
- โ ูุชู ุชุญุฏูุซ `boxes` ูู ุฌุฏูู `Stock`

### 3. **ุงูุญุฐู ุงููุชุณูุณู:**
- โ ูุญุฐู ุฌููุน ุงูุฃุณุทุฑ (`SaleLine`, `PurchaseLine`)
- โ ูุญุฐู ุฌููุน ุงูุฏูุนุงุช (`SalePayment`, `PurchasePayment`)
- โ ูุญุฐู ุฌููุน ุงูุฅูุตุงูุงุช (`PurchaseFromParentReceipt`)
- โ ูุญุฐู ุงูููุงุชูุฑ ููุณูุง ุจุนุฏ ุญุฐู ูู ูุง ูุชุนูู ุจูุง

### 4. **ุงูุชุญูู:**
- โ ูุชุญูู ูู ูุฌูุฏ ูู ูุงุชูุฑุฉ ูุจู ูุญุงููุฉ ุญุฐููุง
- โ ูุชุฌุงูู ุงูููุงุชูุฑ ุบูุฑ ุงูููุฌูุฏุฉ ุจุฏูู ุฎุทุฃ
- โ ูุนุฑุถ ุฑุณุงุฆู console ููุชุชุจุน

---

## ๐ ุงุณุชูุดุงู ุงูุฃุฎุทุงุก

### ุฅุฐุง ูู ูุชู ุญุฐู ุงูููุงุชูุฑ ุงููุฑุชุจุทุฉ:

#### 1. **ุชุญูู ูู ุงูุญููู:**
```sql
SELECT relatedParentSaleId, 
       relatedBranchPurchaseId, 
       relatedPurchaseFromParentId
FROM "Sale"
WHERE id = [ID ุงููุงุชูุฑุฉ];
```
- ูุฌุจ ุฃู ุชููู ุงูููู ููุฌูุฏุฉ (ููุณุช NULL)

#### 2. **ุชุญูู ูู Backend Logs:**
```bash
# ูู terminal ุงูู backend
# ูุฌุจ ุฃู ุชุฑู:
๐๏ธ ุจุฏุก ุญุฐู ุงููุงุชูุฑุฉ ูุฌููุน ุงูููุงุชูุฑ ุงููุฑุชุจุทุฉ...
๐ ูุงุชูุฑุฉ ูุนูุฏุฉ - ุณูุชู ุญุฐู ุงูููุงุชูุฑ ุงููุฑุชุจุทุฉ
๐ ุญุฐู ูุงุชูุฑุฉ ุงูุดุฑูุฉ ุงูุฃู (ID: ...)...
โ ุชู ุญุฐู ูุงุชูุฑุฉ ุงูุดุฑูุฉ ุงูุฃู
๐ ุญุฐู ูุงุชูุฑุฉ ูุดุชุฑูุงุช ุงูุดุฑูุฉ ุงูุชุงุจุนุฉ (ID: ...)...
โ ุชู ุญุฐู ูุงุชูุฑุฉ ูุดุชุฑูุงุช ุงูุดุฑูุฉ ุงูุชุงุจุนุฉ
...
```

#### 3. **ุชุญูู ูู Database Constraints:**
```sql
-- ุชุฃูุฏ ูู ุนุฏู ูุฌูุฏ foreign key constraints ุชููุน ุงูุญุฐู
SELECT * FROM pg_constraint 
WHERE conname LIKE '%sale%' OR conname LIKE '%purchase%';
```

---

## ๐ ุงูุฅุญุตุงุฆูุงุช

| ุงูุนูููุฉ | ุงูููุช ุงููุชููุน | ุนุฏุฏ ุงูุงุณุชุนูุงูุงุช |
|---------|----------------|------------------|
| ุญุฐู ูุงุชูุฑุฉ ุจุณูุทุฉ | ~100ms | 5-10 |
| ุญุฐู ูุงุชูุฑุฉ ูุนูุฏุฉ | ~300ms | 20-30 |
| ุฅุฑุฌุงุน ุงููุฎุฒูู | ~50ms/ุตูู | 2/ุตูู |

---

## โ ุงูุฎูุงุตุฉ

ุงูููุฒุฉ **ููุฌูุฏุฉ ูุชุนูู ุจุงููุงูู**:

โ ุญุฐู ุฌููุน ุงูููุงุชูุฑ ุงููุฑุชุจุทุฉ ุชููุงุฆูุงู  
โ ุฅุฑุฌุงุน ุงููุฎุฒูู ูุฌููุน ุงูุดุฑูุงุช  
โ ุญุฐู ุฌููุน ุงูุฃุณุทุฑ ูุงูุฏูุนุงุช  
โ ุฑุณุงุฆู Console ููุชุชุจุน  
โ ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก  

**ูุง ุญุงุฌุฉ ูุฃู ุชุนุฏููุงุช - ุงูููุฒุฉ ุฌุงูุฒุฉ! ๐**

---

**ุงูุชุงุฑูุฎ:** 2025-11-04  
**ุงูุฅุตุฏุงุฑ:** ููุฌูุฏุฉ ููุฐ ุงูุจุฏุงูุฉ  
**ุงูุญุงูุฉ:** โ ูุดุทุฉ ูููุฎุชุจุฑุฉ  
**ูุฑุชุจุท ุจู:** `ComplexInterCompanySaleService.ts`, `SalesService.ts`

