# ุชุญุฏูุซ ููุทู ุชุนุฏูู ุงูููุงุชูุฑ ุงููุนูุฏุฉ

## ๐ฏ ุงูุชุบููุฑุงุช ุงููุทุจูุฉ

### 1. **ุชุญุฏูุซ ุงููููุฉ ููุท ูู ูุงุชูุฑุฉ ุงูุชูุงุฒู (ุงูุณุนุฑ ุซุงุจุช)**

ุนูุฏ ุชุนุฏูู ูุงุชูุฑุฉ ุงูุฅูุงุฑุงุช ุงูุชู ุชุญุชูู ุนูู ุฃุตูุงู ูู ุงูุชูุงุฒู:
- โ ูุงุชูุฑุฉ ุงูุฅูุงุฑุงุช: ูููู ุชุบููุฑ ุงููููุฉ ูุงูุณุนุฑ
- โ ูุงุชูุฑุฉ ุงูุชูุงุฒู: ุชุญุฏูุซ ุงููููุฉ ููุท (ุงูุณุนุฑ ูุจูู ุซุงุจุช - ุณุนุฑ ุงูุฌููุฉ)

---

### 2. **ุชุญุฏูุซ ูุงุชูุฑุฉ ุงููุดุชุฑูุงุช ุงููุฑุชุจุทุฉ**

ุนูุฏ ุชุนุฏูู ุงููุงุชูุฑุฉ ุงูุฃุตููุฉ:
- โ ุชุญุฏูุซ ูุงุชูุฑุฉ ุงูุชูุงุฒู (ุงูุจูุน ูู ุงูุชูุงุฒู โ ุงูุฅูุงุฑุงุช)
- โ ุชุญุฏูุซ ูุงุชูุฑุฉ ุงููุดุชุฑูุงุช (ุงูุดุฑุงุก ูู ุงูุชูุงุฒู ููุฅูุงุฑุงุช)

---

## ๐ ุงูุชูุงุตูู ุงููููุฉ

### **ุงูููู:** `server/src/services/SalesService.ts`

**ุงูุฏุงูุฉ:** `updateSale()`

**ุงูุณุทุฑ:** 618-706

---

### **ุงูููุฏ ุงููุฏูู:**

```typescript
// ุญุณุงุจ ุงููุฌููุน ุงูุฌุฏูุฏ ููุงุชูุฑุฉ ุงูุชูุงุฒู
for (const line of parentCompanyLines) {
  const product = updatedSale.lines.find(l => l.productId === line.productId)?.product;
  if (!product) continue;

  // โ ุงุณุชุฎุฏุงู ุงูุณุนุฑ ูู ุงููุงุชูุฑุฉ ุงูุฃุตููุฉ (ุงููุนุฏูุฉ)
  const lineTotal = line.qty * line.unitPrice;
  parentSaleTotal += lineTotal;

  parentSaleNewLines.push({
    productId: line.productId,
    qty: line.qty,
    unitPrice: line.unitPrice, // โ ุงูุณุนุฑ ุงูุฌุฏูุฏ ูู ูุงุชูุฑุฉ ุงูุฅูุงุฑุงุช
    subTotal: lineTotal
  });
}

// โ ูู ูุชู ุชุญุฏูุซ ูุงุชูุฑุฉ ุงููุดุชุฑูุงุช
```

---

### **ุงูููุฏ ุงูุฌุฏูุฏ:**

```typescript
// ุฌูุจ ูุงุชูุฑุฉ ุงูุชูุงุฒู ุงููุฏููุฉ ููุญุตูู ุนูู ุงูุฃุณุนุงุฑ ุงูุฃุตููุฉ (ุณุนุฑ ุงูุฌููุฉ ุงูุซุงุจุช)
const oldParentSale = await this.prisma.sale.findUnique({
  where: { id: existingSale.relatedParentSaleId },
  include: { lines: true }
});

// ุญุณุงุจ ุงููุฌููุน ุงูุฌุฏูุฏ ููุงุชูุฑุฉ ุงูุชูุงุฒู (ุงููููุฉ ููุทุ ุงูุณุนุฑ ุซุงุจุช)
for (const line of parentCompanyLines) {
  const product = updatedSale.lines.find(l => l.productId === line.productId)?.product;
  if (!product) continue;

  // โ ุงุณุชุฎุฏุงู ุงูุณุนุฑ ุงูุฃุตูู ูู ูุงุชูุฑุฉ ุงูุชูุงุฒู ุงููุฏููุฉ (ุณุนุฑ ุงูุฌููุฉ ุงูุซุงุจุช)
  const oldLine = oldParentSale.lines.find(l => l.productId === line.productId);
  const originalPrice = oldLine ? Number(oldLine.unitPrice) : line.unitPrice;
  
  // โ ุงููููุฉ ุงูุฌุฏูุฏุฉ ร ุงูุณุนุฑ ุงูุฃุตูู (ุงูุฌููุฉ)
  const lineTotal = line.qty * originalPrice;
  parentSaleTotal += lineTotal;

  parentSaleNewLines.push({
    productId: line.productId,
    qty: line.qty,
    unitPrice: originalPrice, // โ ุงูุณุนุฑ ุงูุฃุตูู (ุซุงุจุช)
    subTotal: lineTotal
  });
}

// ุชุญุฏูุซ ูุงุชูุฑุฉ ุงูุชูุงุฒู
await this.prisma.sale.update({
  where: { id: existingSale.relatedParentSaleId },
  data: {
    total: parentSaleTotal,
    lines: { create: parentSaleNewLines }
  }
});

// โ ุชุญุฏูุซ ูุงุชูุฑุฉ ุงููุดุชุฑูุงุช ุฃูุถุงู
if (existingSale.relatedBranchPurchaseId) {
  await this.prisma.purchaseLine.deleteMany({
    where: { purchaseId: existingSale.relatedBranchPurchaseId }
  });

  await this.prisma.purchase.update({
    where: { id: existingSale.relatedBranchPurchaseId },
    data: {
      total: parentSaleTotal,
      remainingAmount: parentSaleTotal,
      lines: {
        create: parentSaleNewLines.map(line => ({
          productId: line.productId,
          qty: line.qty,
          unitPrice: line.unitPrice,
          subTotal: line.subTotal
        }))
      }
    }
  });
}
```

---

## ๐งช ูุซุงู ุนููู

### ุงูุณููุงุฑูู:

**ุฅูุดุงุก ูุงุชูุฑุฉ ูุนูุฏุฉ:**
```
ูุงุชูุฑุฉ ุงูุฅูุงุฑุงุช (#100):
  - ุตูู ุงูุชูุงุฒู A: 10 ุตูุงุฏูู ร 100 ุฑ.ุณ = 1000 ุฑ.ุณ

ูุงุชูุฑุฉ ุงูุชูุงุฒู (#101):
  - ุตูู A: 10 ุตูุงุฏูู ร 80 ุฑ.ุณ (ุฌููุฉ) = 800 ุฑ.ุณ

ูุงุชูุฑุฉ ุงููุดุชุฑูุงุช (#50):
  - ุตูู A: 10 ุตูุงุฏูู ร 80 ุฑ.ุณ = 800 ุฑ.ุณ
```

---

### **ุงูุขู: ุชุนุฏูู ูุงุชูุฑุฉ ุงูุฅูุงุฑุงุช**

#### 1. **ุชุบููุฑ ุงููููุฉ:**

```
ูุงุชูุฑุฉ ุงูุฅูุงุฑุงุช (#100) - ุฌุฏูุฏุฉ:
  - ุตูู A: 15 ุตูุงุฏูู ร 100 ุฑ.ุณ = 1500 ุฑ.ุณ

โ ูุงุชูุฑุฉ ุงูุชูุงุฒู (#101) - ูุญุฏุซุฉ:
  - ุตูู A: 15 ุตูุงุฏูู ร 80 ุฑ.ุณ (ุซุงุจุช) = 1200 ุฑ.ุณ

โ ูุงุชูุฑุฉ ุงููุดุชุฑูุงุช (#50) - ูุญุฏุซุฉ:
  - ุตูู A: 15 ุตูุงุฏูู ร 80 ุฑ.ุณ = 1200 ุฑ.ุณ
```

**ุงููุชูุฌุฉ:**
- โ ุงููููุฉ ุชู ุชุญุฏูุซูุง ูู ุงูููุงุชูุฑ ุงูุซูุงุซ
- โ ุงูุณุนุฑ ูู ูุงุชูุฑุฉ ุงูุชูุงุฒู ูุงููุดุชุฑูุงุช ุจูู ุซุงุจุช (80 ุฑ.ุณ - ุณุนุฑ ุงูุฌููุฉ)

---

#### 2. **ุชุบููุฑ ุงูุณุนุฑ:**

```
ูุงุชูุฑุฉ ุงูุฅูุงุฑุงุช (#100) - ุฌุฏูุฏุฉ:
  - ุตูู A: 10 ุตูุงุฏูู ร 120 ุฑ.ุณ (ุฌุฏูุฏ) = 1200 ุฑ.ุณ

โ ูุงุชูุฑุฉ ุงูุชูุงุฒู (#101) - ูู ุชุชุบูุฑ:
  - ุตูู A: 10 ุตูุงุฏูู ร 80 ุฑ.ุณ (ุซุงุจุช) = 800 ุฑ.ุณ

โ ูุงุชูุฑุฉ ุงููุดุชุฑูุงุช (#50) - ูู ุชุชุบูุฑ:
  - ุตูู A: 10 ุตูุงุฏูู ร 80 ุฑ.ุณ = 800 ุฑ.ุณ
```

**ุงููุชูุฌุฉ:**
- โ ุงูุณุนุฑ ูู ูุงุชูุฑุฉ ุงูุฅูุงุฑุงุช ุชุบูุฑ ุฅูู 120 ุฑ.ุณ
- โ ุงูุณุนุฑ ูู ูุงุชูุฑุฉ ุงูุชูุงุฒู ูุงููุดุชุฑูุงุช ุจูู 80 ุฑ.ุณ (ุณุนุฑ ุงูุฌููุฉ ุงูุซุงุจุช)

---

#### 3. **ุชุบููุฑ ุงููููุฉ ูุงูุณุนุฑ ูุนุงู:**

```
ูุงุชูุฑุฉ ุงูุฅูุงุฑุงุช (#100) - ุฌุฏูุฏุฉ:
  - ุตูู A: 20 ุตูุงุฏูู ร 110 ุฑ.ุณ = 2200 ุฑ.ุณ

โ ูุงุชูุฑุฉ ุงูุชูุงุฒู (#101) - ูุญุฏุซุฉ:
  - ุตูู A: 20 ุตูุงุฏูู ร 80 ุฑ.ุณ (ุซุงุจุช) = 1600 ุฑ.ุณ

โ ูุงุชูุฑุฉ ุงููุดุชุฑูุงุช (#50) - ูุญุฏุซุฉ:
  - ุตูู A: 20 ุตูุงุฏูู ร 80 ุฑ.ุณ = 1600 ุฑ.ุณ
```

**ุงููุชูุฌุฉ:**
- โ ุงููููุฉ ุชู ุชุญุฏูุซูุง (20 ุตูุฏูู)
- โ ุงูุณุนุฑ ูู ูุงุชูุฑุฉ ุงูุฅูุงุฑุงุช ุชุบูุฑ (110 ุฑ.ุณ)
- โ ุงูุณุนุฑ ูู ูุงุชูุฑุฉ ุงูุชูุงุฒู ูุงููุดุชุฑูุงุช ุจูู ุซุงุจุช (80 ุฑ.ุณ)

---

## ๐ก ุงูููุงุฆุฏ

### 1. **ุณุนุฑ ุงูุฌููุฉ ุซุงุจุช:**
```
โ ุงูุชูุงุฒู ูุจูุน ููุฅูุงุฑุงุช ุจุณุนุฑ ุงูุฌููุฉ ุงูุซุงุจุช (80 ุฑ.ุณ)
โ ุงูุฅูุงุฑุงุช ุชุจูุน ููุนููู ุจุงูุณุนุฑ ุงูุฐู ุชุฑูุฏู (100/110/120 ุฑ.ุณ)
โ ุงููุงูุด ุงูุฑุจุญู ููุฅูุงุฑุงุช ูุฎุชูู ุญุณุจ ุงูุณุนุฑ ุงูุฐู ุชุญุฏุฏู
```

---

### 2. **ุชูุงุณู ุงูุจูุงูุงุช:**
```
โ ูุงุชูุฑุฉ ุงูุชูุงุฒู (ุงูุจูุน)
โ ูุงุชูุฑุฉ ุงููุดุชุฑูุงุช (ุงูุดุฑุงุก)
โ ููุณ ุงููููุฉุ ููุณ ุงูุณุนุฑ (ุณุนุฑ ุงูุฌููุฉ)
```

---

### 3. **ูุฑููุฉ ุงูุชุณุนูุฑ:**
```
โ ุงูุฅูุงุฑุงุช ูููููุง ุชุบููุฑ ุณุนุฑ ุงูุจูุน ููุนููู
โ ุณุนุฑ ุงูุดุฑุงุก ูู ุงูุชูุงุฒู ูุจูู ุซุงุจุช (ุชูููุฉ ุซุงุจุชุฉ)
```

---

## ๐ ุญุงูุฉ ุงููุธุงู

```
โ ุฅูุดุงุก ูุงุชูุฑุฉ ูุนูุฏุฉ: 3 ููุงุชูุฑ (DRAFT)
โ ุชุนุฏูู ูุงุชูุฑุฉ ุงูุฅูุงุฑุงุช:
   - ุงููููุฉ: ุชูุญุฏุซ ูู ุงูููุงุชูุฑ ุงูุซูุงุซ โ
   - ุงูุณุนุฑ ูู ุงูุฅูุงุฑุงุช: ูููู ุชุบููุฑู โ
   - ุงูุณุนุฑ ูู ุงูุชูุงุฒู: ุซุงุจุช (ุณุนุฑ ุงูุฌููุฉ) โ
   - ุงูุณุนุฑ ูู ุงููุดุชุฑูุงุช: ุซุงุจุช (ุณุนุฑ ุงูุฌููุฉ) โ
โ ุชุญุฏูุซ ูุงุชูุฑุฉ ุงููุดุชุฑูุงุช: ุชููุงุฆูุงู ูุน ูุงุชูุฑุฉ ุงูุชูุงุฒู
โ ุญุฐู ูุชุณูุณู: ูุนูู
โ ุงุนุชูุงุฏ ุงูููุงุชูุฑ: ูุนูู
โ ุงูุฎุงุฏู: ูุนูู ุนูู ุงููููุฐ 4000
```

---

## ๐ ููุงุญุธุงุช ุชูููุฉ

### 1. **ุงุณุชุฎุฏุงู `oldParentSale`:**
```typescript
const oldParentSale = await this.prisma.sale.findUnique({
  where: { id: existingSale.relatedParentSaleId },
  include: { lines: true }
});
```
- ูุฌูุจ ุงููุงุชูุฑุฉ ุงููุฏููุฉ ููุญุตูู ุนูู ุงูุฃุณุนุงุฑ ุงูุฃุตููุฉ

---

### 2. **ุงูุจุญุซ ุนู ุงูุณุนุฑ ุงูุฃุตูู:**
```typescript
const oldLine = oldParentSale.lines.find(l => l.productId === line.productId);
const originalPrice = oldLine ? Number(oldLine.unitPrice) : line.unitPrice;
```
- ุฅุฐุง ูุฌุฏูุง ุงูุตูู ูู ุงููุงุชูุฑุฉ ุงููุฏููุฉ โ ูุณุชุฎุฏู ุณุนุฑู ุงูุฃุตูู
- ุฅุฐุง ูู ูุฌุฏู (ุตูู ุฌุฏูุฏ) โ ูุณุชุฎุฏู ุงูุณุนุฑ ุงูุฌุฏูุฏ

---

### 3. **ุชุญุฏูุซ ูุงุชูุฑุฉ ุงููุดุชุฑูุงุช:**
```typescript
if (existingSale.relatedBranchPurchaseId) {
  // ุญุฐู ุงูุจููุฏ ุงููุฏููุฉ
  await this.prisma.purchaseLine.deleteMany({...});
  
  // ุฅูุดุงุก ุจููุฏ ุฌุฏูุฏุฉ (ููุณ ุจููุฏ ูุงุชูุฑุฉ ุงูุชูุงุฒู)
  await this.prisma.purchase.update({...});
}
```
- ูุณุชุฎุฏู ููุณ ุงูุจูุงูุงุช ูู `parentSaleNewLines`
- ุงููููุฉ ูุงูุณุนุฑ ูุชุทุงุจูุงู ูุน ูุงุชูุฑุฉ ุงูุชูุงุฒู

---

## ๐ ุงููููุงุช ุงููุนุฏูุฉ

```
โ server/src/services/SalesService.ts
   - ุฏุงูุฉ updateSale()
   - ุงูุณุทูุฑ 618-706
   - ุฅุถุงูุฉ:
     * ุฌูุจ ูุงุชูุฑุฉ ุงูุชูุงุฒู ุงููุฏููุฉ
     * ุงุณุชุฎุฏุงู ุงูุณุนุฑ ุงูุฃุตูู (ุงูุซุงุจุช)
     * ุชุญุฏูุซ ูุงุชูุฑุฉ ุงููุดุชุฑูุงุช
```

---

**ุชุงุฑูุฎ ุงูุชุญุฏูุซ:** 5 ููููุจุฑ 2025  
**ุงูุญุงูุฉ:** โ ููุทุจูู ููุนูู  
**ุงูุชุฃุซูุฑ:** 
- ๐ฐ ุณุนุฑ ุงูุฌููุฉ ูู ุงูุชูุงุฒู ุซุงุจุช (ูุง ูุชุฃุซุฑ ุจุชุนุฏูู ุณุนุฑ ุงูุฅูุงุฑุงุช)
- ๐ ุชุญุฏูุซ ุชููุงุฆู ููุงุชูุฑุฉ ุงููุดุชุฑูุงุช
- โ ุชูุงุณู ุงูุจูุงูุงุช ุจูู ููุงุชูุฑ ุงูุจูุน ูุงูุดุฑุงุก

