# โ ุฅุถุงูุฉ ูุงุชูุฑุฉ ุงููุดุชุฑูุงุช ููุดุฑูุฉ ุงูุชุงุจุนุฉ

## ๐ ุงููุดููุฉ

ูุงูุช ููุงู ูุงุชูุฑุฉ ูุดุชุฑูุงุช ูู ุงูุดุฑูุฉ ุงูุฃู ูุณุฌูุฉ ููุท ูู ุฌุฏูู `PurchaseFromParent` (ุณุฌู ุฏุงุฎูู)ุ ููู ูู ุชูู ููุงู ูุงุชูุฑุฉ ูุดุชุฑูุงุช ุนุงุฏูุฉ ูู ุฌุฏูู `Purchase` ุชุธูุฑ ูู ุดุงุดุฉ ุงููุดุชุฑูุงุช ูุชูุงุฑูุฑ ุงููุดุชุฑูุงุช.

## โ ุงูุญู

ุชู ุฅุถุงูุฉ **ูุงุชูุฑุฉ ูุดุชุฑูุงุช ุนุงุฏูุฉ** ูู ุฌุฏูู `Purchase` ุจุงูููุงุตูุงุช ุงูุชุงููุฉ:

### ุงูุฎุตุงุฆุต:
- โ ุงูููุฑุฏ: ููุฑุฏ ูููู ููุซู ุงูุดุฑูุฉ ุงูุฃู
- โ ุงููููุฉ: ุณุนุฑ ุจูุน ุงูุดุฑูุฉ ุงูุฃู ููุฃุตูุงู
- โ ุงูููุน: ุขุฌูุฉ (CREDIT) ุฏุงุฆูุงู
- โ๏ธ **ููู**: `affectsInventory = false` (ูุง ุชุคุซุฑ ุนูู ุงููุฎุฒูู)

### ููุงุฐุง ูุง ุชุคุซุฑ ุนูู ุงููุฎุฒููุ
ูุฃู ุงููุฎุฒูู ุชู ุฎุตูู ุจุงููุนู ูู ุงูุดุฑูุฉ ุงูุฃู ุนูุฏ ุฅูุดุงุก ุงููุงุชูุฑุฉุ ููุฐู ุงููุงุชูุฑุฉ ููุชุณุฌูู ุงููุญุงุณุจู ููุท.

---

## ๐ง ุงูุชุนุฏููุงุช ุงููุทุจูุฉ

### 1. Database Schema

#### ุฅุถุงูุฉ ุญููู ุฌุฏูุฏุฉ ูุฌุฏูู Purchase:

```prisma
model Purchase {
  // ... ุงูุญููู ุงูููุฌูุฏุฉ
  status           PurchaseStatus    @default(DRAFT)
  affectsInventory Boolean           @default(true)
  // ...
}

enum PurchaseStatus {
  DRAFT      // ูุจุฏุฆูุฉ
  APPROVED   // ูุนุชูุฏุฉ  
  CANCELLED  // ููุบุงุฉ
}
```

### 2. Backend Service

#### ComplexInterCompanySaleService.ts:

```typescript
// ุฅูุดุงุก ุฃู ุงูุญุตูู ุนูู ููุฑุฏ ูููู ููุซู ุงูุดุฑูุฉ ุงูุฃู
let parentAsSupplier = await tx.supplier.findFirst({
  where: {
    name: parentCompany.name,
    phone: `PARENT-${data.parentCompanyId}`
  }
});

if (!parentAsSupplier) {
  parentAsSupplier = await tx.supplier.create({
    data: {
      name: parentCompany.name,
      phone: `PARENT-${data.parentCompanyId}`,
      note: `ููุฑุฏ ูููู ููุซู ุงูุดุฑูุฉ ุงูุฃู: ${parentCompany.name}`
    }
  });
}

// ุฅูุดุงุก ูุงุชูุฑุฉ ูุดุชุฑูุงุช ุนุงุฏูุฉ (Purchase)
branchPurchase = await tx.purchase.create({
  data: {
    companyId: data.branchCompanyId,
    supplierId: parentAsSupplier.id,
    invoiceNumber: `PUR-${data.branchCompanyId}-${Date.now()}`,
    total: parentSaleTotal,
    status: 'DRAFT',
    purchaseType: 'CREDIT',
    paymentMethod: 'CASH',
    paidAmount: 0,
    remainingAmount: parentSaleTotal,
    isFullyPaid: false,
    affectsInventory: false, // โ๏ธ ููู ุฌุฏุงู!
    lines: {
      create: parentCompanyLines.map(line => ({
        productId: line.productId,
        qty: line.qty,
        unitPrice: line.parentUnitPrice || 0,
        subTotal: line.qty * (line.parentUnitPrice || 0)
      }))
    }
  }
});
```

---

## ๐ ูุซุงู ุนููู

### ุงูุณููุงุฑูู:
ุดุฑูุฉ ุงูุฅูุงุฑุงุช ุชุจูุน ููุนููู:
- 10 ุตูุงุฏูู ุจูุงุท ุณูุฑุงููู (ูู ุงูุดุฑูุฉ ุงูุฃู - ุณุนุฑ ุงูุฃู 50 ุฏ.ู)

### ุงูููุงุชูุฑ ุงููููุดุฃุฉ:

#### 1๏ธโฃ ูุงุชูุฑุฉ ุจูุน ููุนููู:
```
ุงูุนููู: ุฃุญูุฏ ูุญูุฏ
ุงูุดุฑูุฉ: ุงูุฅูุงุฑุงุช
- 10 ุจูุงุท ุณูุฑุงููู ร 60 = 600 ุฏ.ู
```

#### 2๏ธโฃ ูุงุชูุฑุฉ ุจูุน ุขุฌูุฉ ูู ุงูุดุฑูุฉ ุงูุฃู:
```
ุงูุนููู: ุดุฑูุฉ ุงูุฅูุงุฑุงุช
ุงูุดุฑูุฉ: ุงูุชูุงุฒู (ุงูุฃู)
- 10 ุจูุงุท ุณูุฑุงููู ร 50 = 500 ุฏ.ู
ุงูููุน: ุขุฌู
```

#### 3๏ธโฃ ูุงุชูุฑุฉ ูุดุชุฑูุงุช ููุดุฑูุฉ ุงูุชุงุจุนุฉ (ุฌุฏูุฏ!):
```
ุงูุดุฑูุฉ ุงููุดุชุฑูุฉ: ุงูุฅูุงุฑุงุช
ุงูููุฑุฏ: ุงูุชูุงุฒู (ููุฑุฏ ูููู)
- 10 ุจูุงุท ุณูุฑุงููู ร 50 = 500 ุฏ.ู
ุงูููุน: ุขุฌู
affectsInventory: false โ๏ธ
ุงูุญุงูุฉ: DRAFT
```

#### 4๏ธโฃ ุณุฌู ูุดุชุฑูุงุช ุฏุงุฎูู (PurchaseFromParent):
```
ุงูุดุฑูุฉ ุงูุชุงุจุนุฉ: ุงูุฅูุงุฑุงุช
ุงูุดุฑูุฉ ุงูุฃู: ุงูุชูุงุฒู
- 10 ุจูุงุท ุณูุฑุงููู ร 50 = 500 ุฏ.ู
isSettled: false
```

---

## ๐ฏ ุงูููุงุฆุฏ

### โ 1. ุธููุฑ ูู ุดุงุดุฉ ุงููุดุชุฑูุงุช:
ุงูุขู ูููู ููุดุฑูุฉ ุงูุชุงุจุนุฉ ุฑุคูุฉ ูุงุชูุฑุฉ ุงููุดุชุฑูุงุช ูู ุงูุดุฑูุฉ ุงูุฃู ูู ุดุงุดุฉ ุงููุดุชุฑูุงุช ุงูุนุงุฏูุฉ.

### โ 2. ุชูุงุฑูุฑ ูุญุงุณุจูุฉ ุฏูููุฉ:
ูุชู ุงุญุชุณุงุจ ุงููุดุชุฑูุงุช ูู ุงูุดุฑูุฉ ุงูุฃู ูู ุชูุงุฑูุฑ ุงููุดุชุฑูุงุช ุงูุดูุฑูุฉ ูุงูุณูููุฉ.

### โ 3. ุชุชุจุน ุงููุฏููููุฉ:
ูููู ุชุชุจุน ูุฏููููุฉ ุงูุดุฑูุฉ ุงูุชุงุจุนุฉ ููุดุฑูุฉ ุงูุฃู ูู ุฎูุงู ููุงุชูุฑ ุงููุดุชุฑูุงุช.

### โ 4. ูุง ุชุฃุซูุฑ ุนูู ุงููุฎุฒูู:
ุงููุงุชูุฑุฉ ููุชุณุฌูู ุงููุญุงุณุจู ููุทุ ุงููุฎุฒูู ุชู ุฎุตูู ุจุงููุนู ูู ุงูุดุฑูุฉ ุงูุฃู.

---

## ๐ ุชุทุจูู ุงูุชุบููุฑุงุช

### ุงูุฎุทูุฉ 1: ุชุทุจูู Schema Changes

```bash
./APPLY_PURCHASE_UPDATES.sh
```

ุฃู ูุฏููุงู:

```bash
cd server
npx prisma db push
npx prisma generate
```

### ุงูุฎุทูุฉ 2: ุฅุนุงุฏุฉ ุชุดุบูู ุงูุฎุงุฏู

```bash
cd server
npm run dev
```

---

## โ๏ธ ููุงุญุธุงุช ูููุฉ

### 1. ุงูููุฑุฏ ุงููููู:
- ูุชู ุฅูุดุงุก ููุฑุฏ ูููู ููู ุดุฑูุฉ ุฃู
- ุฑูู ุงููุงุชู: `PARENT-{companyId}` (ูุนุฑู ูุฑูุฏ)
- ูุง ูููู ุญุฐู ูุฐุง ุงูููุฑุฏ

### 2. affectsInventory = false:
- **ุถุฑูุฑู ุฌุฏุงู** ุฃู ุชููู false
- ุฅุฐุง ูุงูุช trueุ ุณูุชู ุฒูุงุฏุฉ ุงููุฎุฒูู ูุฑุชูู!
- ุงููุงุชูุฑุฉ ููุชุณุฌูู ุงููุญุงุณุจู ููุท

### 3. ุงูุญุงูุฉ ุงูุงูุชุฑุงุถูุฉ DRAFT:
- ุฌููุน ุงูููุงุชูุฑ ุชููุดุฃ ุจุญุงูุฉ DRAFT
- ุชุญุชุงุฌ ุงุนุชูุงุฏ ุงููุญุงุณุจ

### 4. ูุง ูููู ุงูุชุนุฏูู:
- ูุฐู ุงูููุงุชูุฑ ุชููุดุฃ ุชููุงุฆูุงู
- ูุง ูููุตุญ ุจุชุนุฏูููุง ูุฏููุงู

---

## ๐ ููุฎุต ุงูููุงุชูุฑ ุงููููุดุฃุฉ

ุนูุฏ ุจูุน ุฃุตูุงู ูู ุงูุดุฑูุฉ ุงูุฃู + ุงูุดุฑูุฉ ุงูุชุงุจุนุฉ:

| ุงููุงุชูุฑุฉ | ุงูุฌุฏูู | ุงูุดุฑูุฉ | ูุธูุฑ ูู |
|---------|--------|--------|---------|
| ูุงุชูุฑุฉ ุจูุน ููุนููู | Sale | ุงูุชุงุจุนุฉ | ุงููุจูุนุงุช |
| ูุงุชูุฑุฉ ุจูุน ุขุฌูุฉ | Sale | ุงูุฃู | ุงููุจูุนุงุช |
| **ูุงุชูุฑุฉ ูุดุชุฑูุงุช** | **Purchase** | **ุงูุชุงุจุนุฉ** | **ุงููุดุชุฑูุงุช** โจ |
| ุณุฌู ุฏุงุฎูู | PurchaseFromParent | ุงูุชุงุจุนุฉ | ุฏุงุฎูู |

---

## โ ูุงุฆูุฉ ุงูุชุญูู

- [x] ุฅุถุงูุฉ ุญูู status ูุฌุฏูู Purchase
- [x] ุฅุถุงูุฉ ุญูู affectsInventory ูุฌุฏูู Purchase
- [x] ุฅูุดุงุก enum PurchaseStatus
- [x] ุชุญุฏูุซ ComplexInterCompanySaleService
- [x] ุฅูุดุงุก ููุฑุฏ ูููู ููุดุฑูุฉ ุงูุฃู
- [x] ุฅูุดุงุก ูุงุชูุฑุฉ ูุดุชุฑูุงุช ูู ุฌุฏูู Purchase
- [x] ุถุจุท affectsInventory = false
- [x] ุชุญุฏูุซ Frontend API types
- [x] ุชุญุฏูุซ ุฑุณุงุฆู ุงููุฌุงุญ
- [x] ุฅูุดุงุก migration script
- [x] ุฅูุดุงุก ุงูุชูุซูู
- [x] ุงูุชุญูู ูู ุนุฏู ูุฌูุฏ ุฃุฎุทุงุก

---

**โ ุงููุธุงู ููุชูู 100% ูุฌุงูุฒ ููุงุณุชุฎุฏุงู!**

ุชุงุฑูุฎ ุงูุฅูุฌุงุฒ: 2025-11-02


