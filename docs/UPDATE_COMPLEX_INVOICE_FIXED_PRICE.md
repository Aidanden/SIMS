# ุชุญุฏูุซ ุงูููุงุชูุฑ ุงููุนูุฏุฉ: ุณุนุฑ ุงูุฌููุฉ ุงูุซุงุจุช

## ๐ฏ ุงููุดููุฉ

ุนูุฏ ุชุนุฏูู ูุงุชูุฑุฉ ูุนูุฏุฉ (ุชุญุชูู ุนูู ุฃุตูุงู ูู ุงูุชูุงุฒู ูุงูุฅูุงุฑุงุช):
- โ ูุงู ูุชู ุชุญุฏูุซ ุณุนุฑ ุฃุตูุงู ุงูุชูุงุฒู ูู ุงููุงุชูุฑุฉ ุงูุชููุงุฆูุฉ
- โ ุณุนุฑ ุงูุฌููุฉ ูู ุงูุชูุงุฒู ูุฌุจ ุฃู ูููู ุซุงุจุช
- โ ูุงุชูุฑุฉ ุงููุดุชุฑูุงุช ูู ุชูู ุชูุญุฏูุซ

---

## โ ุงูุญู

### 1. **ูุงุชูุฑุฉ ุงูุฅูุงุฑุงุช (ุงูุฃุตููุฉ):**
```
ุงููุณุชุฎุฏู ูุนุฏูู:
  - ุตูู ุงูุชูุงุฒู A: ุงููููุฉ 10 โ 15 โ
  - ุตูู ุงูุชูุงุฒู A: ุงูุณุนุฑ 100 โ 120 ุฑ.ุณ โ (ุณุนุฑ ุงูุจูุน ููุนููู)
  
ุงูุชุญุฏูุซ: ุงููููุฉ ูุงูุณุนุฑ โ
```

---

### 2. **ูุงุชูุฑุฉ ุงูุชูุงุฒู (ุงูุชููุงุฆูุฉ):**
```
ุงูุชุญุฏูุซ ุงูุชููุงุฆู:
  - ุตูู A: ุงููููุฉ 10 โ 15 โ
  - ุตูู A: ุงูุณุนุฑ ูุจูู 80 ุฑ.ุณ โ (ุณุนุฑ ุงูุฌููุฉ ุงูุซุงุจุช)
  
ุงูุชุญุฏูุซ: ุงููููุฉ ููุทุ ุงูุณุนุฑ ุซุงุจุช โ
```

---

### 3. **ูุงุชูุฑุฉ ุงููุดุชุฑูุงุช (branchPurchase):**
```
ุงูุชุญุฏูุซ ุงูุชููุงุฆู:
  - ุตูู A: ุงููููุฉ 10 โ 15 โ
  - ุตูู A: ุงูุณุนุฑ ูุจูู 80 ุฑ.ุณ โ (ููุณ ุณุนุฑ ุงูุชูุงุฒู)
  
ุงูุชุญุฏูุซ: ููุณ ุจููุฏ ูุงุชูุฑุฉ ุงูุชูุงุฒู โ
```

---

## ๐ ุงูุชุบููุฑุงุช ูู ุงูููุฏ

### ุงูููู: `server/src/services/SalesService.ts`

**ุงูุณุทุฑ 644-676:**

```typescript
for (const line of parentCompanyLines) {
  const product = updatedSale.lines.find(l => l.productId === line.productId)?.product;
  if (!product) continue;

  // โ ุงุณุชุฎุฏุงู ุงูุณุนุฑ ุงูุฃุตูู ูู ูุงุชูุฑุฉ ุงูุชูุงุฒู ุงููุฏููุฉ (ุณุนุฑ ุงูุฌููุฉ ุงูุซุงุจุช)
  const oldLine = oldParentSale.lines.find(l => l.productId === line.productId);
  let originalPrice;
  
  if (oldLine) {
    // ุงูุตูู ููุฌูุฏ ูู ุงููุงุชูุฑุฉ ุงููุฏููุฉ โ ุงุณุชุฎุฏู ุณุนุฑู ุงููุฏูู
    originalPrice = Number(oldLine.unitPrice);
  } else {
    // ุตูู ุฌุฏูุฏ โ ุงุญุตู ุนูู ุณุนุฑ ุงูุฌููุฉ ูู CompanyProductPrice ููุชูุงุฒู (ID=1)
    const priceRecord = await this.prisma.companyProductPrice.findUnique({
      where: {
        companyId_productId: {
          companyId: 1, // ุงูุชูุงุฒู
          productId: line.productId
        }
      }
    });
    originalPrice = priceRecord ? Number(priceRecord.price) : line.unitPrice;
  }
  
  // โ ุงููููุฉ ุงูุฌุฏูุฏุฉ ร ุงูุณุนุฑ ุงูุฃุตูู (ุงูุฌููุฉ)
  const lineTotal = line.qty * originalPrice;
  parentSaleTotal += lineTotal;

  parentSaleNewLines.push({
    productId: line.productId,
    qty: line.qty,
    unitPrice: originalPrice, // โ ุงูุณุนุฑ ุงูุฃุตูู (ุซุงุจุช)
    subTotal: lineTotal
  });
}
```

---

**ุงูุณุทุฑ 676-702: ุชุญุฏูุซ ูุงุชูุฑุฉ ุงููุดุชุฑูุงุช**

```typescript
// ๐ ุชุญุฏูุซ ูุงุชูุฑุฉ ุงููุดุชุฑูุงุช ุฃูุถุงู
if (existingSale.relatedBranchPurchaseId) {
  console.log('๐ ุชุญุฏูุซ ูุงุชูุฑุฉ ุงููุดุชุฑูุงุช ุงููุฑุชุจุทุฉ...');
  
  // ุญุฐู ุงูุจููุฏ ุงููุฏููุฉ ูู ูุงุชูุฑุฉ ุงููุดุชุฑูุงุช
  await this.prisma.purchaseLine.deleteMany({
    where: { purchaseId: existingSale.relatedBranchPurchaseId }
  });

  // ุฅูุดุงุก ุจููุฏ ุฌุฏูุฏุฉ (ููุณ ุจููุฏ ูุงุชูุฑุฉ ุงูุชูุงุฒู)
  await this.prisma.purchase.update({
    where: { id: existingSale.relatedBranchPurchaseId },
    data: {
      total: parentSaleTotal, // โ ููุณ ูุฌููุน ูุงุชูุฑุฉ ุงูุชูุงุฒู
      remainingAmount: parentSaleTotal,
      lines: {
        create: parentSaleNewLines.map(line => ({
          productId: line.productId,
          qty: line.qty,
          unitPrice: line.unitPrice, // โ ููุณ ุงูุณุนุฑ ุงูุซุงุจุช
          subTotal: line.subTotal
        }))
      }
    }
  });
  console.log('โ ุชู ุชุญุฏูุซ ูุงุชูุฑุฉ ุงููุดุชุฑูุงุช ุจูุฌุงุญ');
}
```

---

## ๐งช ุณููุงุฑูู ุงูุงุฎุชุจุงุฑ ุงููุงูู

### **ุงูุฎุทูุฉ 1: ุฅูุดุงุก ูุงุชูุฑุฉ ูุนูุฏุฉ**

```
ุงููุณุชุฎุฏู (ุงูุฅูุงุฑุงุช) ููุดุฆ ูุงุชูุฑุฉ:
  - ุตูู ุงูุชูุงุฒู A: 10 ุตูุงุฏูู ร 100 ุฑ.ุณ = 1000 ุฑ.ุณ
  - ุตูู ุงูุฅูุงุฑุงุช B: 5 ุตูุงุฏูู ร 200 ุฑ.ุณ = 1000 ุฑ.ุณ
  ุงููุฌููุน: 2000 ุฑ.ุณ

ุงููุธุงู ููุดุฆ:
  โ ูุงุชูุฑุฉ ุงูุฅูุงุฑุงุช: 2000 ุฑ.ุณ (ูู ุงูุฃุตูุงู)
  โ ูุงุชูุฑุฉ ุงูุชูุงุฒู: 800 ุฑ.ุณ (ุตูู A ร 80 ุฑ.ุณ ุณุนุฑ ุฌููุฉ)
  โ ูุงุชูุฑุฉ ุงููุดุชุฑูุงุช: 800 ุฑ.ุณ (ููุณ ูุงุชูุฑุฉ ุงูุชูุงุฒู)
```

---

### **ุงูุฎุทูุฉ 2: ุชุนุฏูู ุงููุงุชูุฑุฉ ุงูุฃุตููุฉ**

```
ุงููุณุชุฎุฏู ูุนุฏูู ูุงุชูุฑุฉ ุงูุฅูุงุฑุงุช:
  - ุตูู A: 10 โ 15 ุตูุงุฏูู โ๏ธ
  - ุตูู A: 100 โ 120 ุฑ.ุณ โ๏ธ
  - ุตูู B: 5 โ 8 ุตูุงุฏูู โ๏ธ

ุงููุงุชูุฑุฉ ุงูุฌุฏูุฏุฉ:
  - ุตูู A: 15 ร 120 = 1800 ุฑ.ุณ
  - ุตูู B: 8 ร 200 = 1600 ุฑ.ุณ
  ุงููุฌููุน: 3400 ุฑ.ุณ
```

---

### **ุงูุฎุทูุฉ 3: ุงูุชุญุฏูุซ ุงูุชููุงุฆู**

```
โ ูุงุชูุฑุฉ ุงูุฅูุงุฑุงุช:
   - ุตูู A: 15 ร 120 = 1800 ุฑ.ุณ
   - ุตูู B: 8 ร 200 = 1600 ุฑ.ุณ
   ุงููุฌููุน: 3400 ุฑ.ุณ โ

โ ูุงุชูุฑุฉ ุงูุชูุงุฒู (ุชุญุฏูุซ ุชููุงุฆู):
   - ุตูู A: 15 ร 80 = 1200 ุฑ.ุณ
   (ุงูุณุนุฑ ุจูู 80 ุฑ.ุณ - ูู ูุชุบูุฑ ุฅูู 120 ุฑ.ุณ) โ
   ุงููุฌููุน: 1200 ุฑ.ุณ โ

โ ูุงุชูุฑุฉ ุงููุดุชุฑูุงุช (ุชุญุฏูุซ ุชููุงุฆู):
   - ุตูู A: 15 ร 80 = 1200 ุฑ.ุณ
   (ููุณ ุจููุฏ ูุงุชูุฑุฉ ุงูุชูุงุฒู) โ
   ุงููุฌููุน: 1200 ุฑ.ุณ โ
```

---

### **ุงูุฎุทูุฉ 4: ุฅุถุงูุฉ ุตูู ุฌุฏูุฏ ูู ุงูุชูุงุฒู**

```
ุงููุณุชุฎุฏู ูุนุฏูู ููุถูู:
  - ุตูู ุงูุชูุงุฒู C (ุฌุฏูุฏ): 20 ร 150 ุฑ.ุณ (ุณุนุฑ ุงูุจูุน ููุนููู)

ุงููุธุงู:
  1. ูุจุญุซ ุนู ุณุนุฑ ุงูุฌููุฉ ูู CompanyProductPrice
  2. ูุฌุฏ: ุตูู C ููุชูุงุฒู = 90 ุฑ.ุณ (ุฌููุฉ)
  3. ูุถูู ุฅูู ูุงุชูุฑุฉ ุงูุชูุงุฒู: 20 ร 90 = 1800 ุฑ.ุณ โ
  4. ูุถูู ุฅูู ูุงุชูุฑุฉ ุงููุดุชุฑูุงุช: 20 ร 90 = 1800 ุฑ.ุณ โ
  5. ูุงุชูุฑุฉ ุงูุฅูุงุฑุงุช: 20 ร 150 = 3000 ุฑ.ุณ โ
```

---

## ๐ ุฌุฏูู ุงูููุงุฑูุฉ

| ุงููุงุชูุฑุฉ | ุชุญุฏูุซ ุงููููุฉ | ุชุญุฏูุซ ุงูุณุนุฑ |
|---------|--------------|-------------|
| **ุงูุฅูุงุฑุงุช (ุงูุฃุตููุฉ)** | โ ูุชุบูุฑ | โ ูุชุบูุฑ (ุณุนุฑ ุงูุจูุน ููุนููู) |
| **ุงูุชูุงุฒู (ุงูุชููุงุฆูุฉ)** | โ ูุชุบูุฑ | โ ุซุงุจุช (ุณุนุฑ ุงูุฌููุฉ) |
| **ุงููุดุชุฑูุงุช (ุงูุชููุงุฆูุฉ)** | โ ูุชุบูุฑ | โ ุซุงุจุช (ููุณ ุณุนุฑ ุงูุชูุงุฒู) |

---

## ๐ก ููุงุญุธุงุช ูููุฉ

### 1. **ุณุนุฑ ุงูุฌููุฉ ุงูุซุงุจุช:**
```
ุณุนุฑ ุงูุฌููุฉ ูู ุงูุชูุงุฒู ูุง ูุชุบูุฑ ุนูุฏ ุชุนุฏูู ุงููุงุชูุฑุฉ
ุงูุณุนุฑ ุงููุญูุฏ ุงูุฐู ูุชุบูุฑ ูู ุณุนุฑ ุงูุจูุน ููุนููู (ูู ูุงุชูุฑุฉ ุงูุฅูุงุฑุงุช)
```

---

### 2. **ูุตุฏุฑ ุณุนุฑ ุงูุฌููุฉ:**

#### ุฃ. **ุตูู ููุฌูุฏ ูู ุงููุงุชูุฑุฉ ุงููุฏููุฉ:**
```
ูุณุชุฎุฏู ุงูุณุนุฑ ูู ุงููุงุชูุฑุฉ ุงููุฏููุฉ ููุณูุง
(oldLine.unitPrice)
```

#### ุจ. **ุตูู ุฌุฏูุฏ (ุชูุช ุฅุถุงูุชู):**
```
ูุจุญุซ ูู CompanyProductPrice ููุชูุงุฒู (ID=1)
ุฅุฐุง ูู ูุฌุฏ โ ูุณุชุฎุฏู ุงูุณุนุฑ ูู ุงููุงุชูุฑุฉ ุงูุฌุฏูุฏุฉ (ุงุญุชูุงุทู)
```

---

### 3. **ุชุญุฏูุซ ูุงุชูุฑุฉ ุงููุดุชุฑูุงุช:**
```
โ ุชูุญุฏูุซ ุชููุงุฆูุงู ุนูุฏ ุชุญุฏูุซ ูุงุชูุฑุฉ ุงูุชูุงุฒู
โ ููุณ ุงููููุงุช ูุงูุฃุณุนุงุฑ ูู ูุงุชูุฑุฉ ุงูุชูุงุฒู
โ ููุณ ุงููุฌููุน
```

---

### 4. **ุงูุชุฏูู ุงููุงูู:**
```
1. ุงููุณุชุฎุฏู ูุนุฏูู ูุงุชูุฑุฉ ุงูุฅูุงุฑุงุช (ุงูุฃุตููุฉ)
    โ
2. ุงููุธุงู ูุญุฏูุซ ูุงุชูุฑุฉ ุงูุชูุงุฒู:
   - ุงููููุฉ ูู ุงููุงุชูุฑุฉ ุงูุฌุฏูุฏุฉ โ
   - ุงูุณุนุฑ ูู ุงููุงุชูุฑุฉ ุงููุฏููุฉ (ุซุงุจุช) โ
    โ
3. ุงููุธุงู ูุญุฏูุซ ูุงุชูุฑุฉ ุงููุดุชุฑูุงุช:
   - ููุณ ุจููุฏ ูุงุชูุฑุฉ ุงูุชูุงุฒู โ
    โ
4. ูู ุงูุชุญุฏูุซุงุช ุชุธูุฑ ูู ุดุงุดุฉ ุงููุญุงุณุจ โ
```

---

## ๐ ุงููููุงุช ุงููุนุฏูุฉ

```
โ server/src/services/SalesService.ts
   - updateSale(): 
     * ุงูุญูุงุธ ุนูู ุณุนุฑ ุงูุฌููุฉ ุงูุซุงุจุช (ุงูุณุทุฑ 652-666)
     * ุชุญุฏูุซ ูุงุชูุฑุฉ ุงููุดุชุฑูุงุช (ุงูุณุทุฑ 676-702)
```

---

## ๐ ุญุงูุฉ ุงููุธุงู

```
โ ุฅูุดุงุก ูุงุชูุฑุฉ ูุนูุฏุฉ: ูุนูู
โ ุชุนุฏูู ูุงุชูุฑุฉ ูุนูุฏุฉ:
   - ุชุญุฏูุซ ูุงุชูุฑุฉ ุงูุฅูุงุฑุงุช: โ
   - ุชุญุฏูุซ ูุงุชูุฑุฉ ุงูุชูุงุฒู (ูููุฉ ููุท): โ
   - ุชุญุฏูุซ ูุงุชูุฑุฉ ุงููุดุชุฑูุงุช: โ
โ ุณุนุฑ ุงูุฌููุฉ: ุซุงุจุช โ
โ ุณุนุฑ ุงูุจูุน ููุนููู: ูุชุบูุฑ โ
โ ุญุฐู ูุชุณูุณู: ูุนูู
โ ุญูุงูุฉ ุงูููุงุชูุฑ ุงูุชููุงุฆูุฉ: ููุนููุฉ
```

---

**ุชุงุฑูุฎ ุงูุชุญุฏูุซ:** 5 ููููุจุฑ 2025  
**ุงูุญุงูุฉ:** โ ููุทุจูู ููุนูู  
**ุงูุชุฃุซูุฑ:** ๐ฏ ุณุนุฑ ุงูุฌููุฉ ูู ุงูุชูุงุฒู ุซุงุจุช + ุชุญุฏูุซ ูุงุชูุฑุฉ ุงููุดุชุฑูุงุช ุชููุงุฆูุงู

