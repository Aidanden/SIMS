# ุฅุตูุงุญ ูุดููุฉ ุชุญุฏูุซ ุงููุฎุฒูู - Bug Fix

## ๐ ุงููุดููุฉ ุงูุญููููุฉ:

ุนูุฏ ุงูุถุบุท ุนูู ุฒุฑ "ุฅุฏุงุฑุฉ ุงููุฎุฒูู" ูุชุนุฏูู ุงููููุฉุ ูุงู ูุชู **ุฅุถุงูุฉ ุณุทุฑ ุฌุฏูุฏ** ูู ุฌุฏูู `stock` ุจุฏูุงู ูู **ุชุนุฏูู ุงูุณุทุฑ ุงูููุฌูุฏ**.

### ุงูุณุจุจ ุงูุฌุฐุฑู:

**`companyId` ูุงู hardcoded ุจูููุฉ `1` ูู Frontend!**

```typescript
// โ ุงูููุฏ ุงูุฎุงุทุฆ ูู /client/src/app/products/page.tsx
await updateStock({
  companyId: 1,  // โ hardcoded!
  productId: selectedProduct.id,
  quantity: boxes
});
```

### ููุงุฐุง ูุงู ูููุดุฆ ุณุทุฑ ุฌุฏูุฏุ

ูู `schema.prisma`ุ ุฌุฏูู `Stock` ูู unique constraint:

```prisma
model Stock {
  id        Int      @id @default(autoincrement())
  companyId Int
  productId Int
  boxes     Decimal
  
  @@unique([companyId, productId])  // โ๏ธ ูู ุตูู ูู ุณุทุฑ ูุงุญุฏ ููู ุดุฑูุฉ
}
```

**ุงูุณููุงุฑูู**:
1. ุงููุณุชุฎุฏู ูู ุดุฑูุฉ ID = 2 (ูุซูุงู "ุตุงูุฉ ุงูุฅูุงุฑุงุช")
2. ุงูุตูู ููุฌูุฏ ุจุณุทุฑ ูู `stock`: `(companyId: 2, productId: 123)`
3. Frontend ูุฑุณู: `(companyId: 1, productId: 123)` โ
4. `upsert` ูุง ูุฌุฏ ุงูุณุทุฑ `(1, 123)` ูุฃู ุงูุณุทุฑ ุงูููุฌูุฏ ูู `(2, 123)`
5. ูููุดุฆ ุณุทุฑ ุฌุฏูุฏ `(1, 123)` โ
6. **ุงููุชูุฌุฉ**: ุณุทุฑูู ููุตูู ููุณู! โ

---

## โ ุงูุญู ุงููุทุจู:

### 1. ูู `/client/src/app/products/page.tsx`:

#### ุฅุตูุงุญ `handleUpdateStock`:
```typescript
// โ ุจุนุฏ ุงูุฅุตูุงุญ
const handleUpdateStock = async (boxes: number) => {
  if (!selectedProduct || !currentUser?.companyId) return;
  
  try {
    await updateStock({
      companyId: currentUser.companyId,  // โ ูู ุงููุณุชุฎุฏู ุงูุญุงูู
      productId: selectedProduct.id,
      quantity: boxes
    }).unwrap();
    // ...
  } catch (error: any) {
    notifications.products.stockUpdateError(error?.data?.message);
  }
};
```

#### ุฅุตูุงุญ `handleUpdatePrice`:
```typescript
// โ ุจุนุฏ ุงูุฅุตูุงุญ
const handleUpdatePrice = async (sellPrice: number) => {
  if (!selectedProduct || !currentUser?.companyId) return;
  
  try {
    await updatePrice({
      companyId: currentUser.companyId,  // โ ูู ุงููุณุชุฎุฏู ุงูุญุงูู
      productId: selectedProduct.id,
      sellPrice
    }).unwrap();
    // ...
  } catch (error: any) {
    notifications.products.priceUpdateError(error?.data?.message);
  }
};
```

### 2. ูู `/server/src/services/ProductService.ts`:

ุฅุถุงูุฉ `try-catch` ููุนุงูุฌุฉ ุฃุฎุทุงุก Prisma:

```typescript
async updateStock(data: UpdateStockDto): Promise<void> {
  try {
    // ุงูุชุญูู ูู ูุฌูุฏ ุงูุตูู
    const product = await this.prisma.product.findUnique({
      where: { id: data.productId },
      include: {
        saleLines: { select: { id: true }, take: 1 },
        purchaseLines: { select: { id: true }, take: 1 },
      }
    });

    if (!product) {
      throw new Error('ุงูุตูู ุบูุฑ ููุฌูุฏ');
    }

    // ุงูุชุญูู ูู ุงุณุชุฎุฏุงู ุงูุตูู ูู ููุงุชูุฑ
    if (product.saleLines.length > 0 || product.purchaseLines.length > 0) {
      throw new Error('ูุง ูููู ุชุนุฏูู ูุฎุฒูู ุตูู ูุณุชุฎุฏู ูู ููุงุชูุฑ');
    }

    // ุงุณุชุฎุฏุงู upsert: ุชุญุฏูุซ ุฅุฐุง ููุฌูุฏุ ุฅูุดุงุก ุฅุฐุง ุบูุฑ ููุฌูุฏ
    await this.prisma.stock.upsert({
      where: {
        companyId_productId: {
          companyId: data.companyId,  // โ ุงูุขู ูุณุชูู ุงููููุฉ ุงูุตุญูุญุฉ
          productId: data.productId,
        }
      },
      update: { boxes: data.quantity },
      create: {
        companyId: data.companyId,
        productId: data.productId,
        boxes: data.quantity,
      }
    });
  } catch (error: any) {
    // ุฅุนุงุฏุฉ ุฑูู ุงูุฃุฎุทุงุก ุงููุนุฑููุฉ
    if (error.message.includes('ุบูุฑ ููุฌูุฏ') || error.message.includes('ูุณุชุฎุฏู ูู ููุงุชูุฑ')) {
      throw error;
    }
    // ุชุญููู ุฃุฎุทุงุก Prisma ุฅูู ุฑุณุงุฆู ูููููุฉ
    console.error('ุฎุทุฃ ูู updateStock:', error);
    throw new Error('ูุดู ูู ุชุญุฏูุซ ุงููุฎุฒูู: ' + (error.message || 'ุฎุทุฃ ุบูุฑ ูุนุฑูู'));
  }
}
```

---

## ๐ ุงููุฑู ุจูู ูุจู ูุจุนุฏ:

### โ ูุจู ุงูุฅุตูุงุญ:

| ุงููุณุชุฎุฏู | companyId ุงูููุฑุณู | ุงูุณุทุฑ ุงูููุฌูุฏ | ุงููุชูุฌุฉ |
|----------|------------------|---------------|---------|
| ูู ุดุฑูุฉ 2 | 1 (hardcoded) | (2, 123) | ุณุทุฑ ุฌุฏูุฏ (1, 123) โ |
| ูู ุดุฑูุฉ 3 | 1 (hardcoded) | (3, 123) | ุณุทุฑ ุฌุฏูุฏ (1, 123) โ |

**ุงููุดููุฉ**: ุชูุฑุงุฑ ุณุทูุฑ ูู ุฌุฏูู `stock`!

### โ ุจุนุฏ ุงูุฅุตูุงุญ:

| ุงููุณุชุฎุฏู | companyId ุงูููุฑุณู | ุงูุณุทุฑ ุงูููุฌูุฏ | ุงููุชูุฌุฉ |
|----------|------------------|---------------|---------|
| ูู ุดุฑูุฉ 2 | 2 (ูู ุงููุณุชุฎุฏู) | (2, 123) | ุชุญุฏูุซ ุงูุณุทุฑ (2, 123) โ |
| ูู ุดุฑูุฉ 3 | 3 (ูู ุงููุณุชุฎุฏู) | (3, 123) | ุชุญุฏูุซ ุงูุณุทุฑ (3, 123) โ |

**ุงููุชูุฌุฉ**: ุณุทุฑ ูุงุญุฏ ููุท ููู ุตูู ูู ูู ุดุฑูุฉ!

---

## ๐งช ุงูุงุฎุชุจุงุฑ:

### ุงูุณููุงุฑูู 1: ุชุนุฏูู ูุฎุฒูู ููุฌูุฏ
```
1. ุณุฌู ุฏุฎูู ููุณุชุฎุฏู ูู "ุตุงูุฉ ุงูุฅูุงุฑุงุช" (companyId: 2)
2. ุงูุชุญ ุตูุญุฉ ุงูุฃุตูุงู
3. ุงุถุบุท "ุฅุฏุงุฑุฉ ุงููุฎุฒูู" ุนูู ุตูู "ูุชุฑ ุฒูุช ุชูุธูู"
4. ุบููุฑ ุงููููุฉ ูู 5000 ุฅูู 6000
5. ุงุญูุธ

โ ุงููุชูุฌุฉ ุงููุชููุนุฉ:
- ูุชู ุชุญุฏูุซ ููุณ ุงูุณุทุฑ ูู stock
- ุงููููุฉ ุชุตุจุญ 6000
- ูุง ูุชู ุฅูุดุงุก ุณุทุฑ ุฌุฏูุฏ
- companyId ูุจูู 2
```

### ุงูุณููุงุฑูู 2: ุชุนุฏูู ูุฎุฒูู ุตูู ุฌุฏูุฏ
```
1. ุฃูุดุฆ ุตูู ุฌุฏูุฏ (ููุณ ูู ุณุทุฑ ูู stock)
2. ุงุถุบุท "ุฅุฏุงุฑุฉ ุงููุฎุฒูู"
3. ุฃุฏุฎู ุงููููุฉ ุงูุฃููู: 100

โ ุงููุชูุฌุฉ ุงููุชููุนุฉ:
- ูุชู ุฅูุดุงุก ุณุทุฑ ุฌุฏูุฏ ูู stock
- companyId = companyId ุงููุณุชุฎุฏู ุงูุญุงูู
- ุงููููุฉ = 100
```

### ุงูุณููุงุฑูู 3: ูุญุงููุฉ ุชุนุฏูู ุตูู ูุณุชุฎุฏู
```
1. ุงุฎุชุฑ ุตูู ูุณุชุฎุฏู ูู ูุงุชูุฑุฉ ูุจูุนุงุช
2. ุญุงูู ุชุนุฏูู ูุฎุฒููู

โ ุงููุชูุฌุฉ ุงููุชููุนุฉ:
- ูุชู ุฑูุถ ุงูุนูููุฉ
- ุฑุณุงูุฉ: "ูุง ูููู ุชุนุฏูู ูุฎุฒูู ุตูู ูุณุชุฎุฏู ูู ููุงุชูุฑ"
- Status: 400
```

---

## ๐ ุงููููุงุช ุงููุนุฏูุฉ:

1. โ `/client/src/app/products/page.tsx`
   - ุฅุตูุงุญ `handleUpdateStock` - ุงุณุชุฎุฏุงู `currentUser.companyId`
   - ุฅุตูุงุญ `handleUpdatePrice` - ุงุณุชุฎุฏุงู `currentUser.companyId`

2. โ `/server/src/services/ProductService.ts`
   - ุฅุถุงูุฉ `try-catch` ูู `updateStock`
   - ุฅุถุงูุฉ error logging
   - ูุนุงูุฌุฉ ุฃูุถู ูุฃุฎุทุงุก Prisma

---

## ๐ฏ ุงููุชูุฌุฉ ุงูููุงุฆูุฉ:

| | ูุจู | ุจุนุฏ |
|---|-----|-----|
| **companyId** | hardcoded (1) | ูู ุงููุณุชุฎุฏู ุงูุญุงูู |
| **ุชูุฑุงุฑ ุงูุณุทูุฑ** | โ ูุญุฏุซ | โ ูุง ูุญุฏุซ |
| **ุชุญุฏูุซ ุงูุณุทุฑ** | โ ููุดุฆ ุฌุฏูุฏ | โ ูุญุฏุซ ุงูููุฌูุฏ |
| **Error Handling** | ุถุนูู | ูุญุณูู |
| **Logging** | ูุง ููุฌุฏ | ููุฌูุฏ |

---

## ๐ก ุงูุฏุฑูุณ ุงููุณุชูุงุฏุฉ:

1. **ูุง ุชุณุชุฎุฏู hardcoded values** - ุฏุงุฆูุงู ุงุณุชุฎุฏู ุจูุงูุงุช ุงููุณุชุฎุฏู ุงูุญุงูู
2. **ุงููู unique constraints** - ูู Prisma ูุจู ุงุณุชุฎุฏุงู `upsert`
3. **ุฃุถู logging** - ูุชุชุจุน ุงูุฃุฎุทุงุก ุจุณูููุฉ
4. **ุงุฎุชุจุฑ ุจูุณุชุฎุฏููู ูุฎุชูููู** - ูู ุดุฑูุงุช ูุฎุชููุฉ

---

## โ ุงูุฎูุงุตุฉ:

ุชู ุฅุตูุงุญ ุงููุดููุฉ ุจุดูู ูุงูู! ุงูุขู:
- โ ูุชู ุชุญุฏูุซ ุงูุณุทุฑ ุงูููุฌูุฏ ุจุฏูุงู ูู ุฅูุดุงุก ุณุทุฑ ุฌุฏูุฏ
- โ ูู ุดุฑูุฉ ููุง ุณุทุฑ ูุงุญุฏ ููุท ููู ุตูู
- โ `companyId` ูุฃุชู ูู ุงููุณุชุฎุฏู ุงูุญุงูู
- โ ูุนุงูุฌุฉ ุฃุฎุทุงุก ูุญุณููุฉ
- โ logging ูุชุชุจุน ุงููุดุงูู

**ุงููุดููุฉ ูุงูุช ุจุณูุทุฉ ููู ุชุฃุซูุฑูุง ูุจูุฑ - hardcoded value ูุงุญุฏ ุณุจุจ ูู ูุฐู ุงููุดุงูู!** ๐
