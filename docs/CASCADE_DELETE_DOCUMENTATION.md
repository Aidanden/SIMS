# ๐๏ธ ููุฒุฉ ุงูุญุฐู ุงููุชุณูุณู ููููุงุชูุฑ ุงููุนูุฏุฉ (Cascade Delete)

## ๐ฏ ุงููุฏู

ุนูุฏ ุญุฐู ูุงุชูุฑุฉ ูุนูุฏุฉ (ุชุญุชูู ุนูู ุฃุตูุงู ูู ุงูุดุฑูุฉ ุงูุฃู ูุงูุชุงุจุนุฉ)ุ ูุชู ุชููุงุฆูุงู:
1. โ **ุญุฐู ูุงุชูุฑุฉ ุงูุดุฑูุฉ ุงูุฃู** (ูุฎุฒู ุงูุชูุงุฒู โ ุตุงูุฉ ุงูุงูุงุฑุงุช)
2. โ **ุญุฐู ูุงุชูุฑุฉ ุงููุดุชุฑูุงุช** ููุดุฑูุฉ ุงูุชุงุจุนุฉ (ุตุงูุฉ ุงูุงูุงุฑุงุช โ ูุฎุฒู ุงูุชูุงุฒู)
3. โ **ุญุฐู ุณุฌู PurchaseFromParent**
4. โ **ุฅุฑุฌุงุน ุฌููุน ุงููุฎุฒูู** ุชููุงุฆูุงู

---

## ๐ ูุจู ูุจุนุฏ ุงูุชุญุฏูุซ

### ูุจู โ:
```
ุญุฐู ุงููุงุชูุฑุฉ ุงูุฃุตููุฉ
  โโ ูุชู ุญุฐู ุงููุงุชูุฑุฉ ููุท
  โโ ุงูููุงุชูุฑ ุงููุฑุชุจุทุฉ ุชุจูู ูู ุงููุธุงู โ
  โโ ุชุธูุฑ ูู ุดุงุดุฉ ุงููุญุงุณุจ โ
```

### ุจุนุฏ โ:
```
ุญุฐู ุงููุงุชูุฑุฉ ุงูุฃุตููุฉ
  โโ ุญุฐู ูุงุชูุฑุฉ ุงูุดุฑูุฉ ุงูุฃู โ
  โโ ุญุฐู ูุงุชูุฑุฉ ูุดุชุฑูุงุช ุงูุดุฑูุฉ ุงูุชุงุจุนุฉ โ
  โโ ุญุฐู ุณุฌู PurchaseFromParent โ
  โโ ุฅุฑุฌุงุน ุฌููุน ุงููุฎุฒูู โ
  โโ ูุง ุชูุฌุฏ ููุงุชูุฑ ูุนููุฉ โ
```

---

## ๐๏ธ ุงูุชุนุฏููุงุช ุงูุชูููุฉ

### 1. **ุฅุถุงูุฉ ุญููู ุงูุฑุจุท ูู Schema**

#### ุฌุฏูู `Sale`:
```prisma
model Sale {
  // ... ุงูุญููู ุงูููุฌูุฏุฉ
  relatedParentSaleId        Int?  // ุฑุจุท ุจูุงุชูุฑุฉ ุงูุดุฑูุฉ ุงูุฃู
  relatedBranchPurchaseId    Int?  // ุฑุจุท ุจูุงุชูุฑุฉ ูุดุชุฑูุงุช ุงูุดุฑูุฉ ุงูุชุงุจุนุฉ
  relatedPurchaseFromParentId Int? // ุฑุจุท ุจุณุฌู PurchaseFromParent
  
  @@index([relatedParentSaleId])
  @@index([relatedBranchPurchaseId])
}
```

#### ุฌุฏูู `Purchase`:
```prisma
model Purchase {
  // ... ุงูุญููู ุงูููุฌูุฏุฉ
  relatedCustomerSaleId Int?  // ุฑุจุท ุจุงููุงุชูุฑุฉ ุงูุฃุตููุฉ ููุนููู
  
  @@index([relatedCustomerSaleId])
}
```

#### ุฌุฏูู `PurchaseFromParent`:
```prisma
model PurchaseFromParent {
  // ... ุงูุญููู ุงูููุฌูุฏุฉ
  relatedCustomerSaleId Int?  // ุฑุจุท ุจุงููุงุชูุฑุฉ ุงูุฃุตููุฉ ููุนููู
  
  @@index([relatedCustomerSaleId])
}
```

---

### 2. **ุชุญุฏูุซ ComplexInterCompanySaleService**

ุชู ุชุญุฏูุซ `createComplexInterCompanySale` ูุญูุธ ูุนูููุงุช ุงูุฑุจุท:

```typescript
// ุจุนุฏ ุฅูุดุงุก customerSale
const customerSale = await tx.sale.create({ ... });

// ุญูุธ ูุนูููุงุช ุงูุฑุจุท ูู ุงูููุงุชูุฑ ุงููุฑุชุจุทุฉ
if (parentSale) {
  await tx.sale.update({
    where: { id: parentSale.id },
    data: { relatedCustomerSaleId: customerSale.id }
  });
}

if (branchPurchase) {
  await tx.purchase.update({
    where: { id: branchPurchase.id },
    data: { relatedCustomerSaleId: customerSale.id }
  });
}

if (purchaseFromParent) {
  await tx.purchaseFromParent.update({
    where: { id: purchaseFromParent.id },
    data: { relatedCustomerSaleId: customerSale.id }
  });
}

// ุญูุธ ูุนูููุงุช ุงูููุงุชูุฑ ุงููุฑุชุจุทุฉ ูู customerSale
await tx.sale.update({
  where: { id: customerSale.id },
  data: {
    relatedParentSaleId: parentSale?.id || null,
    relatedBranchPurchaseId: branchPurchase?.id || null,
    relatedPurchaseFromParentId: purchaseFromParent?.id || null
  }
});
```

---

### 3. **ุชุญุฏูุซ deleteSale ูู SalesService**

ุชู ุฅุถุงูุฉ ููุทู ุงูุญุฐู ุงููุชุณูุณู:

```typescript
async deleteSale(id: number, userCompanyId: number, isSystemUser: boolean = false) {
  // 1. ุงูุชุญูู ูู ูุฌูุฏ ุงููุงุชูุฑุฉ
  const existingSale = await this.prisma.sale.findFirst({ ... });
  
  // 2. ุญุฐู ุงูููุงุชูุฑ ุงููุฑุชุจุทุฉ (ุฅุฐุง ูุงูุช ูุงุชูุฑุฉ ูุนูุฏุฉ)
  if (existingSale.relatedParentSaleId) {
    // ุญุฐู ูุงุชูุฑุฉ ุงูุดุฑูุฉ ุงูุฃู
    const parentSale = await this.prisma.sale.findUnique({ ... });
    // ุฅุฑุฌุงุน ูุฎุฒูู ุงูุดุฑูุฉ ุงูุฃู
    // ุญุฐู ุงูุฃุณุทุฑ ูุงูุฅูุตุงูุงุช
    // ุญุฐู ุงููุงุชูุฑุฉ
  }
  
  if (existingSale.relatedBranchPurchaseId) {
    // ุญุฐู ูุงุชูุฑุฉ ูุดุชุฑูุงุช ุงูุดุฑูุฉ ุงูุชุงุจุนุฉ
    // ูุง ุญุงุฌุฉ ูุฅุฑุฌุงุน ูุฎุฒูู (affectsInventory = false)
  }
  
  if (existingSale.relatedPurchaseFromParentId) {
    // ุญุฐู ุณุฌู PurchaseFromParent
  }
  
  // 3. ุฅุฑุฌุงุน ูุฎุฒูู ุงููุงุชูุฑุฉ ุงูุฃุตููุฉ
  // 4. ุญุฐู ุฃุณุทุฑ ูุฅูุตุงูุงุช ุงููุงุชูุฑุฉ ุงูุฃุตููุฉ
  // 5. ุญุฐู ุงููุงุชูุฑุฉ ุงูุฃุตููุฉ
}
```

---

## ๐ ุณูุฑ ุงูุนูู ุงููุงูู

### ุณููุงุฑูู: ุญุฐู ูุงุชูุฑุฉ ูุนูุฏุฉ

```
ุงููุณุชุฎุฏู ูุญุฐู ูุงุชูุฑุฉ: BR-2-123
(ุตุงูุฉ ุงูุงูุงุฑุงุช โ ุงูุนููู)
      โ
      โโ ูุงุชูุฑุฉ ุชุญุชูู ุนูู:
      โ   โโ 3 ุฃุตูุงู ูู ูุฎุฒู ุงูุชูุงุฒู (ุงูุดุฑูุฉ ุงูุฃู)
      โ   โโ 2 ุฃุตูุงู ูู ุตุงูุฉ ุงูุงูุงุฑุงุช (ุงูุดุฑูุฉ ุงูุชุงุจุนุฉ)
      โ
      โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ุงููุธุงู ูุชุญูู ูู ูุฌูุฏ ููุงุชูุฑ ูุฑุชุจุทุฉ โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      โ
      โโ relatedParentSaleId: 456
      โโ relatedBranchPurchaseId: 789
      โโ relatedPurchaseFromParentId: 101
      โ
      โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  1๏ธโฃ ุญุฐู ูุงุชูุฑุฉ ุงูุดุฑูุฉ ุงูุฃู (456)   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      โโ ุฅุฑุฌุงุน 3 ุฃุตูุงู ููุฎุฒู ุงูุชูุงุฒู
      โโ ุญุฐู ุฃุณุทุฑ ุงููุงุชูุฑุฉ
      โโ ุญุฐู ุฅูุตุงูุงุช ุงููุจุถ
      โโ ุญุฐู ุงููุงุชูุฑุฉ (ID: 456)
      โ
      โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  2๏ธโฃ ุญุฐู ูุงุชูุฑุฉ ุงููุดุชุฑูุงุช (789)     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      โโ (ูุง ุญุงุฌุฉ ูุฅุฑุฌุงุน ูุฎุฒูู)
      โโ ุญุฐู ุฃุณุทุฑ ุงููุงุชูุฑุฉ
      โโ ุญุฐู ุฏูุนุงุช ุงููุงุชูุฑุฉ
      โโ ุญุฐู ุงููุงุชูุฑุฉ (ID: 789)
      โ
      โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  3๏ธโฃ ุญุฐู ุณุฌู PurchaseFromParent (101)โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      โโ ุญุฐู ุงูุฃุณุทุฑ
      โโ ุญุฐู ุงูุฅูุตุงูุงุช
      โโ ุญุฐู ุงูุณุฌู (ID: 101)
      โ
      โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  4๏ธโฃ ุฅุฑุฌุงุน ูุฎุฒูู ุงููุงุชูุฑุฉ ุงูุฃุตููุฉ  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      โโ ุฅุฑุฌุงุน 5 ุฃุตูุงู ูุตุงูุฉ ุงูุงูุงุฑุงุช
      โ
      โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  5๏ธโฃ ุญุฐู ุงููุงุชูุฑุฉ ุงูุฃุตููุฉ (BR-2-123)โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      โโ ุญุฐู ุฃุณุทุฑ ุงููุงุชูุฑุฉ
      โโ ุญุฐู ุฅูุตุงูุงุช ุงููุจุถ
      โโ ุญุฐู ุงููุงุชูุฑุฉ
      โ
      โผ
    โ ุชู!
```

---

## ๐ ุงููููุงุช ุงููุนุฏูุฉ

### Schema & Migrations:
```
โ server/prisma/schema.prisma
โ server/prisma/migrations/add_related_sale_fields.sql
```

### Services:
```
โ server/src/services/ComplexInterCompanySaleService.ts
โ server/src/services/SalesService.ts
```

### Scripts:
```
โ APPLY_CASCADE_DELETE.sh
```

### Documentation:
```
โ CASCADE_DELETE_DOCUMENTATION.md (ูุฐุง ุงูููู)
```

---

## ๐ ุงูุชุทุจูู

### 1. ุชุทุจูู Migration:

```bash
# ุงูุทุฑููุฉ 1: ุงุณุชุฎุฏุงู ุงูู script
chmod +x APPLY_CASCADE_DELETE.sh
./APPLY_CASCADE_DELETE.sh
```

```bash
# ุงูุทุฑููุฉ 2: ูุฏููุงู
cd server

# ุชุทุจูู migration
psql $DATABASE_URL -f prisma/migrations/add_related_sale_fields.sql

# ุฃู ุงุณุชุฎุฏุงู Prisma
npx prisma db push

# ุชุญุฏูุซ Prisma Client
npx prisma generate

# ุฅุนุงุฏุฉ ุชุดุบูู ุงูุฎุงุฏู
npm run dev
```

---

## ๐งช ุงูุงุฎุชุจุงุฑ

### ุณููุงุฑูู 1: ูุงุชูุฑุฉ ูุนูุฏุฉ

```bash
1. ุฅูุดุงุก ูุงุชูุฑุฉ ูุนูุฏุฉ:
   โโ POST /api/complex-inter-company-sales
   โโ ุชุญุชูู ุนูู ุฃุตูุงู ูู ุงูุดุฑูุฉ ุงูุฃู ูุงูุชุงุจุนุฉ
   
2. ุงูุชุญูู ูู ุงูููุงุชูุฑ ุงูููุดุฃุฉ:
   โโ ูุงุชูุฑุฉ ุงูุนููู: BR-2-xxx
   โโ ูุงุชูุฑุฉ ุงูุดุฑูุฉ ุงูุฃู: PR-1-xxx
   โโ ูุงุชูุฑุฉ ูุดุชุฑูุงุช ุงูุชุงุจุนุฉ: PUR-xxx

3. ุญุฐู ูุงุชูุฑุฉ ุงูุนููู:
   โโ DELETE /api/sales/{id}

4. ุงูุชุญูู ูู ุงูุญุฐู:
   โโ โ ูุงุชูุฑุฉ ุงูุนููู ูุญุฐููุฉ
   โโ โ ูุงุชูุฑุฉ ุงูุดุฑูุฉ ุงูุฃู ูุญุฐููุฉ
   โโ โ ูุงุชูุฑุฉ ุงููุดุชุฑูุงุช ูุญุฐููุฉ
   โโ โ ุณุฌู PurchaseFromParent ูุญุฐูู
   โโ โ ุงููุฎุฒูู ููุฑุฌูุน
```

### ุณููุงุฑูู 2: ูุงุชูุฑุฉ ุนุงุฏูุฉ

```bash
1. ุฅูุดุงุก ูุงุชูุฑุฉ ุนุงุฏูุฉ:
   โโ POST /api/sales
   โโ ุชุญุชูู ุนูู ุฃุตูุงู ูู ุงูุดุฑูุฉ ุงูุชุงุจุนุฉ ููุท

2. ุญุฐู ุงููุงุชูุฑุฉ:
   โโ DELETE /api/sales/{id}

3. ุงูุชุญูู:
   โโ โ ุงููุงุชูุฑุฉ ูุญุฐููุฉ
   โโ โ ุงููุฎุฒูู ููุฑุฌูุน
   โโ โ ูุง ููุงุชูุฑ ูุฑุชุจุทุฉ (ูุงุชูุฑุฉ ุนุงุฏูุฉ)
```

---

## ๐ ุชุชุจุน ุงูุชูููุฐ (Logs)

ุนูุฏ ุญุฐู ูุงุชูุฑุฉ ูุนูุฏุฉุ ุณุชุธูุฑ Logs ููุตูุฉ:

```
๐๏ธ ุจุฏุก ุญุฐู ุงููุงุชูุฑุฉ ูุฌููุน ุงูููุงุชูุฑ ุงููุฑุชุจุทุฉ...
๐ ูุงุชูุฑุฉ ูุนูุฏุฉ - ุณูุชู ุญุฐู ุงูููุงุชูุฑ ุงููุฑุชุจุทุฉ

๐ ุญุฐู ูุงุชูุฑุฉ ุงูุดุฑูุฉ ุงูุฃู (ID: 456)...
  โโ ุฅุฑุฌุงุน ูุฎุฒูู: Product 1, Qty: 10
  โโ ุฅุฑุฌุงุน ูุฎุฒูู: Product 2, Qty: 20
  โโ ุฅุฑุฌุงุน ูุฎุฒูู: Product 3, Qty: 15
โ ุชู ุญุฐู ูุงุชูุฑุฉ ุงูุดุฑูุฉ ุงูุฃู

๐ ุญุฐู ูุงุชูุฑุฉ ูุดุชุฑูุงุช ุงูุดุฑูุฉ ุงูุชุงุจุนุฉ (ID: 789)...
โ ุชู ุญุฐู ูุงุชูุฑุฉ ูุดุชุฑูุงุช ุงูุดุฑูุฉ ุงูุชุงุจุนุฉ

๐ ุญุฐู ุณุฌู PurchaseFromParent (ID: 101)...
โ ุชู ุญุฐู ุณุฌู PurchaseFromParent

๐ ุจุฏุก ุฅุฑุฌุงุน ุงููุฎุฒูู ูููุงุชูุฑุฉ ุงูุฃุตููุฉ...
๐ฆ Stock Return: { productId: 4, boxesToIncrement: 30, afterReturn: 130 }
๐ฆ Stock Return: { productId: 5, boxesToIncrement: 25, afterReturn: 75 }
โ ุชู ุฅุฑุฌุงุน ุงููุฎุฒูู ุจูุฌุงุญ

โ ุชู ุญุฐู ุงููุงุชูุฑุฉ ูุฌููุน ุงูููุงุชูุฑ ุงููุฑุชุจุทุฉ ุจูุฌุงุญ
```

---

## โ๏ธ ููุงุญุธุงุช ูููุฉ

### 1. **ุฅุฑุฌุงุน ุงููุฎุฒูู:**
- โ ูุงุชูุฑุฉ ุงูุดุฑูุฉ ุงูุฃู: ููุฑุฌูุน ุงููุฎุฒูู ููุดุฑูุฉ ุงูุฃู
- โ ูุงุชูุฑุฉ ุงูุนููู: ููุฑุฌูุน ุงููุฎุฒูู ููุดุฑูุฉ ุงูุชุงุจุนุฉ
- โ ูุงุชูุฑุฉ ุงููุดุชุฑูุงุช: ูุง ููุฑุฌูุน ูุฎุฒูู (ูุฃู `affectsInventory = false`)

### 2. **ุงูุตูุงุญูุงุช:**
- ูููู ููุท ูููุณุชุฎุฏููู ุงูุฐูู ูุฏููู ุตูุงุญูุฉ ุญุฐู ุงูููุงุชูุฑ ุงูููุงู ุจุฐูู
- System users ูููููู ุญุฐู ููุงุชูุฑ ุฃู ุดุฑูุฉ
- ุงููุณุชุฎุฏููู ุงูุนุงุฏููู ูููููู ุญุฐู ููุงุชูุฑ ุดุฑูุชูู ููุท

### 3. **ุงูุฅูุตุงูุงุช ูุงูุฏูุนุงุช:**
- ูุชู ุญุฐู ุฌููุน ุงูุฅูุตุงูุงุช ูุงูุฏูุนุงุช ุงููุฑุชุจุทุฉ ุชููุงุฆูุงู
- ูุดูู ุฐูู: `SalePayment`, `PurchasePayment`, `PurchaseFromParentReceipt`

---

## โ ุงูุฎูุงุตุฉ

ุชู ุจูุฌุงุญ ุฅุถุงูุฉ ููุฒุฉ **ุงูุญุฐู ุงููุชุณูุณู** ููููุงุชูุฑ ุงููุนูุฏุฉ:

1. โ **Schema ูุญุฏุซ** ุจุญููู ุงูุฑุจุท
2. โ **ComplexInterCompanySaleService ูุญุฏุซ** ูุญูุธ ูุนูููุงุช ุงูุฑุจุท
3. โ **deleteSale ูุญุฏุซ** ููุญุฐู ุงููุชุณูุณู
4. โ **Migration SQL ุฌุงูุฒ** ููุชุทุจูู
5. โ **Script ุชุทุจูู** ุฌุงูุฒ
6. โ **ุชูุซูู ุดุงูู** (ูุฐุง ุงูููู)

**ุงููุชูุฌุฉ:**
- ุนูุฏ ุญุฐู ูุงุชูุฑุฉ ูู ุงููุจูุนุงุชุ ุชูุญุฐู ุชููุงุฆูุงู ูู ุดุงุดุฉ ุงููุญุงุณุจ
- ุฌููุน ุงูููุงุชูุฑ ุงููุฑุชุจุทุฉ ุชูุญุฐู ุชููุงุฆูุงู
- ุฌููุน ุงููุฎุฒูู ููุฑุฌูุน ุชููุงุฆูุงู
- ูุง ุชูุฌุฏ ููุงุชูุฑ ูุนููุฉ ุฃู ุจูุงูุงุช ุบูุฑ ูุชุณูุฉ

**ุงูููุฒุฉ ุฌุงูุฒุฉ ููุงุณุชุฎุฏุงู! ๐**

---

**ุงูุชุงุฑูุฎ:** 2025-11-04  
**ุงูุฅุตุฏุงุฑ:** 3.0.0  
**ุงูููุน:** Major Feature - Cascade Delete  
**ุงูุญุงูุฉ:** โ ุฌุงูุฒ ููุชุทุจูู

