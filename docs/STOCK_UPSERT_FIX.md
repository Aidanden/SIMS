# ุฅุตูุงุญ ูุดููุฉ ุฅุฑุฌุงุน ุงููุฎุฒูู ุนูุฏ ุญุฐู ุงูููุงุชูุฑ ุงููุนูุฏุฉ

## ๐ ุงููุดููุฉ

ุนูุฏ ุญุฐู ูุงุชูุฑุฉ ูุจูุนุงุช ูุนูุฏุฉ (ุชุญุชูู ุนูู ุฃุตูุงู ูู ุงูุดุฑูุฉ ุงูุฃู ูุงูุดุฑูุฉ ุงูุชุงุจุนุฉ)ุ ูุงู ุงููุธุงู ููุดู ูู ุฅุฑุฌุงุน ุงููุฎุฒูู ุฅุฐุง ูู ููู ุณุฌู ุงููุฎุฒูู ููุฌูุฏุงู ูุณุจูุงู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช.

### ุฑุณุงูุฉ ุงูุฎุทุฃ:
```
PrismaClientKnownRequestError: 
Invalid `this.prisma.stock.update()` invocation
An operation failed because it depends on one or more records that were required but not found.
No record was found for an update.
code: 'P2025'
```

### ุงูุณุจุจ:
- ูุงู ุงููุธุงู ูุณุชุฎุฏู `stock.update()` ูุฅุฑุฌุงุน ุงููุฎุฒูู
- ุฅุฐุง ูู ููู ุณุฌู ุงููุฎุฒูู ููุฌูุฏุงูุ ุชูุดู ุนูููุฉ `update`
- ูุฐุง ูุญุฏุซ ุนูุฏูุง:
  - ูุชู ุจูุน ุตูู ูุฃูู ูุฑุฉ ูู ุดุฑูุฉ ูุนููุฉ
  - ูุชู ุญุฐู ุงููุงุชูุฑุฉ ูุจู ุฅูุดุงุก ุฃู ูุฎุฒูู ุฅุถุงูู

---

## โ ุงูุญู

ุงุณุชุจุฏุงู `stock.update()` ุจู `stock.upsert()` ูู ุฌููุน ุนูููุงุช ุฅุฑุฌุงุน ุงููุฎุฒูู.

### `upsert` ุชููู ุจู:
1. **ุฅุฐุง ูุงู ุงูุณุฌู ููุฌูุฏุงู**: ุชุญุฏูุซู (increment)
2. **ุฅุฐุง ูู ููู ุงูุณุฌู ููุฌูุฏุงู**: ุฅูุดุงุคู ุจุงููููุฉ ุงููุทููุจุฉ

---

## ๐ ุงูุชุบููุฑุงุช

### 1. ุฅุฑุฌุงุน ูุฎุฒูู ูุงุชูุฑุฉ ุงูุดุฑูุฉ ุงูุฃู

**ูุจู:**
```typescript
await this.prisma.stock.update({
  where: {
    companyId_productId: {
      companyId: parentSale.companyId,
      productId: line.productId
    }
  },
  data: {
    boxes: {
      increment: Number(line.qty)
    }
  }
});
```

**ุจุนุฏ:**
```typescript
await this.prisma.stock.upsert({
  where: {
    companyId_productId: {
      companyId: parentSale.companyId,
      productId: line.productId
    }
  },
  update: {
    boxes: {
      increment: Number(line.qty)
    }
  },
  create: {
    companyId: parentSale.companyId,
    productId: line.productId,
    boxes: Number(line.qty)
  }
});
```

---

### 2. ุฅุฑุฌุงุน ูุฎุฒูู ุงููุงุชูุฑุฉ ุงูุฃุตููุฉ (ุงูุดุฑูุฉ ุงูุชุงุจุนุฉ)

**ูุจู:**
```typescript
await this.prisma.stock.update({
  where: {
    companyId_productId: {
      companyId: existingSale.companyId,
      productId: line.productId
    }
  },
  data: {
    boxes: {
      increment: boxesToIncrement
    }
  }
});
```

**ุจุนุฏ:**
```typescript
await this.prisma.stock.upsert({
  where: {
    companyId_productId: {
      companyId: existingSale.companyId,
      productId: line.productId
    }
  },
  update: {
    boxes: {
      increment: boxesToIncrement
    }
  },
  create: {
    companyId: existingSale.companyId,
    productId: line.productId,
    boxes: boxesToIncrement
  }
});
```

---

## ๐ฏ ุงููููุงุช ุงููุนุฏูุฉ

```
โ server/src/services/SalesService.ts
   - ุงูุณุทูุฑ 634-651: ุฅุฑุฌุงุน ูุฎุฒูู ูุงุชูุฑุฉ ุงูุดุฑูุฉ ุงูุฃู
   - ุงูุณุทูุฑ 721-738: ุฅุฑุฌุงุน ูุฎุฒูู ุงููุงุชูุฑุฉ ุงูุฃุตููุฉ
```

---

## ๐งช ุณููุงุฑูู ุงูุงุฎุชุจุงุฑ

### ูุจู ุงูุฅุตูุงุญ:
```
1. ุฅูุดุงุก ูุงุชูุฑุฉ ูุจูุนุงุช ูุนูุฏุฉ (ุฅูุงุฑุงุช + ุชูุงุฒู)
   โ ุชู ุฅูุดุงุก ุงูููุงุชูุฑ ุจูุฌุงุญ
   โ ุชู ุฎุตู ุงููุฎุฒูู

2. ุญุฐู ุงููุงุชูุฑุฉ ุงููุนูุฏุฉ
   โ ุญุฐู ูุงุชูุฑุฉ ุงูุชูุงุฒู
   โ ุญุฐู ูุงุชูุฑุฉ ุงููุดุชุฑูุงุช
   โ ุจุฏุฃ ุฅุฑุฌุงุน ุงููุฎุฒูู
   โ ูุดู! (ุฅุฐุง ูู ููู ุณุฌู ุงููุฎุฒูู ููุฌูุฏุงู)
```

### ุจุนุฏ ุงูุฅุตูุงุญ:
```
1. ุฅูุดุงุก ูุงุชูุฑุฉ ูุจูุนุงุช ูุนูุฏุฉ (ุฅูุงุฑุงุช + ุชูุงุฒู)
   โ ุชู ุฅูุดุงุก ุงูููุงุชูุฑ ุจูุฌุงุญ
   โ ุชู ุฎุตู ุงููุฎุฒูู

2. ุญุฐู ุงููุงุชูุฑุฉ ุงููุนูุฏุฉ
   โ ุญุฐู ูุงุชูุฑุฉ ุงูุชูุงุฒู
   โ ุญุฐู ูุงุชูุฑุฉ ุงููุดุชุฑูุงุช
   โ ุญุฐู ุณุฌู PurchaseFromParent
   โ ุฅุฑุฌุงุน ุงููุฎุฒูู ููุชูุงุฒู (upsert)
   โ ุฅุฑุฌุงุน ุงููุฎุฒูู ููุฅูุงุฑุงุช (upsert)
   โ ุชู ุงูุญุฐู ุจูุฌุงุญ!
```

---

## ๐ก ููุงุฆุฏ `upsert`

| ุงูููุฒุฉ | ุงููุตู |
|--------|--------|
| **ุงููุฑููุฉ** | ูุนูู ุณูุงุก ูุงู ุงูุณุฌู ููุฌูุฏุงู ุฃู ูุง |
| **ุงูุฃูุงู** | ูุง ููุฌุฏ ุฎุทุฃ P2025 |
| **ุงูุจุณุงุทุฉ** | ููุฏ ูุงุญุฏ ูุชุนุงูู ูุน ุงูุญุงูุชูู |
| **ุงูููุซูููุฉ** | ูุถูู ุฅุฑุฌุงุน ุงููุฎุฒูู ุฏุงุฆูุงู |

---

## ๐ ุญุงูุฉ ุงููุธุงู

```
โ ุญุฐู ุงูููุงุชูุฑ ุงููุนูุฏุฉ: ูุนูู
โ ุฅุฑุฌุงุน ุงููุฎุฒูู: ูุนูู
โ ุญูุงูุฉ ุงูููุงุชูุฑ ุงูุชุงุจุนุฉ: ููุนููุฉ
โ ุงูุญุฐู ุงููุชุณูุณู: ูุนูู
โ ุฑุณุงุฆู ุงูุฎุทุฃ: ูุงุถุญุฉ
โ ุงูุฎุงุฏู: ูุนูู ุนูู ุงููููุฐ 4000
```

---

## ๐ ุงูุชุดุบูู

```bash
cd /run/media/shark/033e2f56-34e7-4428-b4ef-bf76d5c4b6fb/CODE/CeramiSys/server
npm run dev
```

---

**ุชุงุฑูุฎ ุงูุฅุตูุงุญ:** 4 ููููุจุฑ 2025
**ุงูุญุงูุฉ:** โ ููุทุจูู ูุฌุงูุฒ

