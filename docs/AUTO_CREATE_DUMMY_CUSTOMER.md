# ุฅูุดุงุก ุนููู ูููู ุชููุงุฆูุงู ุนูุฏ ุฅุถุงูุฉ ุดุฑูุฉ ูุฑุนูุฉ

## ๐ฏ ุงูููุฑุฉ:

ุจุฏูุงู ูู ุฅูุดุงุก ุงูุนููู ุงููููู ุนูุฏ ูู ุนูููุฉ ุจูุน ูุนูุฏุฉุ ูุชู ุฅูุดุงุคู **ุชููุงุฆูุงู** ุนูุฏ ุฅุถุงูุฉ ุดุฑูุฉ ูุฑุนูุฉ ุฌุฏูุฏุฉ.

---

## โ ุงููููุฒุงุช:

### 1. **ุฅูุดุงุก ุชููุงุฆู**:
- ุนูุฏ ุฅุถุงูุฉ ุดุฑูุฉ ูุฑุนูุฉ ุฌุฏูุฏุฉ
- ูุชู ุฅูุดุงุก ุนููู ูููู ุจููุณ ุงูุงุณู
- ุจุฏูู ุชุฏุฎู ูุฏูู

### 2. **ูุนูููุงุช ูุงุถุญุฉ**:
```typescript
{
  name: "ุดุฑูุฉ ุงูุฅูุงุฑุงุช",           // ููุณ ุงุณู ุงูุดุฑูุฉ
  phone: "BRANCH-2",                // ูุนุฑู ูุฑูุฏ
  note: "ุนููู ูููู ููุซู ุงูุดุฑูุฉ ุงููุฑุนูุฉ: ุดุฑูุฉ ุงูุฅูุงุฑุงุช"
}
```

### 3. **ูุง ุชูุฑุงุฑ**:
- ูุนุฑู ูุฑูุฏ: `BRANCH-{companyId}`
- ูุง ูููู ุฅูุดุงุก ุนููู ูููู ููุฑุฑ ูููุณ ุงูุดุฑูุฉ

### 4. **Fallback ุขูู**:
- ุฅุฐุง ูุดู ุฅูุดุงุก ุงูุนููู ุงูููููุ ูุง ุชูุดู ุนูููุฉ ุฅูุดุงุก ุงูุดุฑูุฉ
- ุงููุจูุนุงุช ุงููุนูุฏุฉ ุชุชุญูู ูุชูุดุฆ ุงูุนููู ุฅุฐุง ูู ููู ููุฌูุฏุงู

---

## ๐ง ุงูููุฏ ุงููุทุจู:

### ูู CompanyService.createCompany():

```typescript
// ุจุนุฏ ุฅูุดุงุก ุงูุดุฑูุฉ ุจูุฌุงุญ
console.log('โ Company created successfully:', result);

// ุฅุฐุง ูุงูุช ุดุฑูุฉ ูุฑุนูุฉุ ุฃูุดุฆ ุนููู ูููู ููุซููุง
if (!data.isParent && result.id) {
  try {
    const dummyCustomer = await this.prisma.customer.create({
      data: {
        name: result.name,
        phone: `BRANCH-${result.id}`,
        note: `ุนููู ูููู ููุซู ุงูุดุฑูุฉ ุงููุฑุนูุฉ: ${result.name}`
      }
    });
    console.log('โ Dummy customer created for branch company:', dummyCustomer);
  } catch (customerError) {
    console.error('โ๏ธ Failed to create dummy customer (non-critical):', customerError);
    // ูุง ูุฑูู ุฎุทุฃ ููุง ูุฃู ุงูุดุฑูุฉ ุชู ุฅูุดุงุคูุง ุจูุฌุงุญ
  }
}

return result;
```

---

## ๐ ูุซุงู ุนููู:

### ุงูุณููุงุฑูู:
```
ุฅุถุงูุฉ ุดุฑูุฉ ูุฑุนูุฉ ุฌุฏูุฏุฉ:
- ุงูุงุณู: ุดุฑูุฉ ุงูุฅูุงุฑุงุช
- ุงูููุฏ: EMR
- ุงูุดุฑูุฉ ุงูุฃู: ุดุฑูุฉ ุงูุชูุงุฒู (ID: 1)
```

### ุงููุชูุฌุฉ:
```
1. ุฅูุดุงุก ุงูุดุฑูุฉ:
   โ Company created:
   - ID: 2
   - Name: ุดุฑูุฉ ุงูุฅูุงุฑุงุช
   - Code: EMR
   - isParent: false
   - parentId: 1

2. ุฅูุดุงุก ุงูุนููู ุงููููู ุชููุงุฆูุงู:
   โ Dummy customer created:
   - ID: 10
   - Name: ุดุฑูุฉ ุงูุฅูุงุฑุงุช
   - Phone: BRANCH-2
   - Note: ุนููู ูููู ููุซู ุงูุดุฑูุฉ ุงููุฑุนูุฉ: ุดุฑูุฉ ุงูุฅูุงุฑุงุช
```

---

## ๐ ุงูุชูุงูู ูุน ุงููุจูุนุงุช ุงููุนูุฏุฉ:

### ุงูููุฏ ุงูุญุงูู (ูุนูู ูู Fallback):
```typescript
// ุงูุจุญุซ ุนู ุนููู ูููู
let branchAsCustomer = await tx.customer.findFirst({
  where: {
    phone: `BRANCH-${data.branchCompanyId}`
  }
});

// ุฅุฐุง ูู ููุฌุฏุ ุฃูุดุฆู (fallback)
if (!branchAsCustomer) {
  branchAsCustomer = await tx.customer.create({
    data: {
      name: branchCompany.name,
      phone: `BRANCH-${data.branchCompanyId}`,
      note: `ุนููู ูููู ููุซู ุงูุดุฑูุฉ ุงููุฑุนูุฉ: ${branchCompany.name}`
    }
  });
}
```

### ุงููุงุฆุฏุฉ:
- **ุงูุญุงูุฉ ุงูุนุงุฏูุฉ**: ุงูุนููู ุงููููู ููุฌูุฏ (ุชู ุฅูุดุงุคู ูุน ุงูุดุฑูุฉ)
- **ุญุงูุฉ ุงูุทูุงุฑุฆ**: ุฅุฐุง ูู ููู ููุฌูุฏุ ูุชู ุฅูุดุงุคู (fallback)
- **ุงููุชูุฌุฉ**: ุงููุธุงู ูุนูู ูู ุฌููุน ุงูุญุงูุงุช

---

## ๐งช ุงูุงุฎุชุจุงุฑ:

### 1. ุฅุถุงูุฉ ุดุฑูุฉ ูุฑุนูุฉ ุฌุฏูุฏุฉ:
```
POST /api/company/companies
{
  "name": "ุดุฑูุฉ ุงูุฅูุงุฑุงุช",
  "code": "EMR",
  "isParent": false,
  "parentId": 1
}
```

### 2. ุงูุชุญูู ูู ุฅูุดุงุก ุงูุนููู ุงููููู:
```sql
SELECT * FROM Customer 
WHERE phone = 'BRANCH-2';

-- ุงููุชูุฌุฉ ุงููุชููุนุฉ:
-- id: 10
-- name: ุดุฑูุฉ ุงูุฅูุงุฑุงุช
-- phone: BRANCH-2
-- note: ุนููู ูููู ููุซู ุงูุดุฑูุฉ ุงููุฑุนูุฉ: ุดุฑูุฉ ุงูุฅูุงุฑุงุช
```

### 3. ุฅูุดุงุก ุนูููุฉ ุจูุน ูุนูุฏุฉ:
```
- ุงูุดุฑูุฉ ุงูุฃู: ุงูุชูุงุฒู (ID: 1)
- ุงูุดุฑูุฉ ุงููุฑุนูุฉ: ุงูุฅูุงุฑุงุช (ID: 2)
- ุงูุนููู: ูุญูุฏ ุฃุญูุฏ
```

### 4. ุงูุชุญูู ูู ุงููุงุชูุฑุฉ:
```sql
SELECT * FROM Sale 
WHERE companyId = 1 
AND customerId = 10;

-- ูุฌุจ ุฃู ุชุธูุฑ ูุงุชูุฑุฉ ูู ุงูุชูุงุฒู ููุฅูุงุฑุงุช (ูุนููู)
```

---

## ๐ก ุงูููุงุฆุฏ:

### 1. **ุชูุธูู ุฃูุถู**:
- ุงูุนููู ุงููููู ูููุดุฃ ูุฑุฉ ูุงุญุฏุฉ ููุท
- ูุง ุญุงุฌุฉ ููุชุญูู ูู ูู ุนูููุฉ ุจูุน

### 2. **ุฃุฏุงุก ูุญุณู**:
- ุชูููู ุนูููุงุช ุงูุจุญุซ ูุงูุฅูุดุงุก
- ุงูุนููู ุงููููู ุฌุงูุฒ ุฏุงุฆูุงู

### 3. **ูุถูุญ ุฃูุจุฑ**:
- ูู ุฌุฏูู ุงูุนููุงุกุ ูููู ุฑุคูุฉ ุฌููุน ุงูุดุฑูุงุช ุงููุฑุนูุฉ ูุนููุงุก
- ุงูููุงุญุธุฉ ุชูุถุญ ุฃูู ุนููู ูููู

### 4. **ุณูููุฉ ุงูุชุชุจุน**:
- ูููู ุงูุจุญุซ ุนู ุฌููุน ุงูุนููุงุก ุงููููููู: `phone LIKE 'BRANCH-%'`
- ูููู ูุนุฑูุฉ ุฃู ุดุฑูุฉ ูู ุงููุนุฑู: `BRANCH-2` = ุดุฑูุฉ ID 2

---

## ๐ ุญุงูุงุช ุฎุงุตุฉ:

### 1. ุฅุฐุง ูุดู ุฅูุดุงุก ุงูุนููู ุงููููู:
```typescript
catch (customerError) {
  console.error('โ๏ธ Failed to create dummy customer (non-critical):', customerError);
  // ูุง ูุฑูู ุฎุทุฃ - ุงูุดุฑูุฉ ุชู ุฅูุดุงุคูุง ุจูุฌุงุญ
}
```
- ุงูุดุฑูุฉ ุชููุดุฃ ุจูุฌุงุญ
- ูุชู ุชุณุฌูู ุงูุฎุทุฃ ูู ุงูู logs
- ุงููุจูุนุงุช ุงููุนูุฏุฉ ุณุชูุดุฆ ุงูุนููู ุนูุฏ ุงูุญุงุฌุฉ (fallback)

### 2. ุฅุฐุง ูุงูุช ุงูุดุฑูุฉ ุฃู:
```typescript
if (!data.isParent && result.id) {
  // ููุท ููุดุฑูุงุช ุงููุฑุนูุฉ
}
```
- ูุง ูุชู ุฅูุดุงุก ุนููู ูููู ููุดุฑูุงุช ุงูุฃู
- ุงูุดุฑูุงุช ุงูุฃู ูุง ุชุญุชุงุฌ ุนููุงุก ูููููู

### 3. ุฅุฐุง ูุงู ุงูุนููู ุงููููู ููุฌูุฏ ูุณุจูุงู:
- ุณููุดู ุงูุฅูุดุงุก ุจุณุจุจ unique constraint ุนูู `phone`
- ูุชู ุงูุชุนุงูู ูุนู ูู catch block
- ูุง ูุคุซุฑ ุนูู ุฅูุดุงุก ุงูุดุฑูุฉ

---

## ๐ ุงูููู ุงููุญุฏุซ:
- โ `/server/src/services/CompanyService.ts`
  - ุฏุงูุฉ `createCompany()`

---

## โจ ุงููุชูุฌุฉ ุงูููุงุฆูุฉ:

ุงูุขู ุนูุฏ ุฅุถุงูุฉ ุดุฑูุฉ ูุฑุนูุฉ:
- โ **ุงูุดุฑูุฉ ุชููุดุฃ ุจูุฌุงุญ**
- โ **ุนููู ูููู ูููุดุฃ ุชููุงุฆูุงู**
- โ **ูุนูููุงุช ูุงุถุญุฉ** (ุงูุงุณูุ ุงููุนุฑูุ ุงูููุงุญุธุฉ)
- โ **ุฌุงูุฒ ูููุจูุนุงุช ุงููุนูุฏุฉ** ููุฑุงู
- โ **ูุธูุฑ ูู ุงููุจูุนุงุช ุงูุขุฌูุฉ** ุชููุงุฆูุงู

**ุงููุธุงู ุงูุขู ุฃูุซุฑ ุชูุธููุงู ูููุงุกุฉ!** ๐
