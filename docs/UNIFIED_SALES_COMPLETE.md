# โ ูุธุงู ุงููุจูุนุงุช ุงูููุญุฏ ููููุงุชูุฑ ุงููุฎุชูุทุฉ

## ๐ ูุธุฑุฉ ุนุงูุฉ

ุชู ุชุญุฏูุซ ูุธุงู ุงููุจูุนุงุช ููุฏุนู ุงูููุงุชูุฑ ุงููุฎุชูุทุฉ (ุฃุตูุงู ูู ุงูุดุฑูุฉ ุงูุฃู + ุงูุดุฑูุฉ ุงูุชุงุจุนุฉ) ุจุทุฑููุฉ ููุญุฏุฉ.

---

## ๐ฏ ุงููุชุทูุจ ุงูุฃุณุงุณู

ุนูุฏูุง ุชุญุชูู ูุงุชูุฑุฉ ุงููุจูุนุงุช ุนูู ุฃุตูุงู ูู ุงูุดุฑูุฉ ุงูุฃู ูุงูุดุฑูุฉ ุงูุชุงุจุนุฉ ูุนุงูุ ูุฌุจ ุฃู ูุชู:

### โ ูุง ูุญุฏุซ ุงูุขู:

1. **ูุงุชูุฑุฉ ุจูุน ูุงุญุฏุฉ ููุนููู** ูู ุงูุดุฑูุฉ ุงูุชุงุจุนุฉ
   - ุชุญุชูู ุนูู **ุฌููุน ุงูุฃุตูุงู** (ูู ุงูุดุฑูุฉ ุงูุฃู + ูู ุงูุดุฑูุฉ ุงูุชุงุจุนุฉ)
   - ุจุณุนุฑ ุจูุน ุงูุดุฑูุฉ ุงูุชุงุจุนุฉ
   
2. **ูุงุชูุฑุฉ ุจูุน ุขุฌูุฉ** ูู ุงูุดุฑูุฉ ุงูุฃู โ ุงูุดุฑูุฉ ุงูุชุงุจุนุฉ (ูุนููู)
   - ุชุญุชูู ููุท ุนูู **ุงูุฃุตูุงู ูู ุงูุดุฑูุฉ ุงูุฃู**
   - ุจุณุนุฑ ุจูุน ุงูุดุฑูุฉ ุงูุฃู
   - ููุน ุงููุงุชูุฑุฉ: **ุขุฌู (CREDIT)** ุฏุงุฆูุงู
   
3. **ูุงุชูุฑุฉ ูุดุชุฑูุงุช** ููุดุฑูุฉ ุงูุชุงุจุนุฉ ูู ุงูุดุฑูุฉ ุงูุฃู
   - ุชุญุชูู ุนูู ููุณ ุงูุฃุตูุงู ูู ุงูุดุฑูุฉ ุงูุฃู
   - ุจุณุนุฑ ุจูุน ุงูุดุฑูุฉ ุงูุฃู

---

## ๐ง ุงูุชุนุฏููุงุช ุงููุทุจูุฉ

### 1. Backend - ComplexInterCompanySaleService

#### ุงูุชุนุฏููุงุช ุงูุฑุฆูุณูุฉ:

```typescript
// ุชู ุฅุถุงูุฉ ุญูู isFromParentCompany ููุชูููุฒ ุจูู ุงูุฃุตูุงู
export interface ComplexInterCompanySaleLine {
  productId: number;
  qty: number;
  parentUnitPrice?: number; // ููุท ููุฃุตูุงู ูู ุงูุดุฑูุฉ ุงูุฃู
  branchUnitPrice: number;
  subTotal: number;
  isFromParentCompany?: boolean; // ุฌุฏูุฏ
}
```

#### ููุทู ุงูุนูู ุงูุฌุฏูุฏ:

1. **ูุตู ุงูุฃุตูุงู**:
   ```typescript
   const parentCompanyLines = data.lines.filter(line => line.isFromParentCompany);
   const branchCompanyLines = data.lines.filter(line => !line.isFromParentCompany);
   ```

2. **ุงูุชุญูู ูู ุงููุฎุฒูู**:
   - ุฃุตูุงู ุงูุดุฑูุฉ ุงูุฃู โ ุงูุชุญูู ูู ูุฎุฒูู ุงูุดุฑูุฉ ุงูุฃู
   - ุฃุตูุงู ุงูุดุฑูุฉ ุงูุชุงุจุนุฉ โ ุงูุชุญูู ูู ูุฎุฒูู ุงูุดุฑูุฉ ุงูุชุงุจุนุฉ

3. **ุฎุตู ุงููุฎุฒูู**:
   - ุฃุตูุงู ุงูุดุฑูุฉ ุงูุฃู โ ุฎุตู ูู ูุฎุฒูู ุงูุดุฑูุฉ ุงูุฃู
   - ุฃุตูุงู ุงูุดุฑูุฉ ุงูุชุงุจุนุฉ โ ุฎุตู ูู ูุฎุฒูู ุงูุดุฑูุฉ ุงูุชุงุจุนุฉ

4. **ุฅูุดุงุก ุงูููุงุชูุฑ**:
   - ูุงุชูุฑุฉ ูุงุญุฏุฉ ููุนููู ุชุญุชูู ุนูู **ูู ุงูุฃุตูุงู**
   - ูุงุชูุฑุฉ ุจูุน ุขุฌูุฉ ูู ุงูุดุฑูุฉ ุงูุฃู (ููุท ุฅุฐุง ูุงูุช ููุงู ุฃุตูุงู ูู ุงูุดุฑูุฉ ุงูุฃู)
   - ูุงุชูุฑุฉ ูุดุชุฑูุงุช ูู ุงูุดุฑูุฉ ุงูุฃู (ููุท ุฅุฐุง ูุงูุช ููุงู ุฃุตูุงู ูู ุงูุดุฑูุฉ ุงูุฃู)

### 2. Frontend - sales/page.tsx

#### ุงูุชุนุฏูู ุงูุฑุฆูุณู ูู handleComplexInterCompanySale:

```typescript
// ุงูุขู ูุชู ุชูุฑูุฑ ุฌููุน ุงูุฃุตูุงู (ูู ุงูุดุฑูุฉ ุงูุฃู + ูู ุงูุดุฑูุฉ ุงูุชุงุจุนุฉ)
const complexLines: ComplexInterCompanySaleLine[] = saleForm.lines.map(line => {
  const product = productsData?.data?.products?.find(p => p.id === line.productId);
  
  let branchUnitPrice = line.unitPrice;
  let parentUnitPrice: number | undefined = undefined;
  
  // ุฅุฐุง ูุงู ูู ุงูุดุฑูุฉ ุงูุฃู
  if (line.isFromParentCompany) {
    parentUnitPrice = line.parentUnitPrice || line.unitPrice;
    branchUnitPrice = line.branchUnitPrice || (parentUnitPrice * (1 + profitMargin / 100));
    
    // ูุนุงูุฌุฉ ุงูุตูุงุฏูู
    if (product?.unit === 'ุตูุฏูู' && product.unitsPerBox) {
      parentUnitPrice = parentUnitPrice * Number(product.unitsPerBox);
      branchUnitPrice = branchUnitPrice * Number(product.unitsPerBox);
    }
  } else {
    // ุฃุตูุงู ูู ุงูุดุฑูุฉ ุงูุชุงุจุนุฉ
    branchUnitPrice = line.unitPrice;
    
    // ูุนุงูุฌุฉ ุงูุตูุงุฏูู
    if (product?.unit === 'ุตูุฏูู' && product.unitsPerBox) {
      branchUnitPrice = branchUnitPrice * Number(product.unitsPerBox);
    }
  }
  
  return {
    productId: line.productId,
    qty: line.qty,
    parentUnitPrice,
    branchUnitPrice,
    subTotal: line.qty * branchUnitPrice,
    isFromParentCompany: line.isFromParentCompany || false
  };
});
```

---

## ๐ ูุซุงู ุนููู

### ุงูุณููุงุฑูู:
ุดุฑูุฉ ุงูุฅูุงุฑุงุช (ุงููุฑุน) ุชุจูุน ููุนููู "ุฃุญูุฏ ูุญูุฏ":
- 10 ุตูุงุฏูู ุจูุงุท ุณูุฑุงููู (ูู ุงูุดุฑูุฉ ุงูุฃู - ุงูุชูุงุฒู)
- 5 ุตูุงุฏูู ุจูุงุท ุญูุงูุงุช (ูู ุดุฑูุฉ ุงูุฅูุงุฑุงุช ููุณูุง)

### ุงูุจูุงูุงุช:
```
ุจูุงุท ุณูุฑุงููู (ูู ุงูุชูุงุฒู):
  - ุณุนุฑ ุงูุชูุงุฒู: 50 ุฏ.ู
  - ุณุนุฑ ุงูุฅูุงุฑุงุช: 60 ุฏ.ู (ูุงูุด ุฑุจุญ 20%)
  - ุงููููุฉ: 10 ุตูุงุฏูู

ุจูุงุท ุญูุงูุงุช (ูู ุงูุฅูุงุฑุงุช):
  - ุณุนุฑ ุงูุฅูุงุฑุงุช: 80 ุฏ.ู
  - ุงููููุฉ: 5 ุตูุงุฏูู
```

### ุงููุชูุฌุฉ:

#### โ 1. ูุงุชูุฑุฉ ุจูุน ููุนููู (ูู ุงูุฅูุงุฑุงุช):
```
ุงูุนููู: ุฃุญูุฏ ูุญูุฏ
ุงูุดุฑูุฉ: ุงูุฅูุงุฑุงุช
ุงูุจููุฏ:
  - 10 ุตูุงุฏูู ุจูุงุท ุณูุฑุงููู ร 60 ุฏ.ู = 600 ุฏ.ู
  - 5 ุตูุงุฏูู ุจูุงุท ุญูุงูุงุช ร 80 ุฏ.ู = 400 ุฏ.ู
ุงูุฅุฌูุงูู: 1,000 ุฏ.ู
```

#### โ 2. ูุงุชูุฑุฉ ุจูุน ุขุฌูุฉ (ูู ุงูุชูุงุฒู โ ุงูุฅูุงุฑุงุช):
```
ุงูุนููู: ุดุฑูุฉ ุงูุฅูุงุฑุงุช (ูุนููู ูููู)
ุงูุดุฑูุฉ: ุงูุชูุงุฒู
ุงูุจููุฏ:
  - 10 ุตูุงุฏูู ุจูุงุท ุณูุฑุงููู ร 50 ุฏ.ู = 500 ุฏ.ู
ุงูุฅุฌูุงูู: 500 ุฏ.ู
ููุน ุงูุจูุน: ุขุฌู (CREDIT)
```

#### โ 3. ูุงุชูุฑุฉ ูุดุชุฑูุงุช (ููุฅูุงุฑุงุช ูู ุงูุชูุงุฒู):
```
ุงูุดุฑูุฉ ุงููุดุชุฑูุฉ: ุงูุฅูุงุฑุงุช
ุงูููุฑุฏ: ุงูุชูุงุฒู
ุงูุจููุฏ:
  - 10 ุตูุงุฏูู ุจูุงุท ุณูุฑุงููู ร 50 ุฏ.ู = 500 ุฏ.ู
ุงูุฅุฌูุงูู: 500 ุฏ.ู
ุงูุญุงูุฉ: ุบูุฑ ูุณุฏุฏุฉ
```

#### ๐ฆ ุชุญุฏูุซ ุงููุฎุฒูู:
- ูุฎุฒูู ุงูุชูุงุฒู: -10 ุจูุงุท ุณูุฑุงููู
- ูุฎุฒูู ุงูุฅูุงุฑุงุช: -5 ุจูุงุท ุญูุงูุงุช

---

## ๐ฏ ุงูููุงุฆุฏ

### โ 1. ุชุฌุฑุจุฉ ูุณุชุฎุฏู ุฃูุถู:
- ูุงุชูุฑุฉ ูุงุญุฏุฉ ููุนููู ุชุญุชูู ุนูู ูู ุงูุฃุตูุงู
- ูุง ุฏุงุนู ูุฅูุดุงุก ููุงุชูุฑ ูููุตูุฉ ูุฏููุงู

### โ 2. ุฏูุฉ ูุญุงุณุจูุฉ:
- ุชุชุจุน ุฏููู ููุฏููููุฉ ุงูุดุฑูุฉ ุงูุชุงุจุนุฉ ููุดุฑูุฉ ุงูุฃู
- ูุตู ูุงุถุญ ุจูู ุงูุฃุตูุงู ูู ูู ุดุฑูุฉ

### โ 3. ุฅุฏุงุฑุฉ ูุฎุฒูู ุตุญูุญุฉ:
- ุฎุตู ุงููุฎุฒูู ูู ุงูุดุฑูุฉ ุงูุตุญูุญุฉ ููู ุตูู
- ุชุชุจุน ุฏููู ูุญุฑูุฉ ุงููุฎุฒูู

---

## ๐ ุณูุฑ ุงูุนูู

### ูู ุดุงุดุฉ ุงููุจูุนุงุช:

1. **ุงุฎุชูุงุฑ ุงูุดุฑูุฉ**:
   ```
   ุงุฎุชุฑ ุงูุดุฑูุฉ: ุงูุฅูุงุฑุงุช
   ```

2. **ุงุฎุชูุงุฑ ุงูุนููู**:
   ```
   ุงูุนููู: ุฃุญูุฏ ูุญูุฏ
   ```

3. **ุฅุถุงูุฉ ุงูุฃุตูุงู**:
   ```
   ุงูุจูุฏ 1: ุจูุงุท ุณูุฑุงููู (ูู ุงูุดุฑูุฉ ุงูุฃู) - 10 ุตูุงุฏูู
   ุงูุจูุฏ 2: ุจูุงุท ุญูุงูุงุช (ูู ุงูุฅูุงุฑุงุช) - 5 ุตูุงุฏูู
   ```

4. **ุงููุธุงู ููุชุดู ุชููุงุฆูุงู**:
   ```
   โ ูุฐู ูุงุชูุฑุฉ ูุฎุชูุทุฉ (ุฃุตูุงู ูู ุดุฑูุชูู)
   โ ุณูุชู ุงุณุชุฎุฏุงู ูุธุงู ุงููุจูุนุงุช ุงููุนูุฏ
   ```

5. **ุนูุฏ ุงูุญูุธ**:
   ```
   โ ุฅูุดุงุก ูุงุชูุฑุฉ ูุงุญุฏุฉ ููุนููู
   โ ุฅูุดุงุก ูุงุชูุฑุฉ ุจูุน ุขุฌูุฉ ูู ุงูุชูุงุฒู
   โ ุฅูุดุงุก ูุงุชูุฑุฉ ูุดุชุฑูุงุช ูู ุงูุชูุงุฒู
   โ ุฎุตู ุงููุฎุฒูู ูู ุงูุดุฑูุชูู
   ```

6. **ุงูุฑุณุงูุฉ ูููุณุชุฎุฏู**:
   ```
   ุชู ุจูุฌุงุญ! 
   ุชู ุฅูุดุงุก ุงูููุงุชูุฑ ุงููุทููุจุฉ:
   - ูุงุชูุฑุฉ ูุจูุนุงุช ูุงุญุฏุฉ ููุนููู (ุชุญุชูู ุนูู ูู ุงูุฃุตูุงู)
   - ูุงุชูุฑุฉ ูุจูุนุงุช ูู ุงูุดุฑูุฉ ุงูุฃู (ุขุฌูุฉ)
   - ูุงุชูุฑุฉ ูุดุชุฑูุงุช ูู ุงูุดุฑูุฉ ุงูุฃู
   ุฌููุน ุงูููุงุชูุฑ ูู ุงูุชุธุงุฑ ููุงููุฉ ุงููุญุงุณุจ
   ```

---

## ๐ ููุงุญุธุงุช ูููุฉ

### 1. ูุงุชูุฑุฉ ุงูุดุฑูุฉ ุงูุฃู ุขุฌูุฉ ุฏุงุฆูุงู:
- ูุง ูููู ุชุบููุฑ ูุฐุง ุงูุณููู
- ุงูุดุฑูุฉ ุงูุชุงุจุนุฉ ุชุฏูุน ูุงุญูุงู ููุดุฑูุฉ ุงูุฃู

### 2. ุงูุฃุณุนุงุฑ:
- ุณุนุฑ ุงูุดุฑูุฉ ุงูุฃู: ูู ุฌุฏูู `CompanyProductPrice`
- ุณุนุฑ ุงูุดุฑูุฉ ุงูุชุงุจุนุฉ: ุณุนุฑ ุงูุดุฑูุฉ ุงูุฃู + ูุงูุด ุงูุฑุจุญ (ุงูุชุฑุงุถู 20%)

### 3. ุงููุฎุฒูู:
- ูุชู ุฎุตู ุงููุฎุฒูู ูู ุงูุดุฑูุฉ ุงูุตุญูุญุฉ ููู ุตูู
- ุฃุตูุงู ุงูุดุฑูุฉ ุงูุฃู โ ุฎุตู ูู ูุฎุฒูู ุงูุดุฑูุฉ ุงูุฃู
- ุฃุตูุงู ุงูุดุฑูุฉ ุงูุชุงุจุนุฉ โ ุฎุตู ูู ูุฎุฒูู ุงูุดุฑูุฉ ุงูุชุงุจุนุฉ

### 4. ุงูุตูุงุญูุงุช:
- ุงููุณุชุฎุฏู ุงูุนุงุฏู: ููููู ุงูุจูุน ูู ุดุฑูุชู ููุท
- ูุณุชุฎุฏู ุงููุธุงู: ููููู ุงูุจูุน ูู ุฃู ุดุฑูุฉ

---

## โ ูุงุฆูุฉ ุงูุชุญูู

- [x] ุชุญุฏูุซ `ComplexInterCompanySaleService.ts` - Backend
- [x] ุชุญุฏูุซ `ComplexInterCompanySaleLine` interface - Backend
- [x] ุชุญุฏูุซ `ComplexInterCompanySaleResult` interface - Backend
- [x] ุฅุถุงูุฉ ุฏุนู `isFromParentCompany` - Backend
- [x] ูุตู ุงูุฃุตูุงู ุญุณุจ ุงูุดุฑูุฉ - Backend
- [x] ุงูุชุญูู ูู ุงููุฎุฒูู ููู ุดุฑูุฉ - Backend
- [x] ุฎุตู ุงููุฎุฒูู ูู ุงูุดุฑูุฉ ุงูุตุญูุญุฉ - Backend
- [x] ุฅูุดุงุก ูุงุชูุฑุฉ ูุงุญุฏุฉ ููุนููู - Backend
- [x] ุฅูุดุงุก ููุงุชูุฑ ุงูุดุฑูุฉ ุงูุฃู (ุฅุฐุง ูุฒู) - Backend
- [x] ุชุญุฏูุซ `complexInterCompanySalesApi.ts` - Frontend
- [x] ุชุญุฏูุซ `sales/page.tsx` - Frontend
- [x] ุชุญุฏูุซ `handleComplexInterCompanySale` - Frontend
- [x] ุชูุฑูุฑ ุฌููุน ุงูุฃุตูุงู ููู API - Frontend
- [x] ุชุญุฏูุซ ุฑุณุงุฆู ุงููุฌุงุญ - Frontend
- [x] ูุง ุชูุฌุฏ ุฃุฎุทุงุก ูู ุงูู Linter

---

## ๐ ุงูุงุณุชุฎุฏุงู

### ูููุทูุฑูู:

ุงููุธุงู ุฌุงูุฒ ููุนูู! ูุง ุญุงุฌุฉ ูุฃู ุฅุนุฏุงุฏุงุช ุฅุถุงููุฉ.

### ูููุณุชุฎุฏููู:

1. ุงูุชุญ ุดุงุดุฉ ุงููุจูุนุงุช
2. ุงุฎุชุฑ ุงูุดุฑูุฉ (ููุดุฑูุงุช ุงูุชุงุจุนุฉ)
3. ุฃุถู ุฃุตูุงู ูู ุงูุดุฑูุฉ ุงูุฃู ูุงูุดุฑูุฉ ุงูุชุงุจุนุฉ
4. ุงุญูุธ ุงููุงุชูุฑุฉ
5. ุณูุชู ุฅูุดุงุก ุฌููุน ุงูููุงุชูุฑ ุงููุทููุจุฉ ุชููุงุฆูุงู!

---

## ๐ ุงูุฏุนู

ุฅุฐุง ูุงุฌูุช ุฃู ูุดุงูู:
1. ุชุญูู ูู ูุฌูุฏ ุฃุณุนุงุฑ ููุฃุตูุงู ูู ุงูุดุฑูุฉ ุงูุฃู
2. ุชุญูู ูู ุชููุฑ ุงููุฎุฒูู ูู ุงูุดุฑูุชูู
3. ุชุญูู ูู ุตูุงุญูุงุช ุงููุณุชุฎุฏู

---

**โ ุงููุธุงู ุฌุงูุฒ 100% ููุนูู!**

ุชุงุฑูุฎ ุงูุฅูุฌุงุฒ: 2025-11-02
