# ููุฒุฉ ุชุนุฏูู ุงูููุงุชูุฑ ุงููุนูุฏุฉ (ุงูุฅูุงุฑุงุช + ุงูุชูุงุฒู)

## ๐ฏ ุงูููุฒุงุช ุงููุทุจูุฉ

### 1. **ุญูุงูุฉ ูุงุชูุฑุฉ ุงูุชูุงุฒู ูู ุงูุชุนุฏูู ุงููุจุงุดุฑ** ๐ก๏ธ

```
โ ูุง ูููู ุชุนุฏูู ูุงุชูุฑุฉ ุงูุชูุงุฒู ูุจุงุดุฑุฉ
(ูุฃููุง ูุงุชูุฑุฉ ุชููุงุฆูุฉ ุชู ุฅูุดุงุคูุง ูู ูุงุชูุฑุฉ ุงูุฅูุงุฑุงุช)
```

### 2. **ุชุญุฏูุซ ุชููุงุฆู ููุงุชูุฑุฉ ุงูุชูุงุฒู** ๐

```
โ ุชุนุฏูู ูุงุชูุฑุฉ ุงูุฅูุงุฑุงุช โ ุชุญุฏูุซ ูุงุชูุฑุฉ ุงูุชูุงุฒู ุชููุงุฆูุงู
(ูุชู ุชุญุฏูุซ ุฃุตูุงู ุงูุชูุงุฒู ููุท)
```

---

## ๐ก๏ธ ุงูููุฒุฉ 1: ุญูุงูุฉ ูุงุชูุฑุฉ ุงูุชูุงุฒู

### ุงููููุน ูู ุงูููุฏ:
```typescript
// server/src/services/SalesService.ts
// ุฏุงูุฉ updateSale() - ุงูุณุทูุฑ 380-405

// ๐ก๏ธ ููุน ุงูุชุนุฏูู ุงููุจุงุดุฑ ุนูู ููุงุชูุฑ ุงูุชูุงุฒู ุงูุชููุงุฆูุฉ
const parentComplexSale = await this.prisma.sale.findFirst({
  where: {
    OR: [
      { relatedParentSaleId: id },      // ูุงุชูุฑุฉ ุงูุชูุงุฒู
      { relatedBranchPurchaseId: id }   // ูุงุชูุฑุฉ ุงููุดุชุฑูุงุช
    ]
  },
  select: {
    id: true,
    invoiceNumber: true,
    customer: { select: { name: true } }
  }
});

if (parentComplexSale) {
  const customerName = parentComplexSale.customer?.name || 'ุบูุฑ ูุญุฏุฏ';
  const invoiceRef = parentComplexSale.invoiceNumber || `#${parentComplexSale.id}`;
  throw new Error(
    `โ ูุง ูููู ุชุนุฏูู ูุฐู ุงููุงุชูุฑุฉ ูุจุงุดุฑุฉ!\n\n` +
    `ูุฐู ูุงุชูุฑุฉ ุชู ุฅูุดุงุคูุง ุชููุงุฆูุงู ูู ูุงุชูุฑุฉ ูุนูุฏุฉ.\n\n` +
    `๐ ุงููุงุชูุฑุฉ ุงูุฃุตููุฉ: ${invoiceRef}\n` +
    `๐ค ุงูุนููู: ${customerName}\n\n` +
    `๐ก ูุชุนุฏูู ูุฐู ุงููุงุชูุฑุฉุ ุงุฐูุจ ุฅูู ุงููุงุชูุฑุฉ ุงูุฃุตููุฉ ูุนุฏูููุง.`
  );
}
```

### ุงูุณููู:
- **ุนูุฏ ูุญุงููุฉ ุชุนุฏูู ูุงุชูุฑุฉ ุงูุชูุงุฒู ูุจุงุดุฑุฉ:**
  ```
  โ ุฎุทุฃ!
  "ูุง ูููู ุชุนุฏูู ูุฐู ุงููุงุชูุฑุฉ ูุจุงุดุฑุฉ!
  
  ูุฐู ูุงุชูุฑุฉ ุชู ุฅูุดุงุคูุง ุชููุงุฆูุงู ูู ูุงุชูุฑุฉ ูุนูุฏุฉ.
  
  ๐ ุงููุงุชูุฑุฉ ุงูุฃุตููุฉ: #5
  ๐ค ุงูุนููู: ุงูุฅูุงุฑุงุช
  
  ๐ก ูุชุนุฏูู ูุฐู ุงููุงุชูุฑุฉุ ุงุฐูุจ ุฅูู ุงููุงุชูุฑุฉ ุงูุฃุตููุฉ ูุนุฏูููุง."
  ```

---

## ๐ ุงูููุฒุฉ 2: ุชุญุฏูุซ ุชููุงุฆู ููุงุชูุฑุฉ ุงูุชูุงุฒู

### ุงููููุน ูู ุงูููุฏ:
```typescript
// server/src/services/SalesService.ts
// ุฏุงูุฉ updateSale() - ุงูุณุทูุฑ 618-671

// ๐ ุชุญุฏูุซ ูุงุชูุฑุฉ ุงูุชูุงุฒู ุงููุฑุชุจุทุฉ ุฅุฐุง ูุงูุช ููุฌูุฏุฉ
if (data.lines && existingSale.relatedParentSaleId) {
  console.log('๐ ุชุญุฏูุซ ูุงุชูุฑุฉ ุงูุชูุงุฒู ุงููุฑุชุจุทุฉ...');
  
  // ูุตู ุฃุตูุงู ุงูุชูุงุฒู ูู ุงูุจููุฏ ุงูุฌุฏูุฏุฉ
  const parentCompanyLines = data.lines.filter(line => {
    const product = updatedSale.lines.find(l => l.productId === line.productId)?.product;
    return product && product.createdByCompanyId === 1; // ID ุงูุดุฑูุฉ ุงูุฃู = 1
  });

  if (parentCompanyLines.length > 0) {
    // ุญุฐู ุงูุจููุฏ ุงููุฏููุฉ ูู ูุงุชูุฑุฉ ุงูุชูุงุฒู
    await this.prisma.saleLine.deleteMany({
      where: { saleId: existingSale.relatedParentSaleId }
    });

    // ุญุณุงุจ ุงููุฌููุน ุงูุฌุฏูุฏ ููุงุชูุฑุฉ ุงูุชูุงุฒู
    let parentSaleTotal = 0;
    const parentSaleNewLines = [];

    for (const line of parentCompanyLines) {
      const product = updatedSale.lines.find(l => l.productId === line.productId)?.product;
      if (!product) continue;

      // ุงุณุชุฎุฏุงู ููุณ ุงูุณุนุฑ ูู ุงููุงุชูุฑุฉ ุงูุฃุตููุฉ
      const lineTotal = line.qty * line.unitPrice;
      parentSaleTotal += lineTotal;

      parentSaleNewLines.push({
        productId: line.productId,
        qty: line.qty,
        unitPrice: line.unitPrice,
        subTotal: lineTotal
      });
    }

    // ุชุญุฏูุซ ูุงุชูุฑุฉ ุงูุชูุงุฒู
    await this.prisma.sale.update({
      where: { id: existingSale.relatedParentSaleId },
      data: {
        total: parentSaleTotal,
        lines: {
          create: parentSaleNewLines
        }
      }
    });

    console.log('โ ุชู ุชุญุฏูุซ ูุงุชูุฑุฉ ุงูุชูุงุฒู ุจูุฌุงุญ');
  } else {
    // ูุง ุชูุฌุฏ ุฃุตูุงู ุชูุงุฒู ูู ุงูุชุนุฏูู ุงูุฌุฏูุฏ
    console.log('โ๏ธ ูุง ุชูุฌุฏ ุฃุตูุงู ุชูุงุฒู ูู ุงูุชุนุฏูู ุงูุฌุฏูุฏ');
  }
}
```

### ุงูุณููู:
```
1. ุงููุณุชุฎุฏู ูุนุฏูู ูุงุชูุฑุฉ ุงูุฅูุงุฑุงุช
   โ
2. ูุบููุฑ ุฃุตูุงู ุงูุชูุงุฒู (ูููุฉ/ุณุนุฑ/ุฅุถุงูุฉ/ุญุฐู)
   โ
3. ุงููุธุงู ูุชุญูู: ูู ูุฐู ูุงุชูุฑุฉ ูุนูุฏุฉุ
   โ
4. โ ูุนู โ ูุตู ุฃุตูุงู ุงูุชูุงุฒู
   โ
5. ุญุฐู ุงูุจููุฏ ุงููุฏููุฉ ูู ูุงุชูุฑุฉ ุงูุชูุงุฒู
   โ
6. ุฅุถุงูุฉ ุงูุจููุฏ ุงูุฌุฏูุฏุฉ ููุงุชูุฑุฉ ุงูุชูุงุฒู
   โ
7. ุชุญุฏูุซ ุงููุฌููุน ุงูููู
   โ
8. โ ุชู ุชุญุฏูุซ ูุงุชูุฑุฉ ุงูุชูุงุฒู ุชููุงุฆูุงู!
```

---

## ๐ ุณููุงุฑูููุงุช ุงูุงุณุชุฎุฏุงู

### ุงูุณููุงุฑูู 1: ูุญุงููุฉ ุชุนุฏูู ูุงุชูุฑุฉ ุงูุชูุงุฒู ูุจุงุดุฑุฉ โ

```
ุงููุณุชุฎุฏู โ ุดุงุดุฉ ุงููุจูุนุงุช
    โ
ูุจุญุซ ุนู ูุงุชูุฑุฉ ุงูุชูุงุฒู
    โ
ูููุฑ "ุชุนุฏูู"
    โ
ุงููุธุงู: โ ุฎุทุฃ!
"ูุง ูููู ุชุนุฏูู ูุฐู ุงููุงุชูุฑุฉ ูุจุงุดุฑุฉ!
ุงุฐูุจ ุฅูู ุงููุงุชูุฑุฉ ุงูุฃุตููุฉ (ุงูุฅูุงุฑุงุช) ูุนุฏูููุง."
```

---

### ุงูุณููุงุฑูู 2: ุชุนุฏูู ูุงุชูุฑุฉ ุงูุฅูุงุฑุงุช (ูุน ุฃุตูุงู ุงูุชูุงุฒู) โ

```
ุงููุณุชุฎุฏู โ ุดุงุดุฉ ุงููุจูุนุงุช
    โ
ูุจุญุซ ุนู ูุงุชูุฑุฉ ุงูุฅูุงุฑุงุช
    โ
ูููุฑ "ุชุนุฏูู"
    โ
ูุบููุฑ:
  - ุตูู ุงูุชูุงุฒู A: ุงููููุฉ ูู 10 ุฅูู 15 โ๏ธ
  - ุตูู ุงูุชูุงุฒู B: ุงูุณุนุฑ ูู 100 ุฅูู 120 โ๏ธ
  - ุตูู ุงูุฅูุงุฑุงุช C: ุงููููุฉ ูู 5 ุฅูู 8 โ๏ธ
    โ
ูููุฑ "ุญูุธ"
    โ
ุงููุธุงู ูููู ุจู:
  โ ุชุญุฏูุซ ูุงุชูุฑุฉ ุงูุฅูุงุฑุงุช
  โ ุชุญุฏูุซ ูุงุชูุฑุฉ ุงูุชูุงุฒู (ุชููุงุฆูุงู)
     - ุตูู A: 10 โ 15 โ
     - ุตูู B: 100 โ 120 โ
     (ุตูู C ูุง ููุญุฏูุซ ูู ูุงุชูุฑุฉ ุงูุชูุงุฒู)
  โ ุชุญุฏูุซ ุงููุฌููุน ุงูููู
    โ
๐ ุชู ุงูุชุญุฏูุซ ุจูุฌุงุญ!
```

---

### ุงูุณููุงุฑูู 3: ุญุฐู ุฌููุน ุฃุตูุงู ุงูุชูุงุฒู ูู ุงููุงุชูุฑุฉ โ๏ธ

```
ุงููุณุชุฎุฏู โ ูุนุฏูู ูุงุชูุฑุฉ ุงูุฅูุงุฑุงุช
    โ
ูุญุฐู ุฌููุน ุฃุตูุงู ุงูุชูุงุฒู
ูุญุชูุธ ููุท ุจุฃุตูุงู ุงูุฅูุงุฑุงุช
    โ
ูููุฑ "ุญูุธ"
    โ
ุงููุธุงู:
  โ ุชุญุฏูุซ ูุงุชูุฑุฉ ุงูุฅูุงุฑุงุช
  โ๏ธ ูุงุชูุฑุฉ ุงูุชูุงุฒู ุชุจูู ุจุฏูู ุจููุฏ
     (Console Log: "ูุง ุชูุฌุฏ ุฃุตูุงู ุชูุงุฒู ูู ุงูุชุนุฏูู ุงูุฌุฏูุฏ")
```

---

## ๐ฏ ุงูููุงุฆุฏ

| ุงูููุฒุฉ | ุงููุตู |
|--------|--------|
| **ุงูุญูุงูุฉ** ๐ก๏ธ | ููุน ุงูุชุนุฏูู ุงููุจุงุดุฑ ุนูู ุงูููุงุชูุฑ ุงูุชููุงุฆูุฉ |
| **ุงูุชุฒุงูู** ๐ | ุชุญุฏูุซ ุชููุงุฆู ููุงุชูุฑุฉ ุงูุชูุงุฒู |
| **ุงูุงุชุณุงู** โ | ุงูุจูุงูุงุช ูุชุณูุฉ ุจูู ุฌููุน ุงูููุงุชูุฑ ุงููุฑุชุจุทุฉ |
| **ุงูุณูููุฉ** ๐ก | ุงููุณุชุฎุฏู ูุนุฏูู ูุงุชูุฑุฉ ูุงุญุฏุฉ ูุงููุธุงู ูุชููู ุงูุจุงูู |

---

## ๐ ูุง ูุชู ุชุญุฏูุซู ูู ูุงุชูุฑุฉ ุงูุชูุงุฒู

### ูุชู ุชุญุฏูุซู โ:
- **ุงูุฃุตูุงู**: ููุท ุฃุตูุงู ุงูุชูุงุฒู
- **ุงููููุงุช**: ูู ูุงุชูุฑุฉ ุงูุฅูุงุฑุงุช
- **ุงูุฃุณุนุงุฑ**: ูู ูุงุชูุฑุฉ ุงูุฅูุงุฑุงุช
- **ุงููุฌููุน ุงูููู**: ููุญุณุจ ุชููุงุฆูุงู

### ูุง ูุชู ุชุญุฏูุซู โ:
- ุฑูู ุงููุงุชูุฑุฉ
- ุงูุนููู (ุงูุชูุงุฒู ุฏุงุฆูุงู = ุนููู ุงูุฅูุงุฑุงุช)
- ููุน ุงููุงุชูุฑุฉ (ุฏุงุฆูุงู CREDIT)
- ุฃุตูุงู ุงูุฅูุงุฑุงุช (ูุง ุชูุฌุฏ ูู ูุงุชูุฑุฉ ุงูุชูุงุฒู)

---

## ๐งช ุงูุงุฎุชุจุงุฑ

### ุฎุทูุงุช ุงูุงุฎุชุจุงุฑ:

1. **ุฅูุดุงุก ูุงุชูุฑุฉ ูุนูุฏุฉ:**
   ```
   ูุงุชูุฑุฉ ุงูุฅูุงุฑุงุช:
   - ุตูู ุงูุชูุงุฒู A: 10 ุตูุงุฏูู ร 100 ุฑ.ุณ = 1000 ุฑ.ุณ
   - ุตูู ุงูุชูุงุฒู B: 5 ุตูุงุฏูู ร 200 ุฑ.ุณ = 1000 ุฑ.ุณ
   - ุตูู ุงูุฅูุงุฑุงุช C: 8 ุตูุงุฏูู ร 150 ุฑ.ุณ = 1200 ุฑ.ุณ
   ุงููุฌููุน: 3200 ุฑ.ุณ
   ```

2. **ุงูุชุญูู ูู ูุงุชูุฑุฉ ุงูุชูุงุฒู:**
   ```
   ูุงุชูุฑุฉ ุงูุชูุงุฒู (ุชููุงุฆูุฉ):
   - ุตูู A: 10 ุตูุงุฏูู ร 100 ุฑ.ุณ = 1000 ุฑ.ุณ
   - ุตูู B: 5 ุตูุงุฏูู ร 200 ุฑ.ุณ = 1000 ุฑ.ุณ
   ุงููุฌููุน: 2000 ุฑ.ุณ
   ```

3. **ุชุนุฏูู ูุงุชูุฑุฉ ุงูุฅูุงุฑุงุช:**
   ```
   - ุตูู A: 10 โ 15 ุตูุงุฏูู
   - ุตูู B: 200 โ 250 ุฑ.ุณ/ุตูุฏูู
   - ุตูู C: 8 โ 10 ุตูุงุฏูู
   ```

4. **ุงูุชุญูู ูู ุงูุชุญุฏูุซ ุงูุชููุงุฆู:**
   ```
   โ ูุงุชูุฑุฉ ุงูุฅูุงุฑุงุช:
      - ุตูู A: 15 ร 100 = 1500 ุฑ.ุณ
      - ุตูู B: 5 ร 250 = 1250 ุฑ.ุณ
      - ุตูู C: 10 ร 150 = 1500 ุฑ.ุณ
      ุงููุฌููุน: 4250 ุฑ.ุณ
   
   โ ูุงุชูุฑุฉ ุงูุชูุงุฒู (ูุญุฏูุซุฉ ุชููุงุฆูุงู):
      - ุตูู A: 15 ร 100 = 1500 ุฑ.ุณ
      - ุตูู B: 5 ร 250 = 1250 ุฑ.ุณ
      ุงููุฌููุน: 2750 ุฑ.ุณ
   ```

5. **ูุญุงููุฉ ุชุนุฏูู ูุงุชูุฑุฉ ุงูุชูุงุฒู ูุจุงุดุฑุฉ:**
   ```
   โ ุฎุทุฃ: "ูุง ูููู ุชุนุฏูู ูุฐู ุงููุงุชูุฑุฉ ูุจุงุดุฑุฉ!"
   ```

---

## ๐ ุงููููุงุช ุฐุงุช ุงูุตูุฉ

```
โ server/src/services/SalesService.ts
   - ุงูุณุทูุฑ 380-405: ุญูุงูุฉ ููุงุชูุฑ ุงูุชูุงุฒู ูู ุงูุชุนุฏูู ุงููุจุงุดุฑ
   - ุงูุณุทูุฑ 618-671: ุชุญุฏูุซ ุชููุงุฆู ููุงุชูุฑุฉ ุงูุชูุงุฒู
```

---

## ๐ก ููุงุญุธุงุช ูููุฉ

### 1. **ูุงุฐุง ูุญุฏุซ ุนูุฏ ุญุฐู ุฌููุน ุฃุตูุงู ุงูุชูุงุฒูุ**
```
- ูุงุชูุฑุฉ ุงูุฅูุงุฑุงุช: ุชูุญุฏูุซ (ุชุญุชูู ููุท ุนูู ุฃุตูุงู ุงูุฅูุงุฑุงุช)
- ูุงุชูุฑุฉ ุงูุชูุงุฒู: ุชุจูู ุจุฏูู ุจููุฏ (ุณุทูุฑ ูุงุฑุบุฉ)
```

**ุงูุชุฑุงุญ ููุชุญุณูู ุงููุณุชูุจูู:**
- ุญุฐู ูุงุชูุฑุฉ ุงูุชูุงุฒู ุชูุงูุงู ุฅุฐุง ูู ุชุนุฏ ููุงู ุฃุตูุงู ุชูุงุฒู

### 2. **ูุงุฐุง ูุญุฏุซ ุนูุฏ ุฅุถุงูุฉ ุฃุตูุงู ุชูุงุฒู ููุงุชูุฑุฉ ุจุณูุทุฉุ**
```
- ุญุงููุงู: ูุง ูุชู ุฅูุดุงุก ูุงุชูุฑุฉ ุชูุงุฒู ุฌุฏูุฏุฉ
- ูุฐู ุงูููุฒุฉ ุชุนูู ููุท ูุน ุงูููุงุชูุฑ ุงููุนูุฏุฉ ุงูููุฌูุฏุฉ
```

**ุงูุชุฑุงุญ ููุชุญุณูู ุงููุณุชูุจูู:**
- ุชุญููู ุงููุงุชูุฑุฉ ุงูุจุณูุทุฉ ุฅูู ูุนูุฏุฉ ุนูุฏ ุฅุถุงูุฉ ุฃุตูุงู ุชูุงุฒู

---

## ๐ ุญุงูุฉ ุงููุธุงู

```
โ ุญูุงูุฉ ููุงุชูุฑ ุงูุชูุงุฒู: ููุนููุฉ
โ ุชุญุฏูุซ ุชููุงุฆู ููุงุชูุฑุฉ ุงูุชูุงุฒู: ูุนูู
โ ุญูุงูุฉ ููุงุชูุฑ ุงููุดุชุฑูุงุช: ููุนููุฉ
โ ุงูุญุฐู ุงููุชุณูุณู: ูุนูู
โ ุฑุณุงุฆู ุงูุฎุทุฃ: ูุงุถุญุฉ ููููุฏุฉ
โ ุงูุฎุงุฏู: ูุนูู ุนูู ุงููููุฐ 4000
```

---

**ุชุงุฑูุฎ ุงูุชูุซูู:** 4 ููููุจุฑ 2025
**ุงูุญุงูุฉ:** โ ููุทุจูู ููุนูู
**ุงูุชุฃุซูุฑ:** ๐ฏ ุชุนุฏูู ุณูุณ ููููุงุชูุฑ ุงููุนูุฏุฉ ูุน ุชุญุฏูุซ ุชููุงุฆู

