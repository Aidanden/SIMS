# إصلاح مشكلة حسابات الموردين - ملخص الإصلاحات

## المشكلة الأساسية
كانت شاشة حسابات الموردين تظهر أرصدة صفرية رغم وجود إيصالات دفع للموردين. السبب كان عدم إنشاء قيود محاسبية في جدول `SupplierAccount` عند إنشاء أو الموافقة على المشتريات والمصروفات.

## الإصلاحات المنجزة

### 1. دمج خدمات حسابات الموردين
- **المشكلة**: كان هناك ملفان منفصلان:
  - `SupplierAccountService.ts` - يحتوي على `createAccountEntry`
  - `supplierAccount.service.ts` - يحتوي على `getSupplierAccount`
- **الحل**: دمج الملفين في `SupplierAccountService.ts` واحد وحذف المكرر
- **الملفات المحدثة**:
  - `/server/src/services/SupplierAccountService.ts` - دمج جميع الوظائف
  - `/server/src/controllers/supplierAccount.controller.ts` - تحديث الاستيراد

### 2. إصلاح إنشاء قيود حساب المورد في خدمة الموافقة على المشتريات
- **المشكلة**: `PurchaseExpenseService.approvePurchase` كان ينشئ إيصالات دفع لكن لا ينشئ قيود محاسبية
- **الحل**: إضافة إنشاء قيود `SupplierAccount` بعد إنشاء إيصالات الدفع
- **الملفات المحدثة**:
  - `/server/src/services/purchaseExpense.service.ts`
  - `/server/src/dto/purchaseExpenseDto.ts` - إضافة `id` لـ `SupplierPayable`

### 3. إصلاح إنشاء قيود حساب المورد في خدمة إضافة المصروفات
- **المشكلة**: `AddExpensesToApprovedPurchaseService` كان ينشئ إيصالات لكن لا ينشئ قيود محاسبية
- **الحل**: إضافة إنشاء قيود `SupplierAccount` بعد إنشاء إيصالات الدفع
- **الملفات المحدثة**:
  - `/server/src/services/addExpensesToApprovedPurchase.service.ts`

### 4. تحديث خدمات إيصالات الدفع والأقساط
- **تم سابقاً**: تحديث `paymentReceipt.service.ts` و `paymentInstallment.service.ts` لإنشاء قيود محاسبية

## آلية العمل الجديدة

### عند الموافقة على مشترى:
1. إنشاء إيصال دفع رئيسي للمورد (`MAIN_PURCHASE`)
2. إنشاء إيصالات دفع منفصلة لكل مصروف (`EXPENSE`)
3. إنشاء قيود `CREDIT` في `SupplierAccount` لكل إيصال (زيادة الدين للمورد)

### عند دفع إيصال أو قسط:
1. إنشاء قيد `DEBIT` في `SupplierAccount` (تقليل الدين للمورد)

### عند جلب حساب المورد:
1. جلب جميع القيود من `SupplierAccount`
2. حساب `totalCredit` (إجمالي المبالغ المستحقة)
3. حساب `totalDebit` (إجمالي المبالغ المدفوعة)
4. حساب `currentBalance` (الرصيد الحالي = آخر رصيد مسجل)

## خطوات الاختبار

### 1. تشغيل الخادم
```bash
cd /path/to/server
npm start
# أو
npm run dev
```

### 2. اختبار إنشاء مشترى جديد
1. إنشاء مشترى آجل لمورد معين
2. إضافة مصروفات للمشترى
3. الموافقة على المشترى
4. التحقق من إنشاء إيصالات الدفع
5. التحقق من إنشاء قيود `SupplierAccount`

### 3. اختبار عرض حسابات الموردين
1. الذهاب إلى شاشة حسابات الموردين
2. التحقق من ظهور الأرصدة الصحيحة في البطاقات الإحصائية
3. اختيار مورد وعرض كشف الحساب
4. التحقق من ظهور جميع المعاملات والأرصدة

### 4. اختبار الدفعات
1. إنشاء دفعة على إيصال دفع
2. التحقق من تحديث رصيد المورد
3. إنشاء أقساط على إيصال دفع
4. التحقق من تحديث الرصيد مع كل قسط

## الملفات المحدثة

### Backend
- `/server/src/services/SupplierAccountService.ts` - خدمة موحدة لحسابات الموردين
- `/server/src/services/purchaseExpense.service.ts` - إضافة إنشاء قيود محاسبية
- `/server/src/services/addExpensesToApprovedPurchase.service.ts` - إضافة إنشاء قيود محاسبية
- `/server/src/controllers/supplierAccount.controller.ts` - تحديث الاستيراد
- `/server/src/dto/purchaseExpenseDto.ts` - إضافة `id` لـ `SupplierPayable`

### Frontend
- لا توجد تغييرات مطلوبة في الواجهة الأمامية

## النتيجة المتوقعة
بعد هذه الإصلاحات، يجب أن تعرض شاشة حسابات الموردين:
- الأرصدة الصحيحة في البطاقات الإحصائية
- كشف حساب مفصل لكل مورد يظهر جميع المعاملات
- المشتريات المفتوحة للموردين
- تحديث الأرصدة عند الدفع أو إضافة أقساط

## ملاحظات مهمة
- تأكد من تشغيل `npx prisma db push` بعد أي تغييرات في المخطط
- تأكد من وجود بيانات اختبار (موردين، مشتريات، إيصالات دفع)
- في حالة عدم ظهور البيانات، تحقق من logs الخادم لرؤية أي أخطاء في إنشاء القيود المحاسبية
