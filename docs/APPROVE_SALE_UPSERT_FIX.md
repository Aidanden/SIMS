# ุฅุตูุงุญ ูุดููุฉ ุงุนุชูุงุฏ ุงููุงุชูุฑุฉ (approveSale)

## ๐ ุงููุดููุฉ

ุนูุฏ ุงุนุชูุงุฏ ูุงุชูุฑุฉ ูู ูุจู ุงููุญุงุณุจุ ูุงู ุงููุธุงู ููุดู ุฅุฐุง ูู ููู ุณุฌู ุงููุฎุฒูู ููุฌูุฏุงู ูุณุจูุงู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช.

### ุฑุณุงูุฉ ุงูุฎุทุฃ:
```
PrismaClientKnownRequestError: 
Invalid `this.prisma.stock.update()` invocation
An operation failed because it depends on one or more records that were required but not found.
No record was found for an update.
code: 'P2025'
```

### ุงูุณุจุจ:
- ูุงู ุงูููุฏ ูุณุชุฎุฏู `stock.update()` ูุฎุตู ุงููุฎุฒูู ุจุนุฏ ุงุนุชูุงุฏ ุงููุงุชูุฑุฉ
- ุฅุฐุง ูู ููู ุณุฌู ุงููุฎุฒูู ููุฌูุฏุงูุ ุชูุดู ุนูููุฉ `update`
- ูุฐุง ูุญุฏุซ ุนูุฏูุง:
  - ุชู ุงูุจูุน ูู ุตูู ูุฃูู ูุฑุฉ ูู ุดุฑูุฉ ูุนููุฉ
  - ุชู ุญุฐู ุณุฌู ุงููุฎุฒูู ุนู ุทุฑูู ุงูุฎุทุฃ
  - ุชู ุฅูุดุงุก ุงููุงุชูุฑุฉ ูุจู ุฅูุดุงุก ุงููุฎุฒูู

---

## โ ุงูุญู

ุงุณุชุจุฏุงู `stock.update()` ุจู `stock.upsert()` ูู ุฏุงูุฉ `approveSale`.

### `upsert` ุชููู ุจู:
1. **ุฅุฐุง ูุงู ุงูุณุฌู ููุฌูุฏุงู**: ุชุญุฏูุซู (ุฎุตู ุงููููุฉ)
2. **ุฅุฐุง ูู ููู ุงูุณุฌู ููุฌูุฏุงู**: ุฅูุดุงุคู ุจูููุฉ 0 (ุชู ุงูุจูุน ุจุงููุนู)

---

## ๐ ุงูุชุบููุฑุงุช

### ูู `SalesService.ts` - ุฏุงูุฉ `approveSale`

**ูุจู:**
```typescript
// โ ููุดู ุฅุฐุง ูู ููู ุงูุณุฌู ููุฌูุฏุงู
for (const line of existingSale.lines) {
  const boxesToDecrement = Number(line.qty);
  
  await this.prisma.stock.update({
    where: {
      companyId_productId: {
        companyId: existingSale.companyId,
        productId: line.productId
      }
    },
    data: {
      boxes: {
        decrement: boxesToDecrement
      }
    }
  });
}
```

**ุจุนุฏ:**
```typescript
// โ ูุนูู ุญุชู ูู ูู ููู ุงูุณุฌู ููุฌูุฏุงู
for (const line of existingSale.lines) {
  const boxesToDecrement = Number(line.qty);
  
  // ุงูุญุตูู ุนูู ุงููุฎุฒูู ุงูุญุงูู
  const currentStock = await this.prisma.stock.findUnique({
    where: {
      companyId_productId: {
        companyId: existingSale.companyId,
        productId: line.productId
      }
    }
  });
  
  const currentBoxes = currentStock ? Number(currentStock.boxes) : 0;
  const newBoxes = Math.max(0, currentBoxes - boxesToDecrement);
  
  // ุงุณุชุฎุฏุงู upsert ูุถูุงู ุฅูุดุงุก ุงูุณุฌู ุฅุฐุง ูู ููู ููุฌูุฏุงู
  await this.prisma.stock.upsert({
    where: {
      companyId_productId: {
        companyId: existingSale.companyId,
        productId: line.productId
      }
    },
    update: {
      boxes: newBoxes
    },
    create: {
      companyId: existingSale.companyId,
      productId: line.productId,
      boxes: 0 // ุฅุฐุง ูู ููู ููุฌูุฏุงูุ ูุจุฏุฃ ูู 0 (ุชู ุงูุจูุน ุจุงููุนู)
    }
  });
  
  console.log(`โ ุชู ุฎุตู ${boxesToDecrement} ุตูุฏูู ูู ุงููุฎุฒูู ููุตูู: ${line.product.name}`);
}
```

---

## ๐ฏ ุงููุฑู ุงูุฑุฆูุณู

### `decrement` ูุน `update` โ
```typescript
// โ ูุง ูุนูู ุฅุฐุง ูู ููู ุงูุณุฌู ููุฌูุฏุงู
data: {
  boxes: {
    decrement: boxesToDecrement // ูุชุทูุจ ุณุฌู ููุฌูุฏ
  }
}
```

### ุญุณุงุจ ูุฏูู ูุน `upsert` โ
```typescript
// โ ูุนูู ุฏุงุฆูุงู
const currentBoxes = currentStock ? Number(currentStock.boxes) : 0;
const newBoxes = Math.max(0, currentBoxes - boxesToDecrement);

update: {
  boxes: newBoxes // ุชุนููู ุงููููุฉ ูุจุงุดุฑุฉ
}
create: {
  boxes: 0 // ุฅูุดุงุก ุจูููุฉ 0 ุฅุฐุง ูู ููู ููุฌูุฏุงู
}
```

---

## ๐ ุงูุชุฏูู ุงููุงูู ูุงุนุชูุงุฏ ุงููุงุชูุฑุฉ

### ูุจู ุงูุฅุตูุงุญ โ

```
1. ุงููุญุงุณุจ ูููุฑ "ุงุนุชูุงุฏ"
   โ
2. ุงููุธุงู ูุญุงูู ุฎุตู ุงููุฎุฒูู
   โ
3. ุงูุจุญุซ ุนู ุณุฌู ุงููุฎุฒูู
   โ
4. ุงูุณุฌู ุบูุฑ ููุฌูุฏ โ
   โ
5. stock.update() ููุดู! โ
   โ
6. ุฎุทุฃ P2025 ๐ข
```

---

### ุจุนุฏ ุงูุฅุตูุงุญ โ

```
1. ุงููุญุงุณุจ ูููุฑ "ุงุนุชูุงุฏ"
   โ
2. ุงููุธุงู ูุญุงูู ุฎุตู ุงููุฎุฒูู
   โ
3. ุงูุจุญุซ ุนู ุณุฌู ุงููุฎุฒูู
   โ
4. ุฅุฐุง ููุฌูุฏ โ ุฎุตู ุงููููุฉ โ
   ุฃู
   ุฅุฐุง ุบูุฑ ููุฌูุฏ โ ุฅูุดุงุก ุณุฌู ุจูููุฉ 0 โ
   โ
5. ุชุญุฏูุซ ุญุงูุฉ ุงููุงุชูุฑุฉ ุฅูู APPROVED โ
   โ
6. ุฅุดุนุงุฑ ุงููุฌุงุญ ๐
```

---

## ๐ ููุฎุต ุงูุฅุตูุงุญุงุช ูู ุฌููุน ุนูููุงุช ุงููุฎุฒูู

| ุงูุนูููุฉ | ุงููููุน | ุงูุญุงูุฉ |
|---------|--------|--------|
| **ุฅูุดุงุก ูุงุชูุฑุฉ** | `createSale()` | โ ูุณุชุฎุฏู `upsert` |
| **ุชุนุฏูู ูุงุชูุฑุฉ** | `updateSale()` | โ ูุณุชุฎุฏู `upsert` |
| **ุญุฐู ูุงุชูุฑุฉ** | `deleteSale()` | โ ูุณุชุฎุฏู `upsert` |
| **ุงุนุชูุงุฏ ูุงุชูุฑุฉ** | `approveSale()` | โ ุชู ุฅุตูุงุญู - ูุณุชุฎุฏู `upsert` |

---

## ๐ฏ ุงูููุงุฆุฏ

| ุงูููุฒุฉ | ุงููุตู |
|--------|--------|
| **ุงูููุซูููุฉ** | ูุง ูุดู ุจุณุจุจ ุณุฌู ููููุฏ |
| **ุงููุฑููุฉ** | ูุนูู ุณูุงุก ูุงู ุงูุณุฌู ููุฌูุฏุงู ุฃู ูุง |
| **ุงูุฃูุงู** | ูุง ุชููุฏ ุงูุจูุงูุงุช |
| **ุงูุงุชุณุงู** | ููุณ ุงูููุฌ ูู ุฌููุน ุงูุนูููุงุช |

---

## ๐งช ุณููุงุฑูู ุงูุงุฎุชุจุงุฑ

### ุงูุฎุทูุงุช:
```
1. ุฃูุดุฆ ูุงุชูุฑุฉ ุฌุฏูุฏุฉ (DRAFT)
2. ุงุญุฐู ุณุฌู ุงููุฎุฒูู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุฏููุงู (ููุงุฎุชุจุงุฑ)
3. ุงุฐูุจ ูุดุงุดุฉ ุงููุญุงุณุจ
4. ุงุนุชูุฏ ุงููุงุชูุฑุฉ (Approve)
5. โ ุงููุชูุฌุฉ: ุชู ุงูุงุนุชูุงุฏ ุจูุฌุงุญ
6. โ ุชู ุฅูุดุงุก ุณุฌู ุงููุฎุฒูู ุจูููุฉ 0
7. โ ุญุงูุฉ ุงููุงุชูุฑุฉ APPROVED
```

---

## ๐ ุงููููุงุช ุงููุนุฏูุฉ

```
โ server/src/services/SalesService.ts
   - ุงูุณุทูุฑ 1339-1377: approveSale() - ุฎุตู ุงููุฎุฒูู
   - ุชุบููุฑ ูู stock.update() ุฅูู stock.upsert()
```

---

## ๐ก ุณุจุจ ุงุณุชุฎุฏุงู `boxes: 0` ูู `create`

```typescript
create: {
  companyId: existingSale.companyId,
  productId: line.productId,
  boxes: 0 // โ ููุงุฐุง 0ุ
}
```

**ุงูุณุจุจ:**
- ุงููุงุชูุฑุฉ ุชู ุฅูุดุงุคูุง ุจุงููุนู ูุฎุตูุช ุงููุฎุฒูู (ูุธุฑูุงู)
- ููู ุณุฌู ุงููุฎุฒูู ูู ููู ููุฌูุฏุงู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- ุนูุฏ ุงูุงุนุชูุงุฏุ ูุญุชุงุฌ ุฅูุดุงุก ุงูุณุฌู
- ูุจุฏุฃ ูู 0 ูุฃู ุงููููุฉ ุชู "ุจูุนูุง" ุจุงููุนู
- ูุฐุง ูุญุงูุธ ุนูู ุงูุงุชุณุงู

---

## ๐ง ููุงุญุธุงุช ูููุฉ

### `decrement` vs ุญุณุงุจ ูุฏูู:

**`decrement`:**
```typescript
// โ ูุชุทูุจ ุณุฌู ููุฌูุฏ
boxes: { decrement: 10 }
```

**ุญุณุงุจ ูุฏูู:**
```typescript
// โ ูุนูู ุญุชู ูุน ุณุฌู ุฌุฏูุฏ
const newBoxes = currentBoxes - 10;
boxes: newBoxes
```

---

## ๐ ุญุงูุฉ ุงููุธุงู

```
โ ุฅูุดุงุก ูุงุชูุฑุฉ: ูุนูู (upsert)
โ ุชุนุฏูู ูุงุชูุฑุฉ: ูุนูู (upsert)
โ ุญุฐู ูุงุชูุฑุฉ: ูุนูู (upsert)
โ ุงุนุชูุงุฏ ูุงุชูุฑุฉ: ูุนูู (upsert) โ ุชู ุงูุฅุตูุงุญ
โ ุงูุญุฐู ุงููุชุณูุณู: ูุนูู
โ ุญูุงูุฉ ุงูููุงุชูุฑ ุงูุชููุงุฆูุฉ: ููุนููุฉ
โ ุฑุณุงุฆู ุงูุฎุทุฃ: ูุงุถุญุฉ
โ ุงูุฎุงุฏู: ูุนูู ุนูู ุงููููุฐ 4000
```

---

**ุชุงุฑูุฎ ุงูุฅุตูุงุญ:** 4 ููููุจุฑ 2025
**ุงูุญุงูุฉ:** โ ููุทุจูู ูุฌุงูุฒ
**ุงูุชุฃุซูุฑ:** ๐ฏ ุงุนุชูุงุฏ ุงูููุงุชูุฑ ูุนูู ุฏุงุฆูุงู ุญุชู ูุน ุณุฌูุงุช ุงููุฎุฒูู ุงูููููุฏุฉ

