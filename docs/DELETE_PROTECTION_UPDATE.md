# ๐ก๏ธ ุญูุงูุฉ ุงูุญุฐู ููููุงุชูุฑ ุงููุนูุฏุฉ

## ๐ฏ ุงููุฏู ูู ุงูุชุญุฏูุซ

ููุน ุญุฐู ุงูููุงุชูุฑ ุงูุชู ุชู ุฅูุดุงุคูุง ุชููุงุฆูุงู ูุฌุฒุก ูู ูุงุชูุฑุฉ ูุจูุนุงุช ูุนูุฏุฉุ ูุถูุงู ุฃู ุงูุญุฐู ูุชู ููุท ูู ุงููุงุชูุฑุฉ ุงูุฃุตููุฉ.

---

## โ๏ธ ุงููุดููุฉ ุงููุฏููุฉ

ูุจู ุงูุชุญุฏูุซุ ูุงู ุจุฅููุงู ุงููุณุชุฎุฏู ุญุฐู:
- โ ูุงุชูุฑุฉ ุงูุดุฑูุฉ ุงูุฃู (ุงูุชูุงุฒู โ ุงูุฅูุงุฑุงุช) ูุจุงุดุฑุฉู
- โ ูุงุชูุฑุฉ ุงููุดุชุฑูุงุช (ุงูุฅูุงุฑุงุช ูู ุงูุชูุงุฒู) ูุจุงุดุฑุฉู
- โ ูุฐุง ูุณุจุจ ุนุฏู ุชูุงุณู ูู ุงูุจูุงูุงุช

---

## โ ุงูุญู ุงูุฌุฏูุฏ

### 1. **ุญูุงูุฉ ููุงุชูุฑ ุงููุจูุนุงุช ุงูุชุงุจุนุฉ**

ุนูุฏ ูุญุงููุฉ ุญุฐู ูุงุชูุฑุฉ ุงูุดุฑูุฉ ุงูุฃู ูุจุงุดุฑุฉ:

```typescript
// ูู SalesService.ts
const isChildSale = await this.prisma.sale.findFirst({
  where: {
    OR: [
      { relatedParentSaleId: id },
      { relatedBranchPurchaseId: id }
    ]
  }
});

if (isChildSale) {
  throw new Error(
    'ูุง ูููู ุญุฐู ูุฐู ุงููุงุชูุฑุฉ ูุจุงุดุฑุฉ. ' +
    'ูุฌุจ ุญุฐู ุงููุงุชูุฑุฉ ุงูุฃุตููุฉ ุงูุชู ุชู ุฅูุดุงุก ูุฐู ุงููุงุชูุฑุฉ ูููุง.'
  );
}
```

### 2. **ุญูุงูุฉ ููุงุชูุฑ ุงููุดุชุฑูุงุช ุงูุชุงุจุนุฉ**

ุนูุฏ ูุญุงููุฉ ุญุฐู ูุงุชูุฑุฉ ุงููุดุชุฑูุงุช ูุจุงุดุฑุฉ:

```typescript
// ูู PurchaseService.ts
const relatedSale = await prisma.sale.findFirst({
  where: {
    relatedBranchPurchaseId: id
  }
});

if (relatedSale) {
  throw new Error(
    'ูุง ูููู ุญุฐู ูุฐู ุงููุงุชูุฑุฉ ูุจุงุดุฑุฉ. ' +
    'ูุฐู ูุงุชูุฑุฉ ูุดุชุฑูุงุช ุชู ุฅูุดุงุคูุง ุชููุงุฆูุงู ูู ูุงุชูุฑุฉ ูุจูุนุงุช ูุนูุฏุฉ. ' +
    'ูุฌุจ ุญุฐู ูุงุชูุฑุฉ ุงููุจูุนุงุช ุงูุฃุตููุฉ.'
  );
}
```

---

## ๐ ุงูุณููุงุฑูููุงุช

### ุณููุงุฑูู 1: ูุงุชูุฑุฉ ูุนูุฏุฉ ูุงููุฉ

#### ุงูุฅูุดุงุก:
```
1๏ธโฃ ูุงุชูุฑุฉ ุงูุฅูุงุฑุงุช (ุงูุฃุตููุฉ)
   โโ 50 ุตูุฏูู ูู ุงูุชูุงุฒู
   โโ 30 ุตูุฏูู ูู ุงูุฅูุงุฑุงุช

2๏ธโฃ ูุงุชูุฑุฉ ุงูุชูุงุฒู โ ุงูุฅูุงุฑุงุช
   โโ 50 ุตูุฏูู (ุขุฌูุฉ)

3๏ธโฃ ูุงุชูุฑุฉ ูุดุชุฑูุงุช ุงูุฅูุงุฑุงุช
   โโ 50 ุตูุฏูู ูู ุงูุชูุงุฒู
```

#### ูุญุงููุฉ ุงูุญุฐู:

**ุฃ. ุญุฐู ูุงุชูุฑุฉ ุงูุชูุงุฒู ูุจุงุดุฑุฉ:**
```
โ ุฎุทุฃ!
"ูุง ูููู ุญุฐู ูุฐู ุงููุงุชูุฑุฉ ูุจุงุดุฑุฉ.
ูุฌุจ ุญุฐู ุงููุงุชูุฑุฉ ุงูุฃุตููุฉ ุงูุชู ุชู ุฅูุดุงุก ูุฐู ุงููุงุชูุฑุฉ ูููุง."
```

**ุจ. ุญุฐู ูุงุชูุฑุฉ ุงููุดุชุฑูุงุช ูุจุงุดุฑุฉ:**
```
โ ุฎุทุฃ!
"ูุง ูููู ุญุฐู ูุฐู ุงููุงุชูุฑุฉ ูุจุงุดุฑุฉ.
ูุฐู ูุงุชูุฑุฉ ูุดุชุฑูุงุช ุชู ุฅูุดุงุคูุง ุชููุงุฆูุงู ูู ูุงุชูุฑุฉ ูุจูุนุงุช ูุนูุฏุฉ.
ูุฌุจ ุญุฐู ูุงุชูุฑุฉ ุงููุจูุนุงุช ุงูุฃุตููุฉ."
```

**ุฌ. ุญุฐู ูุงุชูุฑุฉ ุงูุฅูุงุฑุงุช ุงูุฃุตููุฉ:**
```
โ ูุฌุญ!
๐๏ธ ุจุฏุก ุญุฐู ุงููุงุชูุฑุฉ ูุฌููุน ุงูููุงุชูุฑ ุงููุฑุชุจุทุฉ...
๐ ูุงุชูุฑุฉ ูุนูุฏุฉ - ุณูุชู ุญุฐู ุงูููุงุชูุฑ ุงููุฑุชุจุทุฉ
๐ ุญุฐู ูุงุชูุฑุฉ ุงูุดุฑูุฉ ุงูุฃู (ID: ...)
โ ุชู ุญุฐู ูุงุชูุฑุฉ ุงูุดุฑูุฉ ุงูุฃู
๐ ุญุฐู ูุงุชูุฑุฉ ูุดุชุฑูุงุช ุงูุดุฑูุฉ ุงูุชุงุจุนุฉ (ID: ...)
โ ุชู ุญุฐู ูุงุชูุฑุฉ ูุดุชุฑูุงุช ุงูุดุฑูุฉ ุงูุชุงุจุนุฉ
๐ ุญุฐู ุณุฌู PurchaseFromParent (ID: ...)
โ ุชู ุญุฐู ุณุฌู PurchaseFromParent
โ ุชู ุญุฐู ุงููุงุชูุฑุฉ ูุฌููุน ุงูููุงุชูุฑ ุงููุฑุชุจุทุฉ ุจูุฌุงุญ
```

---

## ๐ ุณูุฑ ุงูุนูู ุงูุตุญูุญ

```
ุงููุณุชุฎุฏู ูุฑูุฏ ุญุฐู ูุงุชูุฑุฉ ูุนูุฏุฉ
              โ
    ูุฐูุจ ูุดุงุดุฉ ุงููุจูุนุงุช/ุงููุญุงุณุจ
              โ
    ูุจุญุซ ุนู ุงููุงุชูุฑุฉ ุงูุฃุตููุฉ (ูุงุชูุฑุฉ ุงูุฅูุงุฑุงุช)
              โ
         ูููุฑ "ุญุฐู"
              โ
    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    โ ุงููุธุงู ูุญุฐู ุชููุงุฆูุงู:          โ
    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
    โ โ ูุงุชูุฑุฉ ุงูุฅูุงุฑุงุช ุงูุฃุตููุฉ    โ
    โ โ ูุงุชูุฑุฉ ุงูุชูุงุฒู โ ุงูุฅูุงุฑุงุช  โ
    โ โ ูุงุชูุฑุฉ ุงููุดุชุฑูุงุช           โ
    โ โ ุณุฌู PurchaseFromParent      โ
    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
    โ โ ุฅุฑุฌุงุน ุงููุฎุฒูู ููุชูุงุฒู      โ
    โ โ ุฅุฑุฌุงุน ุงููุฎุฒูู ููุฅูุงุฑุงุช     โ
    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
              โ
    โ ุชู ุงูุญุฐู ุจูุฌุงุญ! ุฌููุน ุงูุจูุงูุงุช ูุชุณูุฉ
```

---

## ๐งช ุงุฎุชุจุงุฑ ุงูุญูุงูุฉ

### 1. **ุงุฎุชุจุงุฑ ููุน ุญุฐู ูุงุชูุฑุฉ ุงูุดุฑูุฉ ุงูุฃู:**

```bash
# ุฎุทูุงุช ุงูุงุฎุชุจุงุฑ:
1. ุฃูุดุฆ ูุงุชูุฑุฉ ูุนูุฏุฉ (ุฅูุงุฑุงุช + ุชูุงุฒู)
2. ุงุฐูุจ ูุดุงุดุฉ ุงููุจูุนุงุช
3. ุงุจุญุซ ุนู ูุงุชูุฑุฉ ุงูุชูุงุฒู (ูุงุชูุฑุฉ ุงูุดุฑูุฉ ุงูุฃู)
4. ุญุงูู ุญุฐููุง
5. ูุฌุจ ุฃู ุชุฑู ุฑุณุงูุฉ ุฎุทุฃ:
   "ูุง ูููู ุญุฐู ูุฐู ุงููุงุชูุฑุฉ ูุจุงุดุฑุฉ..."
```

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
```
โ ูุง ูุชู ุงูุญุฐู
๐ข ุฑุณุงูุฉ ุฎุทุฃ ูุงุถุญุฉ
โ ุงููุงุชูุฑุฉ ูุง ุชุฒุงู ููุฌูุฏุฉ
```

### 2. **ุงุฎุชุจุงุฑ ููุน ุญุฐู ูุงุชูุฑุฉ ุงููุดุชุฑูุงุช:**

```bash
# ุฎุทูุงุช ุงูุงุฎุชุจุงุฑ:
1. ุฃูุดุฆ ูุงุชูุฑุฉ ูุนูุฏุฉ (ุฅูุงุฑุงุช + ุชูุงุฒู)
2. ุงุฐูุจ ูุดุงุดุฉ ุงููุดุชุฑูุงุช
3. ุงุจุญุซ ุนู ูุงุชูุฑุฉ ุงููุดุชุฑูุงุช ุงูุชู ุชู ุฅูุดุงุคูุง
4. ุญุงูู ุญุฐููุง
5. ูุฌุจ ุฃู ุชุฑู ุฑุณุงูุฉ ุฎุทุฃ:
   "ูุง ูููู ุญุฐู ูุฐู ุงููุงุชูุฑุฉ ูุจุงุดุฑุฉ..."
```

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
```
โ ูุง ูุชู ุงูุญุฐู
๐ข ุฑุณุงูุฉ ุฎุทุฃ ูุงุถุญุฉ
โ ุงููุงุชูุฑุฉ ูุง ุชุฒุงู ููุฌูุฏุฉ
```

### 3. **ุงุฎุชุจุงุฑ ุงูุญุฐู ุงูุตุญูุญ:**

```bash
# ุฎุทูุงุช ุงูุงุฎุชุจุงุฑ:
1. ุฃูุดุฆ ูุงุชูุฑุฉ ูุนูุฏุฉ (ุฅูุงุฑุงุช + ุชูุงุฒู)
2. ุงุฐูุจ ูุดุงุดุฉ ุงููุจูุนุงุช
3. ุงุจุญุซ ุนู ุงููุงุชูุฑุฉ ุงูุฃุตููุฉ (ูุงุชูุฑุฉ ุงูุฅูุงุฑุงุช)
4. ุงุญุฐููุง
5. ูุฌุจ ุฃู ุชุฑู:
   - ุฑุณุงูุฉ ูุฌุงุญ
   - ุงุฎุชูุงุก ุฌููุน ุงูููุงุชูุฑ ุงููุฑุชุจุทุฉ
   - ุฅุฑุฌุงุน ุงููุฎุฒูู
```

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
```
โ ุชู ุงูุญุฐู ุจูุฌุงุญ
โ ุญุฐู 3 ููุงุชูุฑ (ุฃู 4 ูุน ุงูุณุฌู)
โ ุฅุฑุฌุงุน ุงููุฎุฒูู ูุฌููุน ุงูุดุฑูุงุช
โ ุงูุจูุงูุงุช ูุชุณูุฉ
```

---

## ๐ป ุงูุชูุงุตูู ุงูุชูููุฉ

### 1. **ูู SalesService.ts:**

```typescript
async deleteSale(id: number, userCompanyId: number, isSystemUser: boolean = false) {
  try {
    // 1. ุงูุชุญูู ูู ูุฌูุฏ ุงููุงุชูุฑุฉ
    const existingSale = await this.prisma.sale.findFirst({
      where: { id, ...(isSystemUser !== true && { companyId: userCompanyId }) },
      include: { lines: true }
    });

    if (!existingSale) {
      throw new Error('ุงููุงุชูุฑุฉ ุบูุฑ ููุฌูุฏุฉ ุฃู ููุณ ูุฏูู ุตูุงุญูุฉ ูุญุฐููุง');
    }

    // 2. ุงูุชุญูู ูู ุฃููุง ููุณุช ูุงุชูุฑุฉ ุชุงุจุนุฉ โฌ๏ธ ุฌุฏูุฏ
    const isChildSale = await this.prisma.sale.findFirst({
      where: {
        OR: [
          { relatedParentSaleId: id },
          { relatedBranchPurchaseId: id }
        ]
      }
    });

    if (isChildSale) {
      throw new Error(
        'ูุง ูููู ุญุฐู ูุฐู ุงููุงุชูุฑุฉ ูุจุงุดุฑุฉ. ' +
        'ูุฌุจ ุญุฐู ุงููุงุชูุฑุฉ ุงูุฃุตููุฉ ุงูุชู ุชู ุฅูุดุงุก ูุฐู ุงููุงุชูุฑุฉ ูููุง.'
      );
    }

    // 3. ูุชุงุจุนุฉ ุงูุญุฐู ุงููุชุณูุณู...
  }
}
```

### 2. **ูู PurchaseService.ts:**

```typescript
static async deletePurchase(id: number): Promise<void> {
  const purchase = await prisma.purchase.findUnique({
    where: { id },
    include: { lines: true },
  });

  if (!purchase) {
    throw new Error('Purchase not found');
  }

  // ุงูุชุญูู ูู ุฃููุง ููุณุช ูุงุชูุฑุฉ ูุดุชุฑูุงุช ุชุงุจุนุฉ โฌ๏ธ ุฌุฏูุฏ
  const relatedSale = await prisma.sale.findFirst({
    where: { relatedBranchPurchaseId: id }
  });

  if (relatedSale) {
    throw new Error(
      'ูุง ูููู ุญุฐู ูุฐู ุงููุงุชูุฑุฉ ูุจุงุดุฑุฉ. ' +
      'ูุฐู ูุงุชูุฑุฉ ูุดุชุฑูุงุช ุชู ุฅูุดุงุคูุง ุชููุงุฆูุงู ูู ูุงุชูุฑุฉ ูุจูุนุงุช ูุนูุฏุฉ. ' +
      'ูุฌุจ ุญุฐู ูุงุชูุฑุฉ ุงููุจูุนุงุช ุงูุฃุตููุฉ.'
    );
  }

  // ูุชุงุจุนุฉ ุงูุญุฐู...
}
```

---

## ๐ ููู ูุนูู ุงููุญุต

### ุงูุจุญุซ ุนู ุงูููุงุชูุฑ ุงูุชุงุจุนุฉ:

```typescript
// ูุจุญุซ ุนู ุฃู ูุงุชูุฑุฉ ุชุญุชูู ุนูู ูุฐุง ุงูู ID ูู:
// - relatedParentSaleId
// - relatedBranchPurchaseId

const isChildSale = await this.prisma.sale.findFirst({
  where: {
    OR: [
      { relatedParentSaleId: id },      // ูุงุชูุฑุฉ ุฃุตููุฉ ุชุดูุฑ ููุฐู ุงููุงุชูุฑุฉ ููุงุชูุฑุฉ ุฃู
      { relatedBranchPurchaseId: id }   // ูุงุชูุฑุฉ ุฃุตููุฉ ุชุดูุฑ ููุฐู ุงููุงุชูุฑุฉ ููุงุชูุฑุฉ ูุดุชุฑูุงุช
    ]
  }
});

// ุฅุฐุง ููุฌุฏุชุ ูุนูุงู ุฃู ูุฐู ุงููุงุชูุฑุฉ ุชุงุจุนุฉ ููุง ูุฌุจ ุญุฐููุง ูุจุงุดุฑุฉ
```

---

## ๐ ุงูููุงุฑูุฉ

| ุงูุฅุฌุฑุงุก | ูุจู ุงูุชุญุฏูุซ | ุจุนุฏ ุงูุชุญุฏูุซ |
|---------|-------------|--------------|
| ุญุฐู ูุงุชูุฑุฉ ุงูุชูุงุฒู | โ ูุญุฐู (ุฎุทุฃ!) | โ ูุญูู ุจุฑุณุงูุฉ ุฎุทุฃ |
| ุญุฐู ูุงุชูุฑุฉ ุงููุดุชุฑูุงุช | โ ูุญุฐู (ุฎุทุฃ!) | โ ูุญูู ุจุฑุณุงูุฉ ุฎุทุฃ |
| ุญุฐู ูุงุชูุฑุฉ ุงูุฅูุงุฑุงุช | โ ูุญุฐู + ูุชุณูุณู | โ ูุญุฐู + ูุชุณูุณู |
| ุชูุงุณู ุงูุจูุงูุงุช | โ ูุฏ ูููุฏ | โ ูุถููู |

---

## โก ุงูููุงุฆุฏ

### ูููุณุชุฎุฏููู:
- โ **ููุน ุงูุฃุฎุทุงุก** - ูุง ูููู ุญุฐู ุงูููุงุชูุฑ ุงูุฎุงุทุฆุฉ
- โ **ุฑุณุงุฆู ูุงุถุญุฉ** - ูุนุฑู ุงููุณุชุฎุฏู ูุงุฐุง ููุนู
- โ **ุณูููุฉ ุงูุงุณุชุฎุฏุงู** - ุญุฐู ูู ููุงู ูุงุญุฏ ููุท

### ูููุธุงู:
- โ **ุณูุงูุฉ ุงูุจูุงูุงุช** - ูุง ุชุถุงุฑุจ ุฃู ููุฏุงู ุจูุงูุงุช
- โ **ุชุชุจุน ูุงูู** - ุฌููุน ุงูููุงุชูุฑ ูุฑุชุจุทุฉ
- โ **ุญุฐู ุขูู** - ูุชุณูุณู ูููุธู

### ููุฃุนูุงู:
- โ **ููุซูููุฉ** - ุงูุจูุงูุงุช ุฏุงุฆูุงู ุตุญูุญุฉ
- โ **ุดูุงููุฉ** - ูุถูุญ ูู ุงูุนูููุงุช
- โ **ุณูููุฉ ุงููุฑุงุฌุนุฉ** - ูุง ุนูููุงุช ุบุงูุถุฉ

---

## ๐จ ุฑุณุงุฆู ุงูุฎุทุฃ

### ูููุณุชุฎุฏู ุงูููุงุฆู:

#### ุนูุฏ ูุญุงููุฉ ุญุฐู ูุงุชูุฑุฉ ุงูุดุฑูุฉ ุงูุฃู:
```
โ ุฎุทุฃ ูู ุญุฐู ุงููุงุชูุฑุฉ

ูุง ูููู ุญุฐู ูุฐู ุงููุงุชูุฑุฉ ูุจุงุดุฑุฉ.
ูุฌุจ ุญุฐู ุงููุงุชูุฑุฉ ุงูุฃุตููุฉ ุงูุชู ุชู ุฅูุดุงุก ูุฐู ุงููุงุชูุฑุฉ ูููุง.

๐ก ูุตูุญุฉ: ุงุจุญุซ ุนู ุงููุงุชูุฑุฉ ุงูุฃุตููุฉ ูู ุดุงุดุฉ ุงููุจูุนุงุช
```

#### ุนูุฏ ูุญุงููุฉ ุญุฐู ูุงุชูุฑุฉ ุงููุดุชุฑูุงุช:
```
โ ุฎุทุฃ ูู ุญุฐู ุงููุงุชูุฑุฉ

ูุง ูููู ุญุฐู ูุฐู ุงููุงุชูุฑุฉ ูุจุงุดุฑุฉ.
ูุฐู ูุงุชูุฑุฉ ูุดุชุฑูุงุช ุชู ุฅูุดุงุคูุง ุชููุงุฆูุงู ูู ูุงุชูุฑุฉ ูุจูุนุงุช ูุนูุฏุฉ.
ูุฌุจ ุญุฐู ูุงุชูุฑุฉ ุงููุจูุนุงุช ุงูุฃุตููุฉ.

๐ก ูุตูุญุฉ: ุงุจุญุซ ุนู ุงููุงุชูุฑุฉ ุงูุฃุตููุฉ ูู ุดุงุดุฉ ุงููุจูุนุงุช
```

---

## ๐ ุงููููุงุช ุงููุนุฏูุฉ

```
โ server/src/services/SalesService.ts
   - ุฅุถุงูุฉ ูุญุต isChildSale
   - ุฑุณุงูุฉ ุฎุทุฃ ูุงุถุญุฉ

โ server/src/services/PurchaseService.ts
   - ุฅุถุงูุฉ ูุญุต relatedSale
   - ุฑุณุงูุฉ ุฎุทุฃ ูุงุถุญุฉ
   - ุชุญุณูู ุฅุฑุฌุงุน ุงููุฎุฒูู (affectsInventory)

๐ DELETE_PROTECTION_UPDATE.md (ูุฐุง ุงูููู)
   - ุชูุซูู ุดุงูู ููุญูุงูุฉ
```

---

## โ ุงูุฎูุงุตุฉ

ุชู ุจูุฌุงุญ ุฅุถุงูุฉ **ุญูุงูุฉ ูุงููุฉ** ููููุงุชูุฑ ุงูุชุงุจุนุฉ:

โ **ููุน ุญุฐู ููุงุชูุฑ ุงูุดุฑูุฉ ุงูุฃู** ูุจุงุดุฑุฉู  
โ **ููุน ุญุฐู ููุงุชูุฑ ุงููุดุชุฑูุงุช** ุงูุชุงุจุนุฉ ูุจุงุดุฑุฉู  
โ **ุงูุญุฐู ุงููุชุณูุณู** ูุนูู ููุท ูู ุงููุงุชูุฑุฉ ุงูุฃุตููุฉ  
โ **ุฑุณุงุฆู ุฎุทุฃ ูุงุถุญุฉ** ููููุฏุฉ  
โ **ุณูุงูุฉ ุงูุจูุงูุงุช** ูุถูููุฉ  

**ุงููุธุงู ุงูุขู ุขูู ูููุซูู! ๐๐ก๏ธ**

---

**ุงูุชุงุฑูุฎ:** 2025-11-04  
**ุงูุฅุตุฏุงุฑ:** 2.3.0  
**ุงูููุน:** Security & Data Integrity Update  
**ูุฑุชุจุท ุจู:** `CASCADE_DELETE_FEATURE.md`, `ComplexInterCompanySaleService.ts`

