import nodemailer from 'nodemailer';

class EmailService {
    private transporter;

    constructor() {
        this.transporter = nodemailer.createTransport({
            service: 'gmail', // Ø£Ùˆ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… host/port Ù„Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø®ØµØµØ©
            auth: {
                user: process.env.EMAIL_USER,
                pass: process.env.EMAIL_PASSWORD, // App Password for Gmail
            },
            tls: {
                rejectUnauthorized: false
            }
        });
    }

    async sendPasswordResetEmail(to: string, resetToken: string) {
        const resetLink = `${process.env.CORS_ORIGIN}/reset-password?token=${resetToken}`;

        const mailOptions = {
            from: process.env.EMAIL_USER,
            to,
            subject: 'Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± - Ù†Ø¸Ø§Ù… SIMS',
            html: `
        <div style="font-family: Arial, sans-serif; direction: rtl; text-align: right;">
          <h2>Ø·Ù„Ø¨ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h2>
          <p>Ù„Ù‚Ø¯ ØªÙ„Ù‚ÙŠÙ†Ø§ Ø·Ù„Ø¨Ø§Ù‹ Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø­Ø³Ø§Ø¨Ùƒ ÙÙŠ Ù†Ø¸Ø§Ù… SIMS.</p>
          <p>Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§Ø¨Ø· Ø£Ø¯Ù†Ø§Ù‡:</p>
          <a href="${resetLink}" style="display: inline-block; padding: 10px 20px; background-color: #007bff; color: white; text-decoration: none; border-radius: 5px;">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</a>
          <p>Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· ØµØ§Ù„Ø­ Ù„Ù…Ø¯Ø© Ø³Ø§Ø¹Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·.</p>
          <p>Ø¥Ø°Ø§ Ù„Ù… ØªØ·Ù„Ø¨ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŒ ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¬Ø§Ù‡Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯.</p>
        </div>
      `,
        };

        try {
            await this.transporter.sendMail(mailOptions);
            console.log(`Password reset email sent to ${to}`);
            return true;
        } catch (error) {
            console.error('Error sending email:', error);

            // ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØªØ·ÙˆÙŠØ±ØŒ Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ØŒ Ø§Ø·Ø¨Ø¹ Ø§Ù„Ø±Ø§Ø¨Ø· ÙÙŠ Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„ Ù„Ù†ØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©
            if (process.env.NODE_ENV !== 'production') {
                console.log('=================================================================');
                console.log('ğŸš§ DEV MODE: Email sending failed. Here is the reset link:');
                console.log(resetLink);
                console.log('=================================================================');
                return true; // Ù†Ø¹ØªØ¨Ø±Ù‡ Ù†Ø¬Ø§Ø­Ø§Ù‹ Ù„Ù†ØªÙ…ÙƒÙ† Ù…Ù† ØªÙƒÙ…Ù„Ø© Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
            }

            return false;
        }
    }
}

export const emailService = new EmailService();
