# ๐ง Scripts ุฅุตูุงุญ ูุงุนุฏุฉ ุงูุจูุงูุงุช

## ุงููุดููุฉ

ุนูุฏ ุฅุถุงูุฉ ุนููู ุฌุฏูุฏุ ูุธูุฑ ุงูุฎุทุฃ ุงูุชุงูู:
```
Unique constraint failed on the fields: (`id`)
```

### ุงูุณุจุจ ุงูุฌุฐุฑู

ุงููุดููุฉ ุชุญุฏุซ ุนูุฏูุง ูููู **sequence** ุงูุฎุงุต ุจู auto-increment ูู PostgreSQL ุบูุฑ ูุชุฒุงูู ูุน ุงูุจูุงูุงุช ุงููุนููุฉ ูู ุงูุฌุฏูู. ูุฐุง ูุญุฏุซ ุนุงุฏุฉ ุนูุฏ:

1. **ุงุณุชูุฑุงุฏ ุจูุงูุงุช** ูู ูุตุฏุฑ ุฎุงุฑุฌู ุจู IDs ูุญุฏุฏุฉ
2. **ุญุฐู ุณุฌูุงุช** ุซู ุฅุนุงุฏุฉ ุฅุฏุฎุงููุง
3. **ุชุนุฏูู ูุฏูู** ููู IDs ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
4. **Migration** ุบูุฑ ุตุญูุญ

### ูุซุงู ุนูู ุงููุดููุฉ

```
ุขุฎุฑ ุนููู ูู ุงูุฌุฏูู: ID = 150
ุงูู sequence ุงูุญุงูู: 145

ุนูุฏ ุฅุถุงูุฉ ุนููู ุฌุฏูุฏ:
- PostgreSQL ูุญุงูู ุงุณุชุฎุฏุงู ID = 146
- ููู ID = 146 ููุฌูุฏ ุจุงููุนู ูู ุงูุฌุฏูู!
- ุงููุชูุฌุฉ: Unique constraint error โ
```

---

## ุงูุญููู ุงููุชุงุญุฉ

### โ ุงูุญู ุงูุชููุงุฆู (ูุฏูุฌ ูู ุงูููุฏ)

ุงูููุฏ ุงูุขู ูุญุชูู ุนูู **auto-fix** ูุนูู ุชููุงุฆูุงู ุนูุฏ ุญุฏูุซ ุงููุดููุฉ:

```typescript
// ูู SalesService.ts
if (error.code === 'P2002' && error.meta?.target?.includes('id')) {
  // 1. ุงูุญุตูู ุนูู ุฃุนูู ID ููุฌูุฏ
  const maxId = lastCustomer?.id || 0;
  
  // 2. ุฅุตูุงุญ ุงูู sequence
  await prisma.$executeRawUnsafe(
    `SELECT setval(pg_get_serial_sequence('"Customer"', 'id'), ${maxId}, true);`
  );
  
  // 3. ุฅุนุงุฏุฉ ุงููุญุงููุฉ
  const customer = await prisma.customer.create({ data });
}
```

**ุงููุฒุงูุง:**
- โ ูุนูู ุชููุงุฆูุงู ุจุฏูู ุชุฏุฎู
- โ ูุตูุญ ุงููุดููุฉ ููุฑุงู
- โ ูุง ุญุงุฌุฉ ูุชุดุบูู scripts ูุฏููุงู

---

### ๐๏ธ ุงูุญู ุงููุฏูู (Scripts)

ุฅุฐุง ุฃุฑุฏุช ุฅุตูุงุญ ุงููุดููุฉ **ูุจู** ุญุฏูุซูุงุ ููููู ุชุดุบูู ุฃุญุฏ ุงูู scripts ุงูุชุงููุฉ:

#### 1๏ธโฃ ุฅุตูุงุญ ุฌุฏูู Customer ููุท

```bash
cd server
npm run fix:customer-sequence
```

**ุงููุงุชุฌ:**
```
๐ง ุจุฏุก ุฅุตูุงุญ sequence ุฌุฏูู Customer...
๐ ุฃุนูู ID ููุฌูุฏ: 150
โ ุชู ุฅุตูุงุญ ุงูู sequence ุจูุฌุงุญ!
๐ฏ ุงูู sequence ุงูุขู ุนูุฏ: 150
๐ ุงูุนููู ุงูุชุงูู ุณูุญุตู ุนูู ID: 151
```

#### 2๏ธโฃ ุฅุตูุงุญ ุฌููุน ุงูุฌุฏุงูู

```bash
cd server
npm run fix:all-sequences
```

**ุงููุงุชุฌ:**
```
๐ง ุจุฏุก ุฅุตูุงุญ ุฌููุน ุงูู sequences...

๐ ูุนุงูุฌุฉ ุฌุฏูู: Customer
   ๐ ุฃุนูู ID: 150
   โ ุชู ุฅุตูุงุญ sequence Customer

๐ ูุนุงูุฌุฉ ุฌุฏูู: Company
   ๐ ุฃุนูู ID: 5
   โ ุชู ุฅุตูุงุญ sequence Company

๐ ูุนุงูุฌุฉ ุฌุฏูู: Product
   ๐ ุฃุนูู ID: 320
   โ ุชู ุฅุตูุงุญ sequence Product

...

โจ ุชู ุงูุงูุชูุงุก ูู ุฅุตูุงุญ ุฌููุน ุงูู sequences!
```

---

## ๐ ูุชู ุชุณุชุฎุฏู ุงูู Scriptsุ

### ุงุณุชุฎุฏู ุงูู Scripts ูู ุงูุญุงูุงุช ุงูุชุงููุฉ:

1. **ุจุนุฏ ุงุณุชูุฑุงุฏ ุจูุงูุงุช** ูู ููู SQL ุฃู CSV
2. **ุจุนุฏ migration** ูุจูุฑ ููุจูุงูุงุช
3. **ุนูุฏ ุธููุฑ ุงููุดููุฉ** ูู ุฌุฏุงูู ูุชุนุฏุฏุฉ
4. **ูุฅุฌุฑุงุก ููุงุฆู** ุจุนุฏ ุชุนุฏููุงุช ูุฏููุฉ ุนูู ูุงุนุฏุฉ ุงูุจูุงูุงุช

### ูุง ุชุญุชุงุฌ ุงูู Scripts ูู ุงูุญุงูุงุช ุงูุชุงููุฉ:

- โ ุงูุงุณุชุฎุฏุงู ุงูุนุงุฏู ูููุธุงู (ุงูู auto-fix ูุนูู ุชููุงุฆูุงู)
- โ ุฅุถุงูุฉ ุนููุงุก ุฌุฏุฏ ูู ุงููุงุฌูุฉ (ุงูููุฏ ูุตูุญ ุงููุดููุฉ ุชููุงุฆูุงู)

---

## ๐ ููู ุชุชุญูู ูู ุงููุดููุฉุ

### ุชุดุบูู SQL Query ูุฏููุงู:

```sql
-- 1. ุงูุญุตูู ุนูู ุฃุนูู ID ูู ุงูุฌุฏูู
SELECT MAX(id) FROM "Customer";
-- ูุซุงู: 150

-- 2. ุงูุญุตูู ุนูู ูููุฉ ุงูู sequence ุงูุญุงููุฉ
SELECT last_value FROM "Customer_id_seq";
-- ูุซุงู: 145

-- 3. ุฅุฐุง ูุงู last_value < MAX(id)ุ ููุงู ูุดููุฉ! โ
```

### ุฅุตูุงุญ ูุฏูู ูู SQL:

```sql
-- ุฅุตูุงุญ ุงูู sequence
SELECT setval(pg_get_serial_sequence('"Customer"', 'id'), 
  (SELECT MAX(id) FROM "Customer"), 
  true
);
```

---

## ๐ ููุงุญุธุงุช ุชูููุฉ

### ููู ูุนูู `setval`ุ

```sql
SELECT setval(sequence_name, new_value, is_called);
```

- **sequence_name**: ุงุณู ุงูู sequence
- **new_value**: ุงููููุฉ ุงูุฌุฏูุฏุฉ
- **is_called**: 
  - `true`: ุงููููุฉ ุงูุชุงููุฉ ุณุชููู `new_value + 1`
  - `false`: ุงููููุฉ ุงูุชุงููุฉ ุณุชููู `new_value`

### ูุซุงู:

```sql
-- ุฅุฐุง ูุงู ุขุฎุฑ ID = 150
SELECT setval('"Customer_id_seq"', 150, true);

-- ุงููููุฉ ุงูุชุงููุฉ ุณุชููู: 151 โ
```

---

## ๐ฏ ุงูุฎูุงุตุฉ

1. **ุงูุญู ุงูุชููุงุฆู ููุฌูุฏ** ูู ุงูููุฏ ููุนูู ููุฑุงู ุนูุฏ ุญุฏูุซ ุงููุดููุฉ
2. **ุงูู Scripts ูุชุงุญุฉ** ููุฅุตูุงุญ ุงููุฏูู ุฃู ุงูููุงุฆู
3. **ุงููุดููุฉ ูุงุฏุฑุฉ** ูู ุงูุงุณุชุฎุฏุงู ุงูุนุงุฏู
4. **ูุง ุฏุงุนู ููููู** - ุงููุธุงู ูุตูุญ ููุณู ุชููุงุฆูุงู! โจ

---

## ๐ ุงูุฏุนู

ุฅุฐุง ุงุณุชูุฑุช ุงููุดููุฉ ุจุนุฏ ุชุทุจูู ุงูุญููู:
1. ุชุญูู ูู logs ุงูู server
2. ุดุบูู `npm run fix:all-sequences`
3. ุชุญูู ูู ุตูุงุญูุงุช ูุงุนุฏุฉ ุงูุจูุงูุงุช
